<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6-Stand Electrical Steel Cold Rolling Mill Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2563eb;
            --secondary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #111827;
            --gray: #6b7280;
            --light: #f9fafb;
            --border: #e5e7eb;
            --stand-1: #ef4444;
            --stand-2: #f97316;
            --stand-3: #f59e0b;
            --stand-4: #84cc16;
            --stand-5: #10b981;
            --stand-6: #06b6d4;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1920px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--dark) 0%, #1f2937 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.6rem;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            min-height: calc(100vh - 120px);
        }
        
        .sidebar {
            background: var(--light);
            padding: 10px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }
        
        .content {
            padding: 12px;
            overflow-y: auto;
        }
        
        .control-section {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-group {
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 2px;
        }
        
        .form-control {
            width: 100%;
            padding: 5px 8px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
        
        .tabs {
            display: flex;
            gap: 3px;
            background: var(--light);
            padding: 3px;
            border-radius: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 5px 10px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            color: var(--dark);
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }
        
        .tab:hover { background: rgba(255,255,255,0.5); }
        .tab.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .tab-content { display: none; }
        
        .thread-indicator {
            flex: 1;
            padding: 4px;
            background: #e5e7eb;
            border-radius: 3px;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #6b7280;
            border: 2px solid #d1d5db;
            transition: all 0.3s ease;
        }
        
        .thread-indicator.engaged {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }
        
        .thread-indicator.active {
            background: #10b981;
            color: white;
            border-color: #059669;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        .chart-container {
            position: relative;
            height: 260px;
            margin: 10px 0;
            background: white;
            border-radius: 6px;
            padding: 6px;
            border: 1px solid var(--border);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        /* Mill Visualization */
        .mill-visualization {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--border);
            position: relative;
            overflow-x: auto;
        }
        
        .mill-schematic {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 1600px;
            padding: 30px 0;
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 2px solid #cbd5e1;
        }
        
        /* Continuous strip line across entire mill */
        .mill-schematic::before {
            content: '';
            position: absolute;
            top: calc(50% - 35px); /* Fine-tuned to perfect center between work rolls */
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                #f59e0b 0%, 
                #fbbf24 15%, 
                #f59e0b 30%,
                #fbbf24 45%,
                #f59e0b 60%,
                #fbbf24 75%,
                #f59e0b 90%,
                #fbbf24 100%
            );
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 -1px 2px rgba(255,255,255,0.5);
            transform: translateY(-50%);
            z-index: 5;
            animation: stripFlow 3s linear infinite;
        }
        
        @keyframes stripFlow {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }
        
        .stand {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 200px;
            z-index: 10;
        }
        
        .stand-number {
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--dark) 0%, #374151 100%);
            padding: 4px 12px;
            border-radius: 14px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .stand-icon {
            width: 110px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            background: rgba(255,255,255,0.5);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* 6-High Mill Roll Configuration */
        .backup-roll {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 35% 35%, #e2e8f0, #cbd5e1 40%, #94a3b8 65%, #64748b 85%, #475569);
            border-radius: 50%;
            box-shadow: 
                inset -5px -5px 12px rgba(0,0,0,0.4),
                inset 3px 3px 8px rgba(255,255,255,0.3),
                0 6px 12px rgba(0,0,0,0.25);
            position: relative;
            border: 2px solid #64748b;
        }
        
        .backup-roll::before {
            content: '';
            position: absolute;
            width: 70%;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 2px;
            top: 30%;
            left: 15%;
            transform: rotate(-20deg);
        }
        
        .intermediate-roll {
            width: 68px;
            height: 68px;
            background: radial-gradient(circle at 35% 35%, #cbd5e1, #94a3b8 40%, #64748b 65%, #475569 85%);
            border-radius: 50%;
            box-shadow: 
                inset -4px -4px 10px rgba(0,0,0,0.4),
                inset 2px 2px 6px rgba(255,255,255,0.3),
                0 5px 10px rgba(0,0,0,0.25);
            position: relative;
            border: 2px solid #475569;
        }
        
        .intermediate-roll::before {
            content: '';
            position: absolute;
            width: 65%;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
            border-radius: 2px;
            top: 28%;
            left: 17%;
            transform: rotate(-18deg);
        }
        
        .work-roll {
            width: 56px;
            height: 56px;
            background: radial-gradient(circle at 35% 35%, #94a3b8, #64748b 40%, #475569 65%, #334155 85%);
            border-radius: 50%;
            box-shadow: 
                inset -3px -3px 8px rgba(0,0,0,0.5),
                inset 2px 2px 5px rgba(255,255,255,0.25),
                0 4px 8px rgba(0,0,0,0.3);
            position: relative;
            border: 2px solid #334155;
            z-index: 15;
        }
        
        .work-roll::before {
            content: '';
            position: absolute;
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            border-radius: 2px;
            top: 25%;
            left: 20%;
            transform: rotate(-15deg);
        }
        
        .work-roll::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(255,255,255,0.6), transparent);
            border-radius: 50%;
            top: 20%;
            left: 25%;
        }
        
        /* Strip clearance marker (shows roll bite zone) */
        .strip {
            position: absolute;
            width: 120px;
            height: 8px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            z-index: 6;
            pointer-events: none;
        }
        
        .strip::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(245, 158, 11, 0.3);
            border: 1px dashed rgba(245, 158, 11, 0.6);
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .tension-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            position: relative;
            z-index: 1;
        }
        
        .tension-indicator {
            font-size: 0.75rem;
            font-weight: 700;
            color: #dc2626;
            background: white;
            padding: 4px 10px;
            border-radius: 10px;
            border: 2px solid #dc2626;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20;
        }
        
        .strip-path {
            height: 2px;
            background: transparent;
            width: 100%;
            border-radius: 2px;
            position: relative;
        }
        
        /* Tension zone visual indicator */
        .strip-path::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: repeating-linear-gradient(
                90deg,
                rgba(245, 158, 11, 0.3),
                rgba(245, 158, 11, 0.3) 4px,
                transparent 4px,
                transparent 8px
            );
            transform: translateY(-50%);
        }
        
        .stand-metrics {
            margin-top: 12px;
            font-size: 0.7rem;
            text-align: center;
            background: white;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid var(--border);
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
        }
        
        .metric-label {
            color: var(--gray);
            font-weight: 600;
        }
        
        .metric-value {
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Stand-specific accent colors on work rolls */
        .stand-1 .work-roll { border-left: 5px solid var(--stand-1); }
        .stand-2 .work-roll { border-left: 5px solid var(--stand-2); }
        .stand-3 .work-roll { border-left: 5px solid var(--stand-3); }
        .stand-4 .work-roll { border-left: 5px solid var(--stand-4); }
        .stand-5 .work-roll { border-left: 5px solid var(--stand-5); }
        .stand-6 .work-roll { border-left: 5px solid var(--stand-6); }
        
        .stand-1 .stand-number { background: linear-gradient(135deg, var(--stand-1) 0%, #dc2626 100%); }
        .stand-2 .stand-number { background: linear-gradient(135deg, var(--stand-2) 0%, #ea580c 100%); }
        .stand-3 .stand-number { background: linear-gradient(135deg, var(--stand-3) 0%, #d97706 100%); }
        .stand-4 .stand-number { background: linear-gradient(135deg, var(--stand-4) 0%, #65a30d 100%); }
        .stand-5 .stand-number { background: linear-gradient(135deg, var(--stand-5) 0%, #059669 100%); }
        .stand-6 .stand-number { background: linear-gradient(135deg, var(--stand-6) 0%, #0891b2 100%); }
        
        /* Performance Cards */
        .performance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .performance-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 10px;
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        
        .card-label {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-bottom: 3px;
        }
        
        .card-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .card-unit {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-left: 2px;
        }
        
        /* Stand Cards Grid */
        .stand-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .stand-card {
            background: white;
            border-radius: 5px;
            padding: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .stand-card.stand-1 { border-left-color: var(--stand-1); }
        .stand-card.stand-2 { border-left-color: var(--stand-2); }
        .stand-card.stand-3 { border-left-color: var(--stand-3); }
        .stand-card.stand-4 { border-left-color: var(--stand-4); }
        .stand-card.stand-5 { border-left-color: var(--stand-5); }
        .stand-card.stand-6 { border-left-color: var(--stand-6); }
        
        .stand-card-header {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }
        
        .stand-card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 0.7rem;
        }
        
        .stand-card-metric {
            display: flex;
            justify-content: space-between;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--primary);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.75rem;
        }
        
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.75rem;
        }
        
        .success-box {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--success);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 0.75rem;
        }
        
        .status-indicator {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 3px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        
        .emergency-stop {
            background: var(--danger);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .emergency-stop.active {
            display: block;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Threading Progress */
        .threading-progress {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
            border: 2px solid var(--border);
        }
        
        .progress-bar {
            height: 25px;
            background: var(--light);
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        /* Load Distribution Chart */
        .load-distribution {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            background: white;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border);
            margin: 12px 0;
        }
        
        .load-bar {
            flex: 1;
            margin: 0 4px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.3s ease;
            min-height: 20px;
        }
        
        .load-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .load-bar-value {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <div class="header-icon">‚öô</div>
                6-Stand Electrical Steel Cold Rolling Mill
                <span class="badge">ADVANCED</span>
            </h1>
            <p style="opacity: 0.9; font-size: 1rem;">Multi-Stand Coordinated Control | Inter-Stand Tension | Mass Flow Balance | Load Distribution</p>
        </div>
        
        <div class="main-content">
            <!-- Sidebar Controls -->
            <div class="sidebar">
                <!-- Emergency Stop Display -->
                <div id="emergencyStop" class="emergency-stop">
                    ‚ö† EMERGENCY STOP ACTIVATED ‚ö†
                </div>
                
                <!-- Status Indicator -->
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="systemStatus">System Ready - 6-Stand Control Active</span>
                </div>
                
                <!-- Steel Grade Selection -->
                <div class="control-section">
                    <div class="section-title">üéØ Steel Grade Selection</div>
                    <div class="form-group">
                        <label>Steel Type</label>
                        <select id="steelType" class="form-control" onchange="updateSteelGrade()">
                            <option value="ngo">Non-Grain Oriented (NGO)</option>
                            <option value="go">Grain Oriented (GO)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Grade</label>
                        <select id="steelGrade" class="form-control" onchange="applyGradeSelection()">
                            <!-- Options populated dynamically by updateSteelGrade() -->
                        </select>
                    </div>
                </div>
                
                <!-- Entry/Exit Thickness -->
                <div class="control-section">
                    <div class="section-title">üìè Mill Schedule</div>
                    <div class="form-group">
                        <label>Entry Thickness (mm)</label>
                        <input type="number" id="entryThickness" class="form-control" 
                               value="3.0" step="0.1" min="2.0" max="5.0">
                    </div>
                    <div class="form-group">
                        <label>Exit Thickness (mm)</label>
                        <input type="number" id="exitThickness" class="form-control" 
                               value="0.23" step="0.01" min="0.15" max="0.50">
                    </div>
                    <div class="form-group">
                        <label>Total Reduction (%)</label>
                        <input type="text" id="totalReduction" class="form-control" readonly value="92.3%">
                    </div>
                </div>
                
                <!-- Load Distribution -->
                <div class="control-section">
                    <div class="section-title">‚öñ Load Distribution</div>
                    <div class="form-group">
                        <label>Distribution Mode</label>
                        <select id="loadMode" class="form-control" onchange="updateLoadDistribution()">
                            <option value="progressive">Progressive (33-25-17-13-8-4)</option>
                            <option value="uniform">Uniform (Equal)</option>
                            <option value="parabolic">Parabolic (14-19-21-21-18-8)</option>
                            <option value="exponential">Exponential (40-27-18-10-5-2)</option>
                            <option value="logarithmic">Logarithmic (8-12-14-17-21-29)</option>
                            <option value="powerlaw">Power Law (35-26-20-11-6-4)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="info-box" style="margin-top: 8px; font-size: 0.75rem;">
                        <strong>Distribution Guide:</strong><br>
                        ‚Ä¢ <strong>Progressive:</strong> Front-loaded, aggressive early reduction<br>
                        ‚Ä¢ <strong>Parabolic:</strong> Peak in middle stands, gentle at ends<br>
                        ‚Ä¢ <strong>Exponential:</strong> Maximum front-loading, rapid decay<br>
                        ‚Ä¢ <strong>Logarithmic:</strong> Back-loaded, gradual increase<br>
                        ‚Ä¢ <strong>Power Law:</strong> Balanced front-loading<br>
                        ‚Ä¢ <strong>Uniform:</strong> Equal reduction per stand
                    </div>
                </div>
                
                <!-- Control Parameters -->
                <div class="control-section">
                    <div class="section-title">‚öô Control Parameters</div>
                    <div class="form-group">
                        <label>Master Speed (m/min)</label>
                        <input type="number" id="masterSpeed" class="form-control" 
                               value="800" step="50" min="300" max="1200">
                    </div>
                    <div class="form-group">
                        <label>Inter-Stand Tension (kN)</label>
                        <input type="number" id="interStandTension" class="form-control" 
                               value="50" step="5" min="20" max="100">
                    </div>
                    <div class="form-group">
                        <label>Entry Tension - Uncoiler (kN)</label>
                        <input type="number" id="entryTension" class="form-control" 
                               value="30" step="5" min="10" max="60"
                               title="Back tension from uncoiler/payoff reel for Stand 1">
                    </div>
                    <div class="form-group">
                        <label>Exit Tension - Coiler (kN)</label>
                        <input type="number" id="exitTension" class="form-control" 
                               value="40" step="5" min="20" max="80"
                               title="Forward tension to coiler/tension reel for Stand 6">
                    </div>
                    <div class="form-group">
                        <label>IMC Filter Œª</label>
                        <input type="number" id="imcLambda" class="form-control" 
                               value="0.5" step="0.1" min="0.1" max="2.0">
                    </div>
                </div>
                
                <!-- Disturbances -->
                <div class="control-section">
                    <div class="section-title">‚ö° Process Disturbances</div>
                    <div class="form-group">
                        <label>Hardness Variation (%)</label>
                        <input type="range" id="hardnessVariation" class="form-control" 
                               min="0" max="15" value="0" step="1">
                        <span id="hardnessValue">0%</span>
                    </div>
                    <div class="form-group">
                        <label>Temperature Variation (¬∞C)</label>
                        <input type="range" id="tempVariation" class="form-control" 
                               min="0" max="40" value="0" step="5">
                        <span id="tempValue">0¬∞C</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="applyDisturbance()">Apply</button>
                        <button class="btn btn-danger" onclick="clearDisturbances()">Clear</button>
                    </div>
                </div>
                
                <!-- Cooling System Control -->
                <div class="control-section">
                    <div class="section-title">‚ùÑÔ∏è Cooling System</div>
                    <div class="form-group">
                        <label>Cooling Mode</label>
                        <select id="coolingMode" class="form-control" onchange="updateCoolingMode()">
                            <option value="auto">Automatic</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Target Exit Temperature (¬∞C)</label>
                        <input type="number" id="targetExitTemp" class="form-control" 
                               value="36" step="1" min="25" max="80">
                    </div>
                    <div class="form-group">
                        <label>Manual Flow Rate (%)</label>
                        <input type="range" id="manualCoolingFlow" class="form-control" 
                               min="0" max="100" value="50" step="5" disabled>
                        <span id="coolingFlowValue">50%</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="enableCooling()">Enable</button>
                        <button class="btn btn-danger" onclick="disableCooling()">Disable</button>
                    </div>
                    <div id="coolingStatus" style="margin-top: 8px; font-size: 0.75rem; color: var(--success);">
                        ‚úì Cooling Active - Auto Mode
                    </div>
                </div>
                
                <!-- Threading Control -->
                <div class="control-section">
                    <div class="section-title">üé¨ Strip Threading</div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startThreading()">‚ñ∂ Start Threading</button>
                        <button class="btn btn-warning" onclick="stopThreading()">‚è∏ Stop</button>
                        <button class="btn btn-danger" onclick="emergencyThreadingStop()" 
                                style="font-weight: bold; border: 2px solid #991b1b;">
                            ‚ö†Ô∏è EMERGENCY
                        </button>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="margin-top: 10px;">
                        <div style="background: #e5e7eb; border-radius: 8px; height: 24px; position: relative; overflow: hidden;">
                            <div id="threadingProgressBar" 
                                 style="background: linear-gradient(90deg, #10b981 0%, #059669 100%);
                                        height: 100%; 
                                        width: 0%; 
                                        transition: width 0.3s ease;
                                        border-radius: 8px;
                                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            </div>
                            <div id="threadingProgressText"
                                 style="position: absolute; 
                                        top: 50%; 
                                        left: 50%; 
                                        transform: translate(-50%, -50%);
                                        font-weight: bold;
                                        font-size: 12px;
                                        color: #1f2937;
                                        text-shadow: 0 1px 2px rgba(255,255,255,0.8);">
                                Ready to Thread
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stand Engagement Indicators -->
                    <div style="margin-top: 8px; display: flex; gap: 3px;">
                        <div id="threadStand1" class="thread-indicator">S1</div>
                        <div id="threadStand2" class="thread-indicator">S2</div>
                        <div id="threadStand3" class="thread-indicator">S3</div>
                        <div id="threadStand4" class="thread-indicator">S4</div>
                        <div id="threadStand5" class="thread-indicator">S5</div>
                        <div id="threadStand6" class="thread-indicator">S6</div>
                    </div>
                    
                    <div id="threadingStatus" style="margin-top: 8px; font-size: 0.75rem; color: var(--gray);">
                        Ready to thread
                    </div>
                </div>
                
                
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- ADVANCED PHYSICS - ALWAYS ENABLED -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                
                <div class="control-section" style="border: 2px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                    <div class="section-title" style="color: #10b981;">
                        ‚úÖ Advanced Physics Modules
                    </div>
                    <div class="success-box" style="font-size: 0.75rem; margin: 0;">
                        <strong>All advanced physics modules are enabled:</strong><br>
                        ‚Ä¢ Enhanced Orowan Roll Bite Model<br>
                        ‚Ä¢ Thermal Enhancement (Radiation + Roll Temps)<br>
                        ‚Ä¢ Adaptive AGC Control<br>
                        ‚Ä¢ Profile Enhancement (Wear + Edge Drop)<br>
                        ‚Ä¢ Flatness Defect Detection
                    </div>
                    <div id="adaptiveGainsDisplay" style="font-size: 0.7rem; margin-top: 8px; padding: 6px; background: white; border-radius: 4px;">
                        <strong style="color: #10b981;">Adaptive Gains:</strong><br>
                        Œª: <span id="currentLambda">0.70</span> | 
                        K_p: <span id="currentKp">0.30</span> | 
                        K_i: <span id="currentKi">0.05</span>
                    </div>
                    <div id="flatnessAlert" style="display: none; margin-top: 8px; padding: 6px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.7rem; border-radius: 4px;">
                        <strong id="flatnessDefectType"></strong><br>
                        <span id="flatnessDefectDetails"></span>
                    </div>
                </div>
                
                <!-- Simulation Controls -->
                <div class="control-section">
                    <div class="section-title">‚ñ∂ Simulation Control</div>
                    <div class="form-group">
                        <label>Speed</label>
                        <input type="range" id="simSpeed" class="form-control" 
                               min="1" max="10" value="5" step="1">
                        <span id="speedValue">5x</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startSimulation()">‚ñ∂ Start</button>
                        <button class="btn btn-warning" onclick="pauseSimulation()">‚è∏ Pause</button>
                        <button class="btn btn-danger" onclick="resetSimulation()">‚èπ Reset</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="exportData()">üìä Export</button>
                        <button class="btn btn-primary" onclick="resetEmergencyStop()">üîÑ E-Stop Clear</button>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="content">
                <!-- Tab Navigation -->
                <div class="tabs">
                    <button class="tab active" onclick="showTab('overview', event)">üìä Overview</button>
                    <button class="tab" onclick="showTab('stands', event)">üè≠ Stand-by-Stand</button>
                    <button class="tab" onclick="showTab('tension', event)">‚ö° Inter-Stand Tension</button>
                    <button class="tab" onclick="showTab('temperature', event)">üå°Ô∏è Temperature Profile</button>
                    <button class="tab" onclick="showTab('massflow', event)">‚öñÔ∏è Mass Flow Balance</button>
                    <button class="tab" onclick="showTab('profile', event)">üìê Profile & Shape</button>
                    <button class="tab" onclick="showTab('equations', event)">üî¨ Equations</button>
                    <button class="tab" onclick="showTab('diagnostics', event)">üîß Diagnostics</button>
                </div>
                
                <!-- Overview Tab -->
                <div id="overviewTab" class="tab-content" style="display: block;">
                    <!-- Mill Visualization -->
                    <div class="mill-visualization">
                        <h3 style="font-size: 0.95rem; margin-bottom: 8px; color: var(--dark); display: flex; align-items: center; gap: 8px;">
                            üè≠ Mill Schematic - 6-High, 6-Stand Tandem Configuration
                        </h3>
                        <div style="background: #eff6ff; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 0.75rem; border-left: 4px solid #2563eb;">
                            <strong>6-High Mill Configuration:</strong> Each stand contains 7 elements vertically arranged:<br>
                            ‚Ä¢ <strong>Backup Rolls (largest):</strong> Support the intermediate rolls and withstand high loads<br>
                            ‚Ä¢ <strong>Intermediate Rolls (medium):</strong> Distribute force and improve rigidity<br>
                            ‚Ä¢ <strong>Work Rolls (smallest):</strong> Direct contact with strip for thickness reduction<br>
                            ‚Ä¢ <strong>Strip (gold line):</strong> Continuous path through all 6 stands with inter-stand tension control
                        </div>
                        <div class="mill-schematic" id="millSchematic">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                    
                    <!-- Mill Schematic Legend -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 10px 0; font-size: 0.65rem;">
                        <div style="background: white; padding: 6px; border-radius: 4px; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 6px;">
                            <div style="width: 18px; height: 18px; background: radial-gradient(circle at 35% 35%, #e2e8f0, #64748b); border-radius: 50%; border: 1px solid #475569;"></div>
                            <div><strong>Backup Roll</strong><br>√ò 1400mm</div>
                        </div>
                        <div style="background: white; padding: 6px; border-radius: 4px; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 6px;">
                            <div style="width: 15px; height: 15px; background: radial-gradient(circle at 35% 35%, #cbd5e1, #475569); border-radius: 50%; border: 1px solid #334155;"></div>
                            <div><strong>Intermediate</strong><br>√ò 900mm</div>
                        </div>
                        <div style="background: white; padding: 6px; border-radius: 4px; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 6px;">
                            <div style="width: 12px; height: 12px; background: radial-gradient(circle at 35% 35%, #94a3b8, #334155); border-radius: 50%; border: 1px solid #1e293b;"></div>
                            <div><strong>Work Roll</strong><br>√ò 600mm</div>
                        </div>
                        <div style="background: white; padding: 6px; border-radius: 4px; border: 2px solid #e5e7eb; display: flex; align-items: center; gap: 6px;">
                            <div style="width: 36px; height: 4px; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 2px;"></div>
                            <div><strong>Strip Path</strong><br>Continuous</div>
                        </div>
                    </div>
                    
                    <!-- Threading Progress -->
                    <div class="threading-progress" id="threadingProgress" style="display: none;">
                        <h3 style="font-size: 0.9rem; margin-bottom: 8px;">Strip Threading Progress</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                    </div>
                    
                    <!-- Performance Cards -->
                    <div class="performance-cards">
                        <div class="performance-card">
                            <div class="card-label">Entry Thickness</div>
                            <div class="card-value" id="entryThicknessDisplay">3.000</div>
                            <span class="card-unit">mm</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Exit Thickness</div>
                            <div class="card-value" id="exitThicknessDisplay">0.230</div>
                            <span class="card-unit">mm</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Total Reduction</div>
                            <div class="card-value" id="totalReductionDisplay">92.3</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Master Speed</div>
                            <div class="card-value" id="masterSpeedDisplay">800</div>
                            <span class="card-unit">m/min</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Total Roll Force</div>
                            <div class="card-value" id="totalForce">4850</div>
                            <span class="card-unit">kN</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Total Power</div>
                            <div class="card-value" id="totalPower">12.4</div>
                            <span class="card-unit">MW</span>
                        </div>
                    </div>
                    
                    <!-- Load Distribution -->
                    <h3 style="font-size: 0.95rem; margin: 12px 0 8px 0; color: var(--dark);">
                        Load Distribution Across Stands
                    </h3>
                    <div class="load-distribution" id="loadDistribution">
                        <!-- Dynamically populated -->
                    </div>
                    
                    <!-- Overall Performance -->
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="thicknessEvolutionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="speedProfileChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong>6-Stand Coordinated Control:</strong> Master-slave speed control maintains mass flow balance. 
                        Progressive load distribution optimizes work roll forces. Inter-stand tension controllers prevent strip breaks.
                        Real-time AGC on each stand with coordinated setpoint tracking.
                    </div>
                    
                    <!-- Detailed Process Parameters -->
                    <h3 style="font-size: 0.9rem; margin: 12px 0 8px 0; color: var(--dark);">
                        üìã Process Parameters
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 10px; border-radius: 6px; border-left: 4px solid var(--primary);">
                            <div style="font-size: 0.65rem; color: var(--gray); margin-bottom: 3px; font-weight: 600;">Material Grade</div>
                            <div style="font-size: 0.8rem; font-weight: 700; color: var(--dark);" id="currentMaterialGrade">M470-50A</div>
                            <div style="font-size: 0.6rem; color: var(--gray); margin-top: 2px;" id="materialDescription">Premium electrical steel</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 10px; border-radius: 6px; border-left: 4px solid var(--warning);">
                            <div style="font-size: 0.65rem; color: var(--gray); margin-bottom: 3px; font-weight: 600;">Strip Width</div>
                            <div style="font-size: 0.8rem; font-weight: 700; color: var(--dark);">1000 mm</div>
                            <div style="font-size: 0.6rem; color: var(--gray); margin-top: 2px;">Standard transformer core</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 10px; border-radius: 6px; border-left: 4px solid var(--success);">
                            <div style="font-size: 0.65rem; color: var(--gray); margin-bottom: 3px; font-weight: 600;">Total Elongation</div>
                            <div style="font-size: 0.8rem; font-weight: 700; color: var(--dark);" id="totalElongation">13.0x</div>
                            <div style="font-size: 0.6rem; color: var(--gray); margin-top: 2px;" id="thicknessRange">3.00 ‚Üí 0.23 mm</div>
                        </div>
                    </div>
                    
                    <!-- Stand-by-Stand Quick Status -->
                    <h3 style="font-size: 0.9rem; margin: 12px 0 8px 0; color: var(--dark);">
                        üè≠ Stand Status Overview
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 12px;">
                        <div style="background: white; padding: 8px; border-radius: 5px; border: 2px solid var(--stand-1); text-align: center;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--stand-1); margin-bottom: 3px;">S1</div>
                            <div style="font-size: 0.7rem; font-weight: 600;" id="quickStatus1">OK</div>
                            <div style="font-size: 0.6rem; color: var(--gray);" id="quickReduction1">45%</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; border: 2px solid var(--stand-2); text-align: center;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--stand-2); margin-bottom: 3px;">S2</div>
                            <div style="font-size: 0.7rem; font-weight: 600;" id="quickStatus2">OK</div>
                            <div style="font-size: 0.6rem; color: var(--gray);" id="quickReduction2">35%</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; border: 2px solid var(--stand-3); text-align: center;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--stand-3); margin-bottom: 3px;">S3</div>
                            <div style="font-size: 0.7rem; font-weight: 600;" id="quickStatus3">OK</div>
                            <div style="font-size: 0.6rem; color: var(--gray);" id="quickReduction3">28%</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; border: 2px solid var(--stand-4); text-align: center;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--stand-4); margin-bottom: 3px;">S4</div>
                            <div style="font-size: 0.7rem; font-weight: 600;" id="quickStatus4">OK</div>
                            <div style="font-size: 0.6rem; color: var(--gray);" id="quickReduction4">22%</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; border: 2px solid var(--stand-5); text-align: center;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--stand-5); margin-bottom: 3px;">S5</div>
                            <div style="font-size: 0.7rem; font-weight: 600;" id="quickStatus5">OK</div>
                            <div style="font-size: 0.6rem; color: var(--gray);" id="quickReduction5">18%</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 5px; border: 2px solid var(--stand-6); text-align: center;">
                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--stand-6); margin-bottom: 3px;">S6</div>
                            <div style="font-size: 0.7rem; font-weight: 600;" id="quickStatus6">OK</div>
                            <div style="font-size: 0.6rem; color: var(--gray);" id="quickReduction6">15%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Stand-by-Stand Tab -->
                <div id="standsTab" class="tab-content">
                    <h3 style="font-size: 0.9rem; margin-bottom: 8px;">Individual Stand Performance</h3>
                    <div class="stand-cards-grid" id="standCardsGrid">
                        <!-- Dynamically populated -->
                    </div>
                    
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="standForceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="standPowerChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="standReductionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="standGapChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Tension Tab -->
                <div id="tensionTab" class="tab-content">
                    <h3 style="font-size: 0.9rem; margin-bottom: 8px;">Inter-Stand Tension Control</h3>
                    
                    <div class="performance-cards">
                        <div class="performance-card">
                            <div class="card-label">Zone 1 Tension</div>
                            <div class="card-value" id="tension1">50</div>
                            <span class="card-unit">kN</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Zone 2 Tension</div>
                            <div class="card-value" id="tension2">50</div>
                            <span class="card-unit">kN</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Zone 3 Tension</div>
                            <div class="card-value" id="tension3">50</div>
                            <span class="card-unit">kN</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Zone 4 Tension</div>
                            <div class="card-value" id="tension4">50</div>
                            <span class="card-unit">kN</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Zone 5 Tension</div>
                            <div class="card-value" id="tension5">50</div>
                            <span class="card-unit">kN</span>
                        </div>
                    </div>
                    
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="tensionTimeChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="tensionErrorChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="success-box">
                        <strong>Tension Control Strategy:</strong> Each inter-stand tension zone is controlled by adjusting 
                        the speed ratio between adjacent stands. Mass flow balance ensures: h‚ÇÅv‚ÇÅ = h‚ÇÇv‚ÇÇ. 
                        Optimal tension prevents strip breaks while minimizing residual stress.
                    </div>
                    
                    <!-- Tension Control Details -->
                    <h3 style="font-size: 0.95rem; margin: 12px 0 8px 0; color: var(--dark);">
                        ‚öôÔ∏è Tension Control Details
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--border);">
                            <div style="font-size: 0.8rem; font-weight: 700; color: var(--primary); margin-bottom: 8px;">üéØ Control Strategy</div>
                            <div style="font-size: 0.75rem; line-height: 1.5; color: var(--dark);">
                                <strong>Method:</strong> Speed differential control<br>
                                <strong>Set-point:</strong> 50 kN (5% strip yield)<br>
                                <strong>Actuator:</strong> Inter-stand speed ratio<br>
                                <strong>Response:</strong> Fast (~1-2 seconds)
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--border);">
                            <div style="font-size: 0.8rem; font-weight: 700; color: var(--danger); margin-bottom: 8px;">‚ö†Ô∏è Operating Limits</div>
                            <div style="font-size: 0.75rem; line-height: 1.5; color: var(--dark);">
                                <strong>Minimum:</strong> 20 kN (strip flutter risk)<br>
                                <strong>Maximum:</strong> 150 kN (yield limit)<br>
                                <strong>Tolerance:</strong> ¬±10 kN acceptable<br>
                                <strong>E-Stop:</strong> >200 kN or <10 kN
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong>üí° Why Tension Matters:</strong> Proper tension prevents strip buckling between stands, 
                        ensures consistent strip contact with work rolls, and enables accurate thickness control. 
                        Too low = flutter and wrinkles. Too high = strip break or yield.
                    </div>
                    
                    <!-- ENHANCED TENSION DETAILS -->
                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 2px solid #f59e0b;">
                        <h3 style="font-size: 1rem; color: #d97706; margin-bottom: 12px;">‚ö° Detailed Tension Analysis</h3>
                        
                        <!-- Back and Forward Tensions -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Back and Forward Tensions at Each Stand (kN)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                <!-- Stand 1 -->
                                <div style="padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-1);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-1); text-align: center; margin-bottom: 6px;">Stand 1</div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #dc2626; font-weight: 600;">T_back:</span>
                                            <span id="backTension1" style="font-weight: 700;">0</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #16a34a; font-weight: 600;">T_fwd:</span>
                                            <span id="forwardTension1" style="font-weight: 700;">50</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stand 2 -->
                                <div style="padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-2);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-2); text-align: center; margin-bottom: 6px;">Stand 2</div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #dc2626; font-weight: 600;">T_back:</span>
                                            <span id="backTension2" style="font-weight: 700;">50</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #16a34a; font-weight: 600;">T_fwd:</span>
                                            <span id="forwardTension2" style="font-weight: 700;">50</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stand 3 -->
                                <div style="padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-3);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-3); text-align: center; margin-bottom: 6px;">Stand 3</div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #dc2626; font-weight: 600;">T_back:</span>
                                            <span id="backTension3" style="font-weight: 700;">50</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #16a34a; font-weight: 600;">T_fwd:</span>
                                            <span id="forwardTension3" style="font-weight: 700;">50</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stand 4 -->
                                <div style="padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-4);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-4); text-align: center; margin-bottom: 6px;">Stand 4</div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #dc2626; font-weight: 600;">T_back:</span>
                                            <span id="backTension4" style="font-weight: 700;">50</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #16a34a; font-weight: 600;">T_fwd:</span>
                                            <span id="forwardTension4" style="font-weight: 700;">50</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stand 5 -->
                                <div style="padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-5);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-5); text-align: center; margin-bottom: 6px;">Stand 5</div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #dc2626; font-weight: 600;">T_back:</span>
                                            <span id="backTension5" style="font-weight: 700;">50</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #16a34a; font-weight: 600;">T_fwd:</span>
                                            <span id="forwardTension5" style="font-weight: 700;">50</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stand 6 -->
                                <div style="padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-6);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-6); text-align: center; margin-bottom: 6px;">Stand 6</div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #dc2626; font-weight: 600;">T_back:</span>
                                            <span id="backTension6" style="font-weight: 700;">50</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                                            <span style="color: #16a34a; font-weight: 600;">T_fwd:</span>
                                            <span id="forwardTension6" style="font-weight: 700;">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #fef2f2; border-radius: 4px; font-size: 0.75rem; color: #991b1b;">
                                <strong>Note:</strong> T_back = Tension entering stand from previous zone. 
                                T_fwd = Tension leaving stand to next zone. Stand 1 has no back tension, Stand 6 has no forward tension.
                            </div>
                        </div>
                        
                        <!-- Tension Zone Details -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Inter-Stand Tension Zones (kN)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                                <div style="padding: 12px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 6px; border: 2px solid #dc2626;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #991b1b; text-align: center; margin-bottom: 6px;">Zone 1<br>(1‚Üí2)</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.4rem; font-weight: 700; color: #dc2626;" id="zoneT1">50</div>
                                        <div style="font-size: 0.7rem; color: #991b1b; margin-top: 2px;">kN</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #7f1d1d; text-align: center; margin-top: 4px;">
                                        Error: <span id="zoneErr1">0.0</span> kN
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: linear-gradient(135deg, #ffedd5, #fed7aa); border-radius: 6px; border: 2px solid #ea580c;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #9a3412; text-align: center; margin-bottom: 6px;">Zone 2<br>(2‚Üí3)</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.4rem; font-weight: 700; color: #ea580c;" id="zoneT2">50</div>
                                        <div style="font-size: 0.7rem; color: #9a3412; margin-top: 2px;">kN</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #7c2d12; text-align: center; margin-top: 4px;">
                                        Error: <span id="zoneErr2">0.0</span> kN
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: linear-gradient(135deg, #fef9c3, #fef08a); border-radius: 6px; border: 2px solid #ca8a04;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #854d0e; text-align: center; margin-bottom: 6px;">Zone 3<br>(3‚Üí4)</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.4rem; font-weight: 700; color: #ca8a04;" id="zoneT3">50</div>
                                        <div style="font-size: 0.7rem; color: #854d0e; margin-top: 2px;">kN</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #713f12; text-align: center; margin-top: 4px;">
                                        Error: <span id="zoneErr3">0.0</span> kN
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: linear-gradient(135deg, #d9f99d, #bef264); border-radius: 6px; border: 2px solid #84cc16;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #3f6212; text-align: center; margin-bottom: 6px;">Zone 4<br>(4‚Üí5)</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.4rem; font-weight: 700; color: #65a30d;" id="zoneT4">50</div>
                                        <div style="font-size: 0.7rem; color: #3f6212; margin-top: 2px;">kN</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #365314; text-align: center; margin-top: 4px;">
                                        Error: <span id="zoneErr4">0.0</span> kN
                                    </div>
                                </div>
                                
                                <div style="padding: 12px; background: linear-gradient(135deg, #a7f3d0, #6ee7b7); border-radius: 6px; border: 2px solid #10b981;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #065f46; text-align: center; margin-bottom: 6px;">Zone 5<br>(5‚Üí6)</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.4rem; font-weight: 700; color: #059669;" id="zoneT5">50</div>
                                        <div style="font-size: 0.7rem; color: #065f46; margin-top: 2px;">kN</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #064e3b; text-align: center; margin-top: 4px;">
                                        Error: <span id="zoneErr5">0.0</span> kN
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tension Stress Analysis -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Tension Stress Analysis
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="padding: 10px; background: #f0fdf4; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #15803d; font-weight: 600;">Average Tension Stress</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #16a34a;" id="avgTensionStress">0</div>
                                    <div style="font-size: 0.7rem; color: #15803d;">MPa</div>
                                </div>
                                <div style="padding: 10px; background: #eff6ff; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #1e40af; font-weight: 600;">% of Yield Strength</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #2563eb;" id="tensionYieldRatio">0</div>
                                    <div style="font-size: 0.7rem; color: #1e40af;">%</div>
                                </div>
                                <div style="padding: 10px; background: #fef3c7; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #92400e; font-weight: 600;">Max Tension (Zone)</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #ca8a04;" id="maxTensionValue">50</div>
                                    <div style="font-size: 0.7rem; color: #92400e;">kN (<span id="maxTensionZone">1</span>)</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #eff6ff; border-radius: 4px; font-size: 0.75rem; color: #1e40af;">
                                <strong>Tension Stress:</strong> œÉ = T / (h √ó w). Typically maintained at 3-15% of yield strength.
                                Higher tensions reduce gauge variability but increase strip break risk.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Temperature Tab -->
                <div id="temperatureTab" class="tab-content">
                    <h3 style="font-size: 0.9rem; margin-bottom: 8px;">Temperature Evolution</h3>
                    
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    
                    <div class="performance-cards">
                        <div class="performance-card">
                            <div class="card-label">Entry Temperature</div>
                            <div class="card-value" id="entryTemp">25</div>
                            <span class="card-unit">¬∞C</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Exit Temperature</div>
                            <div class="card-value" id="exitTemp">165</div>
                            <span class="card-unit">¬∞C</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Temp Rise Rate</div>
                            <div class="card-value" id="tempRiseRate">23.3</div>
                            <span class="card-unit">¬∞C/stand</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Cooling Required</div>
                            <div class="card-value" id="coolingRequired">Yes</div>
                            <span class="card-unit"></span>
                        </div>
                    </div>
                    
                    <div class="warning-box">
                        <strong>Temperature Management:</strong> Temperature rises due to plastic deformation work. 
                        High temperatures affect material properties and dimensional accuracy. 
                        Inter-stand cooling may be required for thin gauges and high-speed operation.
                    </div>
                    
                    <!-- Temperature Details -->
                    <h3 style="font-size: 0.95rem; margin: 12px 0 8px 0; color: var(--dark);">
                        üå°Ô∏è Thermal Effects on Process
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 10px; border-radius: 6px; border-left: 4px solid var(--danger);">
                            <div style="font-size: 0.75rem; font-weight: 700; color: var(--danger); margin-bottom: 6px;">üî• Heat Generation</div>
                            <div style="font-size: 0.7rem; line-height: 1.4; color: var(--dark);">
                                ‚Ä¢ Plastic deformation work<br>
                                ‚Ä¢ Friction at roll contact<br>
                                ‚Ä¢ ~95% work ‚Üí heat<br>
                                ‚Ä¢ Higher in early stands
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 10px; border-radius: 6px; border-left: 4px solid var(--primary);">
                            <div style="font-size: 0.75rem; font-weight: 700; color: var(--primary); margin-bottom: 6px;">‚ùÑÔ∏è Thermal Effects</div>
                            <div style="font-size: 0.7rem; line-height: 1.4; color: var(--dark);">
                                ‚Ä¢ Roll thermal crown<br>
                                ‚Ä¢ Strip elongation<br>
                                ‚Ä¢ Material softening<br>
                                ‚Ä¢ Dimensional changes
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 10px; border-radius: 6px; border-left: 4px solid var(--secondary);">
                            <div style="font-size: 0.75rem; font-weight: 700; color: var(--secondary); margin-bottom: 6px;">üéØ Control Strategy</div>
                            <div style="font-size: 0.7rem; line-height: 1.4; color: var(--dark);">
                                ‚Ä¢ Crown compensation<br>
                                ‚Ä¢ Roll cooling system<br>
                                ‚Ä¢ Speed optimization<br>
                                ‚Ä¢ Pass schedule design
                            </div>
                        </div>
                    </div>
                    
                    <!-- ENHANCED THERMAL DATA -->
                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 2px solid #f59e0b;">
                        <h3 style="font-size: 1rem; color: #d97706; margin-bottom: 12px;">üî• Detailed Thermal Analysis</h3>
                        
                        <!-- Heat Sources per Stand -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Heat Generation by Source (kW)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="background: #fee2e2; padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #991b1b; font-weight: 600;">Deformation Work</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #dc2626;" id="heatDeformation">0</div>
                                    <div style="font-size: 0.7rem; color: #991b1b;">kW</div>
                                </div>
                                <div style="background: #fed7aa; padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #9a3412; font-weight: 600;">Friction Heat</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #ea580c;" id="heatFriction">0</div>
                                    <div style="font-size: 0.7rem; color: #9a3412;">kW</div>
                                </div>
                                <div style="background: #fef9c3; padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #854d0e; font-weight: 600;">Total Generation</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #ca8a04;" id="heatTotal">0</div>
                                    <div style="font-size: 0.7rem; color: #854d0e;">kW</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Roll Temperatures -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Work Roll Temperatures (¬∞C)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-1);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-1);">Stand 1</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="rollTemp1">50</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-2);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-2);">Stand 2</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="rollTemp2">50</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-3);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-3);">Stand 3</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="rollTemp3">50</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-4);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-4);">Stand 4</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="rollTemp4">50</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-5);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-5);">Stand 5</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="rollTemp5">50</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-6);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-6);">Stand 6</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="rollTemp6">50</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Strip Temperatures -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Strip Temperatures After Each Stand (¬∞C)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-1);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-1);">Stand 1</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="stripTemp1">25</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-2);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-2);">Stand 2</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="stripTemp2">25</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-3);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-3);">Stand 3</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="stripTemp3">25</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-4);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-4);">Stand 4</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="stripTemp4">25</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-5);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-5);">Stand 5</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="stripTemp5">25</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-6);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-6);">Stand 6</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="stripTemp6">25</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cooling System Parameters -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Inter-Stand Cooling System
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px;">
                                <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af;">Zone 1</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--dark);" id="coolingFlow1">50</div>
                                    <div style="font-size: 0.65rem; color: #1e40af;">L/min</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af;">Zone 2</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--dark);" id="coolingFlow2">50</div>
                                    <div style="font-size: 0.65rem; color: #1e40af;">L/min</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af;">Zone 3</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--dark);" id="coolingFlow3">50</div>
                                    <div style="font-size: 0.65rem; color: #1e40af;">L/min</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af;">Zone 4</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--dark);" id="coolingFlow4">50</div>
                                    <div style="font-size: 0.65rem; color: #1e40af;">L/min</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #1e40af;">Zone 5</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--dark);" id="coolingFlow5">50</div>
                                    <div style="font-size: 0.65rem; color: #1e40af;">L/min</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="background: #f0f9ff; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #075985; font-weight: 600;">Coolant Temp</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="coolantTemp">20</div>
                                    <div style="font-size: 0.65rem; color: #075985;">¬∞C</div>
                                </div>
                                <div style="background: #f0f9ff; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #075985; font-weight: 600;">Cooling Power</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="coolingPower">0</div>
                                    <div style="font-size: 0.65rem; color: #075985;">kW</div>
                                </div>
                                <div style="background: #f0f9ff; padding: 8px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.7rem; color: #075985; font-weight: 600;">Heat Removed</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="heatRemoved">0</div>
                                    <div style="font-size: 0.65rem; color: #075985;">kW</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Radiation Heat Loss -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Heat Loss Mechanisms
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div style="background: #fef2f2; padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #991b1b; font-weight: 600;">Radiation Loss</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #dc2626;" id="radiationLoss">0</div>
                                    <div style="font-size: 0.7rem; color: #991b1b;">kW</div>
                                </div>
                                <div style="background: #dbeafe; padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #1e40af; font-weight: 600;">Roll Conduction</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #2563eb;" id="rollConduction">0</div>
                                    <div style="font-size: 0.7rem; color: #1e40af;">kW</div>
                                </div>
                                <div style="background: #e0e7ff; padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #5b21b6; font-weight: 600;">Convection Loss</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;" id="convectionLoss">0</div>
                                    <div style="font-size: 0.7rem; color: #5b21b6;">kW</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mass Flow Tab -->
                <div id="massflowTab" class="tab-content">
                    <h3 style="font-size: 0.9rem; margin-bottom: 8px;">Mass Flow Balance</h3>
                    
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="massFlowChart"></canvas>
                    </div>
                    
                    <div class="performance-cards">
                        <div class="performance-card">
                            <div class="card-label">Mass Flow Balance</div>
                            <div class="card-value" id="massFlowBalance">99.8</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Max Flow Deviation</div>
                            <div class="card-value" id="maxFlowDev">0.2</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Speed Ratio Error</div>
                            <div class="card-value" id="speedRatioError">0.15</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Load Schedule Sum</div>
                            <div class="card-value" id="loadScheduleSum">1.000</div>
                            <span class="card-unit"></span>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <strong>Mass Flow Equation:</strong> For each stand pair: h‚ÇÅ √ó v‚ÇÅ √ó w = h‚ÇÇ √ó v‚ÇÇ √ó w (constant volume flow).
                        Speed ratio v‚ÇÇ/v‚ÇÅ = h‚ÇÅ/h‚ÇÇ. Coordinated speed control enforces mass balance within ¬±0.5%.
                        Deviations indicate slippage or dimensional errors.
                    </div>
                    
                    <!-- ENHANCED MASS FLOW DETAILS -->
                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 8px; border: 2px solid #2563eb;">
                        <h3 style="font-size: 1rem; color: #1e40af; margin-bottom: 12px;">‚öñÔ∏è Detailed Mass Flow Analysis</h3>
                        
                        <!-- Stand Speeds -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Stand Speeds (m/min)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-1);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-1);">Stand 1</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--dark);" id="standSpeed1">400</div>
                                    <div style="font-size: 0.65rem; color: var(--gray);">m/min</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-2);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-2);">Stand 2</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--dark);" id="standSpeed2">450</div>
                                    <div style="font-size: 0.65rem; color: var(--gray);">m/min</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-3);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-3);">Stand 3</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--dark);" id="standSpeed3">520</div>
                                    <div style="font-size: 0.65rem; color: var(--gray);">m/min</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-4);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-4);">Stand 4</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--dark);" id="standSpeed4">600</div>
                                    <div style="font-size: 0.65rem; color: var(--gray);">m/min</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-5);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-5);">Stand 5</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--dark);" id="standSpeed5">700</div>
                                    <div style="font-size: 0.65rem; color: var(--gray);">m/min</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: var(--light); border-radius: 6px; border: 2px solid var(--stand-6);">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--stand-6);">Stand 6</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--dark);" id="standSpeed6">800</div>
                                    <div style="font-size: 0.65rem; color: var(--gray);">m/min</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Forward Slip -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Forward Slip (%)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #16a34a;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #15803d;">Stand 1</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="forwardSlip1">2.5</div>
                                    <div style="font-size: 0.65rem; color: #15803d;">%</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #16a34a;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #15803d;">Stand 2</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="forwardSlip2">2.3</div>
                                    <div style="font-size: 0.65rem; color: #15803d;">%</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #16a34a;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #15803d;">Stand 3</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="forwardSlip3">2.0</div>
                                    <div style="font-size: 0.65rem; color: #15803d;">%</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #16a34a;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #15803d;">Stand 4</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="forwardSlip4">1.8</div>
                                    <div style="font-size: 0.65rem; color: #15803d;">%</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #16a34a;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #15803d;">Stand 5</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="forwardSlip5">1.5</div>
                                    <div style="font-size: 0.65rem; color: #15803d;">%</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #f0fdf4; border-radius: 6px; border: 1px solid #16a34a;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #15803d;">Stand 6</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="forwardSlip6">1.2</div>
                                    <div style="font-size: 0.65rem; color: #15803d;">%</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #eff6ff; border-radius: 4px; font-size: 0.75rem; color: #1e40af;">
                                <strong>Forward Slip:</strong> Difference between strip exit speed and roll surface speed. 
                                Caused by elastic recovery and friction. Typically 1-3% in cold rolling.
                            </div>
                        </div>
                        
                        <!-- Speed Ratios -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Inter-Stand Speed Ratios
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #92400e;">1‚Üí2</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="speedRatio1">1.125</div>
                                    <div style="font-size: 0.65rem; color: #92400e;">ratio</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #92400e;">2‚Üí3</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="speedRatio2">1.156</div>
                                    <div style="font-size: 0.65rem; color: #92400e;">ratio</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #92400e;">3‚Üí4</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="speedRatio3">1.154</div>
                                    <div style="font-size: 0.65rem; color: #92400e;">ratio</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #92400e;">4‚Üí5</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="speedRatio4">1.167</div>
                                    <div style="font-size: 0.65rem; color: #92400e;">ratio</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #92400e;">5‚Üí6</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--dark);" id="speedRatio5">1.143</div>
                                    <div style="font-size: 0.65rem; color: #92400e;">ratio</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Volume Flow Rates -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 10px; color: var(--dark);">
                                Volume Flow Rate at Each Stand (mm¬≥/s)
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                <div style="text-align: center; padding: 10px; background: #e0e7ff; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #4c1d95;">Stand 1</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="volumeFlow1">0</div>
                                    <div style="font-size: 0.6rem; color: #4c1d95;">mm¬≥/s</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #e0e7ff; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #4c1d95;">Stand 2</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="volumeFlow2">0</div>
                                    <div style="font-size: 0.6rem; color: #4c1d95;">mm¬≥/s</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #e0e7ff; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #4c1d95;">Stand 3</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="volumeFlow3">0</div>
                                    <div style="font-size: 0.6rem; color: #4c1d95;">mm¬≥/s</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #e0e7ff; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #4c1d95;">Stand 4</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="volumeFlow4">0</div>
                                    <div style="font-size: 0.6rem; color: #4c1d95;">mm¬≥/s</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #e0e7ff; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #4c1d95;">Stand 5</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="volumeFlow5">0</div>
                                    <div style="font-size: 0.6rem; color: #4c1d95;">mm¬≥/s</div>
                                </div>
                                <div style="text-align: center; padding: 10px; background: #e0e7ff; border-radius: 6px;">
                                    <div style="font-size: 0.7rem; font-weight: 600; color: #4c1d95;">Stand 6</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--dark);" id="volumeFlow6">0</div>
                                    <div style="font-size: 0.6rem; color: #4c1d95;">mm¬≥/s</div>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 0.75rem; color: #92400e;">
                                <strong>Mass Balance:</strong> Q = h √ó v √ó w should be constant across all stands (¬±0.5% tolerance).
                                Deviations indicate measurement errors or slippage.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Diagnostics Tab -->
                <div id="diagnosticsTab" class="tab-content">
                    <h3 style="font-size: 0.9rem; margin-bottom: 8px;">üîß System Diagnostics</h3>
                    
                    <div class="chart-grid">
                        <div class="chart-container">
                            <canvas id="controlEffortChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="errorDistributionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="performance-cards">
                        <div class="performance-card">
                            <div class="card-label">Overall System Health</div>
                            <div class="card-value" id="systemHealth">98.5</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Control Performance</div>
                            <div class="card-value" id="controlPerf">96.8</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Coordination Index</div>
                            <div class="card-value" id="coordIndex">97.2</div>
                            <span class="card-unit">%</span>
                        </div>
                        <div class="performance-card">
                            <div class="card-label">Energy Efficiency</div>
                            <div class="card-value" id="energyEff">94.6</div>
                            <span class="card-unit">%</span>
                        </div>
                    </div>
                    
                    <div class="success-box">
                        <strong>Multi-Stand Coordination:</strong> 6 independent AGC controllers with coordinated setpoints. 
                        Master-slave speed control. 5 inter-stand tension controllers. Real-time load distribution optimization.
                        Mass flow balance enforcement. Adaptive IMC control on each stand.
                    </div>
                    
                    <!-- Roll Wear Monitoring Section -->
                    <div style="margin-top: 20px;">
                        <h3 style="font-size: 0.9rem; margin-bottom: 8px;">üîß Roll Wear Monitoring</h3>
                        <div class="info-box" style="margin-bottom: 15px;">
                            <strong>Roll Life Model:</strong> Tracks cumulative tonnage and wear progression using Archard's wear equation. 
                            Typical work roll life: ~5,000 tons before regrinding needed. Wear affects crown control and requires compensation.
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                            <div style="text-align: center; padding: 12px; background: var(--light); border-radius: 8px; border: 2px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px; font-weight: 600;">Total Tonnage</div>
                                <div style="font-weight: 700; font-size: 1.4rem; color: var(--primary);" id="totalTonnageDisplay">0</div>
                                <div style="font-size: 0.7rem; color: var(--gray);">tons</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--light); border-radius: 8px; border: 2px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px; font-weight: 600;">Average Wear</div>
                                <div style="font-weight: 700; font-size: 1.4rem; color: var(--warning);" id="avgWearDisplay">0.00</div>
                                <div style="font-size: 0.7rem; color: var(--gray);">mm</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: var(--light); border-radius: 8px; border: 2px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 4px; font-weight: 600;">Maximum Wear</div>
                                <div style="font-weight: 700; font-size: 1.4rem; color: var(--danger);" id="maxWearDisplay">0.00</div>
                                <div style="font-size: 0.7rem; color: var(--gray);">mm</div>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; color: var(--dark);">Stand-by-Stand Wear Status:</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border);">
                                <span style="font-weight: 600; color: var(--stand-1);">Stand 1:</span>
                                <span id="quickWear1" style="font-weight: 700;">0.00mm (0%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border);">
                                <span style="font-weight: 600; color: var(--stand-2);">Stand 2:</span>
                                <span id="quickWear2" style="font-weight: 700;">0.00mm (0%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border);">
                                <span style="font-weight: 600; color: var(--stand-3);">Stand 3:</span>
                                <span id="quickWear3" style="font-weight: 700;">0.00mm (0%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border);">
                                <span style="font-weight: 600; color: var(--stand-4);">Stand 4:</span>
                                <span id="quickWear4" style="font-weight: 700;">0.00mm (0%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border);">
                                <span style="font-weight: 600; color: var(--stand-5);">Stand 5:</span>
                                <span id="quickWear5" style="font-weight: 700;">0.00mm (0%)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--light); border-radius: 6px; font-size: 0.85rem; border: 1px solid var(--border);">
                                <span style="font-weight: 600; color: var(--stand-6);">Stand 6:</span>
                                <span id="quickWear6" style="font-weight: 700;">0.00mm (0%)</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-warning" onclick="changeAllRolls()" style="width: 100%; font-size: 0.9rem; padding: 10px;">
                            üîÑ Change All Work Rolls
                        </button>
                    </div>
                </div>
                
                <!-- Process Equations Tab -->
                <div id="equationsTab" class="tab-content">
                    <h3 style="font-size: 0.9rem; margin-bottom: 8px;">üî¨ Process Equations & Notation</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        <!-- Roll Force -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger);">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--danger);">
                                Roll Force (von K√°rm√°n Equation - Simplified)
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                F = 1.15 √ó œÉ_m √ó w √ó L_d √ó (1 + Œº √ó L_d / h_m)
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ F = Roll force (kN)<br>
                                ‚Ä¢ œÉ_m = Mean flow stress (MPa), temperature-adjusted<br>
                                ‚Ä¢ w = Strip width (mm) = 1000 mm<br>
                                ‚Ä¢ L_d = Contact length = ‚àö(R √ó Œîh) (mm)<br>
                                ‚Ä¢ Œº = Friction coefficient = 0.05<br>
                                ‚Ä¢ h_m = Mean thickness = (h‚ÇÄ + h‚ÇÅ)/2 (mm)<br>
                                ‚Ä¢ Œîh = Reduction = h‚ÇÄ - h‚ÇÅ (mm)
                            </div>
                        </div>
                        
                        <!-- Mill Spring -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--warning);">
                                Mill Spring (Elastic Deformation)
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                Œ¥ = F / C_m<br>
                                h‚ÇÅ_actual = S - Œ¥
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ Œ¥ = Mill stretch/spring (mm)<br>
                                ‚Ä¢ F = Roll force (kN)<br>
                                ‚Ä¢ C_m = Mill modulus = 10,000 kN/mm<br>
                                ‚Ä¢ S = Gap setting (mm)<br>
                                ‚Ä¢ h‚ÇÅ_actual = Actual exit thickness (mm)
                            </div>
                        </div>
                        
                        <!-- Mass Flow -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--primary);">
                                Mass Flow Balance
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                Q = h √ó v √ó w = constant<br>
                                v_{i+1} = v_i √ó (h_i / h_{i+1})
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ Q = Volume flow rate (mm¬≥/min)<br>
                                ‚Ä¢ h = Strip thickness (mm)<br>
                                ‚Ä¢ v = Strip velocity (m/min)<br>
                                ‚Ä¢ w = Strip width (mm)<br>
                                ‚Ä¢ Speed ratio adjusts to maintain constant flow
                            </div>
                        </div>
                        
                        <!-- Motor Power -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success);">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--success);">
                                Motor Power
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                P = T √ó œâ = F √ó r_m √ó œâ<br>
                                r_m = 0.3 √ó L_d (moment arm)
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ P = Motor power (kW)<br>
                                ‚Ä¢ T = Rolling torque (kN¬∑m)<br>
                                ‚Ä¢ œâ = Angular velocity (rad/s) = v/(R/2)<br>
                                ‚Ä¢ r_m = Moment arm (m) ‚âà 0.3 √ó contact length<br>
                                ‚Ä¢ Accounts for neutral point position in rolling
                            </div>
                        </div>
                        
                        <!-- AGC Control -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid var(--secondary);">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--secondary);">
                                AGC (Automatic Gauge Control)
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                S = h‚ÇÅ_target + Œ¥ + u(t)<br>
                                u(t) = K_p√óe + K_i√ó‚à´e dt + K_d√ó(de/dt)
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ S = Gap position command (mm)<br>
                                ‚Ä¢ h‚ÇÅ_target = Target exit thickness (mm)<br>
                                ‚Ä¢ Œ¥ = Mill spring compensation (mm)<br>
                                ‚Ä¢ u(t) = PID control correction (mm)<br>
                                ‚Ä¢ e = Thickness error = h‚ÇÅ_target - h‚ÇÅ_measured (mm)<br>
                                ‚Ä¢ IMC tuning: Œª = 0.5 (filter time constant)
                            </div>
                        </div>
                        
                        <!-- Temperature -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid #f97316;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #f97316;">
                                Temperature Rise
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                ŒîT = 5.0 √ó Œµ √ó ‚àö(v/800)<br>
                                Œµ = Œîh / h‚ÇÄ (true strain)
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ ŒîT = Temperature rise per stand (¬∞C)<br>
                                ‚Ä¢ Œµ = Reduction ratio (strain)<br>
                                ‚Ä¢ v = Strip speed (m/min)<br>
                                ‚Ä¢ Cold rolling: ~4-7¬∞C per stand max<br>
                                ‚Ä¢ Total rise across mill: 20-40¬∞C typical
                            </div>
                        </div>
                        
                        <!-- Roll Wear -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #8b5cf6;">
                                Roll Wear Model (Archard's Equation)
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                W = k √ó (M / 1000) √ó ‚àö(F / 4000)<br>
                                D_current = D_new - W
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ W = Roll wear (mm)<br>
                                ‚Ä¢ k = Wear coefficient = 0.008 mm/1000 tons<br>
                                ‚Ä¢ M = Cumulative tonnage rolled (tons)<br>
                                ‚Ä¢ F = Average roll force (kN)<br>
                                ‚Ä¢ D_current = Current roll diameter (mm)<br>
                                ‚Ä¢ D_new = New roll diameter = 600 mm<br>
                                ‚Ä¢ Typical roll life: 5,000 tons before regrinding
                            </div>
                        </div>
                        
                        <!-- Reduction Distribution -->
                        <div style="background: var(--light); padding: 15px; border-radius: 8px; border-left: 4px solid #06b6d4;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #06b6d4;">
                                Load Distribution
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 4px; margin-bottom: 8px;">
                                Œîh_i = Œîh_total √ó f_i<br>
                                Œ£ f_i = 1.0 (normalized)
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ Œîh_i = Reduction at stand i (mm)<br>
                                ‚Ä¢ Œîh_total = Total reduction (mm)<br>
                                ‚Ä¢ f_i = Distribution factor for stand i<br>
                                ‚Ä¢ Progressive: [0.333, 0.250, 0.167, 0.125, 0.083, 0.042]<br>
                                ‚Ä¢ Exponential: [0.395, 0.265, 0.178, 0.095, 0.045, 0.022]<br>
                                ‚Ä¢ Must sum to 1.0 for mass balance
                            </div>
                        </div>
                    </div>
                    
                    <!-- ADVANCED PHYSICS MODELS -->
                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-radius: 8px; border: 2px solid #7c3aed;">
                        <h3 style="font-size: 1rem; color: #7c3aed; margin-bottom: 12px;">üî¨ ADVANCED PHYSICS MODELS</h3>
                        
                        <!-- Orowan Roll Bite Model -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #7c3aed;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #7c3aed;">
                                Orowan Roll Bite Theory (Enhanced Model)
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: #faf5ff; padding: 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85rem;">
                                œÉ_flow = K √ó Œµ^n √ó (1 - Œ±¬∑ŒîT)<br>
                                R' = R(1 + C¬∑P/W)  (Hitchcock flattening)<br>
                                L_d = ‚àö(R'¬∑Œîh)     (Contact length)<br>
                                Œ± = L_d / R'        (Contact angle)<br>
                                Œº = 0.05 + 0.0002(T - 25)<br>
                                H = (œÉ_BT - œÉ_FT) / œÉ_flow<br>
                                œÜ_n = Œ± √ó (0.5 + 0.125¬∑H)  (Neutral angle)<br>
                                p_max = œÉ_flow √ó (1 + Œº(Œ± - œÜ_n))<br>
                                F = 0.65¬∑p_max¬∑L_d¬∑W - 0.3(T_back - T_front)<br>
                                œÜ_red = 0.8 + 0.5r + 0.3Œº  (Redundant work)<br>
                                w_spec = œÉ_flow √ó Œµ √ó (1 + œÜ_red)<br>
                                s_forward = (1 - r)(1 + ŒºŒ±/(2(1-r))) + H√ó0.1
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ œÉ_flow = Flow stress with work hardening (MPa)<br>
                                ‚Ä¢ K = Strength coefficient (550-800 MPa), n = Strain hardening exponent (0.20-0.28)<br>
                                ‚Ä¢ Œ± = Temperature coefficient (0.0036-0.0045 /¬∞C)<br>
                                ‚Ä¢ R' = Flattened roll radius, C = 2.16√ó10‚Åª‚Å∂ mm¬≤/kN<br>
                                ‚Ä¢ œÉ_BT, œÉ_FT = Back and front tension stresses (MPa)<br>
                                ‚Ä¢ œÜ_n = Neutral angle (radians), H = Tension factor<br>
                                ‚Ä¢ œÜ_red = Redundant work factor, r = Œîh/h‚ÇÄ<br>
                                ‚Ä¢ w_spec = Specific work (J/mm¬≥)<br>
                                ‚Ä¢ s_forward = Forward slip ratio
                            </div>
                        </div>
                        
                        <!-- Thermal Models -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #ef4444;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #ef4444;">
                                Enhanced Thermal Dynamics
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: #fef2f2; padding: 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85rem;">
                                QÃá_def = w_spec √ó v √ó œÅ √ó A √ó Œ∑  (Œ∑ = 0.95)<br>
                                QÃá_roll = h¬∑A¬∑(T_strip - T_roll)<br>
                                h = 5000 + 100v  (W/m¬≤¬∑K)<br>
                                QÃá_rad = Œµ¬∑œÉ_SB¬∑A¬∑(T_strip‚Å¥ - T_amb‚Å¥)<br>
                                QÃá_cool = h_cool¬∑A¬∑(T_strip - T_emulsion)<br>
                                h_cool = 2000¬∑‚àö(flowRate)<br>
                                dT_strip/dt = (QÃá_def - QÃá_roll - QÃá_rad - QÃá_cool)/(m¬∑c_p)<br>
                                dT_roll/dt = (QÃá_roll - QÃá_emulsion)/(m_roll¬∑c_p,roll)<br>
                                QÃá_emulsion = 50000¬∑(T_roll - T_emulsion)<br>
                                Crown_thermal = Œ±_th¬∑R¬∑ŒîT¬∑(1 - (2x/L)¬≤)<br>
                                Œ±_th = 11√ó10‚Åª‚Å∂ /K
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong><br>
                                ‚Ä¢ QÃá = Heat transfer rate (W)<br>
                                ‚Ä¢ Œµ = Emissivity (0.75-0.85), œÉ_SB = 5.67√ó10‚Åª‚Å∏ W/(m¬≤¬∑K‚Å¥)<br>
                                ‚Ä¢ h = Convection coefficient (W/m¬≤¬∑K)<br>
                                ‚Ä¢ m_roll = 2000 kg, c_p,roll = 460 J/(kg¬∑K)<br>
                                ‚Ä¢ Crown_thermal = Thermal crown at center (Œºm)<br>
                                ‚Ä¢ Œ±_th = Thermal expansion coefficient
                            </div>
                        </div>
                        
                        <!-- Adaptive Control -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #10b981;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #10b981;">
                                Adaptive Control Algorithms
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: #f0fdf4; padding: 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85rem;">
                                e_mean = Œ£|e_i| / n<br>
                                e_var = Œ£(|e_i| - e_mean)¬≤ / n<br>
                                e_std = ‚àö(e_var)<br>
                                <br>
                                IF e_mean > 0.01: Œª ‚Üê min(0.9, Œª + 0.01)<br>
                                ELIF e_std < 0.005: Œª ‚Üê max(0.5, Œª - 0.005)<br>
                                <br>
                                IF e_std > 0.01: K_p ‚Üê max(0.2, K_p - 0.01)<br>
                                <br>
                                IF e_mean > 0.005: K_i ‚Üê min(0.1, K_i + 0.002)<br>
                                ELIF e_std > 0.01: K_i ‚Üê max(0.02, K_i - 0.002)<br>
                                <br>
                                u(t) = Œª¬∑e + K_p¬∑e + K_i¬∑‚à´e dt
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Adaptation Logic:</strong> Monitors error statistics over 20 samples. 
                                Increases feed-forward (Œª) for large errors, reduces proportional gain (K_p) for oscillation, 
                                increases integral (K_i) for steady-state error. Bounds: Œª=[0.5,0.9], K_p=[0.2,0.5], K_i=[0.02,0.1]
                            </div>
                        </div>
                        
                        <!-- Profile & Flatness -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: #f59e0b;">
                                Profile & Flatness Models
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: #fffbeb; padding: 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85rem;">
                                Wear = tonnage √ó 0.001 Œºm/ton<br>
                                Crown_total = Crown_elastic + Crown_thermal + Crown_wear + Crown_bending<br>
                                Crown_elastic = P¬∑L¬≥/(48¬∑E¬∑I)  (E = 210 GPa)<br>
                                Crown_wear = Wear √ó 0.7  (at center)<br>
                                Crown_bending = -M¬∑L¬≤/(8¬∑E¬∑I)<br>
                                <br>
                                EdgeDrop = 15¬∑‚àö(W/1000) Œºm<br>
                                <br>
                                Crown(x) = Crown_center¬∑(1 - x¬≤)<br>
                                EdgeDrop(x) = ED_max¬∑((|x| - 0.7)/0.3)¬≤  if |x| > 0.7<br>
                                <br>
                                h_deviation = Crown(x) - EdgeDrop(x)<br>
                                Œµ_zone = h_deviation / h_avg<br>
                                I-unit = (Œµ_center - Œµ_zone) √ó 10‚Åµ<br>
                                <br>
                                DEFECTS:<br>
                                Center Buckle: I_center > 10<br>
                                Edge Wave: I_edges > I_center + 5<br>
                                Quarter Buckle: I_quarters > I_center + 3
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); line-height: 1.5;">
                                <strong>Where:</strong> 21 zones across width (x = -1 to +1). 
                                I-units measure relative strain. Threshold: 10 I-units for defects.
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box" style="margin-top: 15px;">
                        <strong>Notation Summary:</strong><br>
                        h‚ÇÄ = entry thickness, h‚ÇÅ = exit thickness, Œîh = reduction<br>
                        F = roll force, P = motor power, T = temperature<br>
                        v = speed, w = width, œÉ = stress<br>
                        S = gap position, Œ¥ = mill spring, C_m = mill modulus<br>
                        Œµ = strain, Œº = friction, œÅ = density<br>
                        QÃá = heat transfer rate, I = I-unit flatness metric
                    </div>
                </div>

                <!-- Profile & Shape Control Tab -->
                <div id="profileTab" class="tab-content">
                    <!-- Tab Header with Icon -->
                    <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); 
                                color: white; 
                                padding: 20px; 
                                border-radius: 10px; 
                                margin-bottom: 20px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <h2 style="margin: 0; 
                                   font-size: 1.5rem; 
                                   display: flex; 
                                   align-items: center; 
                                   gap: 12px;">
                            <span style="font-size: 1.8rem;">üìê</span>
                            Profile and Shape Control System
                            <span style="background: #10b981; 
                                        padding: 4px 10px; 
                                        border-radius: 12px; 
                                        font-size: 0.75rem;
                                        font-weight: 700;
                                        letter-spacing: 0.5px;">
                                REALISTIC CROWN PHYSICS
                            </span>
                        </h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.95; font-size: 0.95rem;">
                            Work roll bending automatically maintains target crown and flatness for optimal product quality
                        </p>
                        <p style="margin: 4px 0 0 0; opacity: 0.85; font-size: 0.8rem;">
                            ‚öôÔ∏è Roll deflection: 50-80 Œºm | Thermal crown: 15-30 Œºm | Bending force: 50-150 kN (typical)
                        </p>
                    </div>
                    
                    <div class="success-box">
                        <strong>‚úì System Status:</strong> Profile & Shape Control Active
                    </div>
                    
                    <!-- SECTION 1: Control Settings -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid var(--primary); 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: var(--primary); font-size: 1.1rem;">
                                üéõÔ∏è Control Settings
                            </h3>
                        </div>
                        
                        <!-- Control Settings Card -->
                        <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); 
                                    border: 2px solid var(--border); 
                                    border-radius: 10px; 
                                    padding: 15px; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            
                            <!-- 2-Column Layout for Controls -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                
                                <!-- Left Column -->
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray); margin-bottom: 4px;">
                                            Control Mode
                                        </label>
                                        <select id="profileMode" style="width: 100%; padding: 8px; border: 1px solid var(--border); 
                                                                          border-radius: 6px; font-size: 0.85rem; background: white;">
                                            <option value="auto">Automatic Control</option>
                                            <option value="manual">Manual Control</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray); margin-bottom: 4px;">
                                            Target Crown (Œºm)
                                        </label>
                                        <input type="number" id="crownTarget" 
                                               style="width: 100%; padding: 8px; border: 1px solid var(--border); 
                                                      border-radius: 6px; font-size: 0.85rem;"
                                               value="15" step="1" min="-10" max="50">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray); margin-bottom: 4px;">
                                            Target Flatness (I-units)
                                        </label>
                                        <input type="number" id="flatnessTarget" 
                                               style="width: 100%; padding: 8px; border: 1px solid var(--border); 
                                                      border-radius: 6px; font-size: 0.85rem;"
                                               value="5" step="1" min="0" max="20">
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Manual Bending Control (shown only in manual mode) -->
                                    <div id="manualBendingControl" style="display: none;">
                                        <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray); margin-bottom: 4px;">
                                            Manual Bending Force (kN)
                                        </label>
                                        <input type="range" id="manualBendingForce" 
                                               style="width: 100%;"
                                               min="-400" max="400" value="0" step="10">
                                        <div style="text-align: center; font-size: 0.85rem; font-weight: 700; color: var(--primary); margin-top: 4px;">
                                            <span id="manualBendingValue">0</span> kN
                                        </div>
                                    </div>
                                    
                                    <!-- Control Buttons -->
                                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: auto;">
                                        <button onclick="applyProfileSettings()" 
                                                style="padding: 10px; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); 
                                                       color: white; border: none; border-radius: 6px; font-weight: 600; 
                                                       cursor: pointer; font-size: 0.85rem; transition: all 0.2s;">
                                            ‚úì Apply Settings
                                        </button>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                            <button onclick="enableProfileControl()" 
                                                    style="padding: 8px; background: var(--primary); color: white; 
                                                           border: none; border-radius: 6px; font-weight: 600; 
                                                           cursor: pointer; font-size: 0.8rem;">
                                                Enable
                                            </button>
                                            <button onclick="disableProfileControl()" 
                                                    style="padding: 8px; background: var(--danger); color: white; 
                                                           border: none; border-radius: 6px; font-weight: 600; 
                                                           cursor: pointer; font-size: 0.8rem;">
                                                Disable
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Control Info Box -->
                            <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; 
                                        border-left: 4px solid var(--primary); font-size: 0.75rem; color: var(--gray);">
                                <strong style="color: var(--dark);">‚ÑπÔ∏è Control Info:</strong><br>
                                ‚Ä¢ <strong>Auto Mode:</strong> System automatically adjusts bending to maintain targets<br>
                                ‚Ä¢ <strong>Manual Mode:</strong> Direct control of bending force (use with caution)<br>
                                ‚Ä¢ <strong>Crown:</strong> Strip thickness difference between center and edge<br>
                                ‚Ä¢ <strong>Flatness:</strong> Measure of shape quality (lower is better)
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION 2: Current Status -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid var(--success); 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: var(--success); font-size: 1.1rem;">
                                üìä Real-Time Status (Stand 6)
                            </h3>
                        </div>
                        
                        <!-- Current Status Card -->
                        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
                                    border: 2px solid #bae6fd; 
                                    border-radius: 10px; 
                                    padding: 15px; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: var(--gray); font-weight: 600;">Crown</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--success);">
                                        <span id="profileCrownValueCtrl">--</span> <span style="font-size: 0.8rem;">Œºm</span>
                                    </div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: var(--gray); font-weight: 600;">Flatness</div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">
                                        <span id="profileFlatnessValueCtrl">--</span> <span style="font-size: 0.8rem;">I-units</span>
                                    </div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: var(--gray); font-weight: 600;">Quality Grade</div>
                                    <div style="font-size: 1.1rem; font-weight: 700; color: var(--secondary);">
                                        <span id="profileQualityValueCtrl">--</span>
                                    </div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <div style="font-size: 0.75rem; color: var(--gray); font-weight: 600;">Defect Type</div>
                                    <div style="font-size: 0.85rem; font-weight: 700; color: var(--danger);">
                                        <span id="profileDefectValueCtrl">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 6px; font-size: 0.8rem;">
                                <strong>Bending Force:</strong> <span id="profileBendingForceCtrl" style="font-weight: 700; color: var(--primary);">-- kN</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION 3: Performance Overview -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid var(--secondary); 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: var(--secondary); font-size: 1.1rem;">
                                üìà Performance Overview
                            </h3>
                        </div>
                        
                        <!-- Performance Cards -->
                        <div class="performance-cards">
                            <div class="performance-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <div class="card-label">Crown (Stand 6)</div>
                                <div class="card-value"><span id="profileCrownValue">--</span><span class="card-unit">Œºm</span></div>
                            </div>
                            <div class="performance-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                <div class="card-label">Flatness (Stand 6)</div>
                                <div class="card-value"><span id="profileFlatnessValue">--</span><span class="card-unit">I-units</span></div>
                            </div>
                            <div class="performance-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                <div class="card-label">Quality Grade</div>
                                <div class="card-value" style="font-size: 1rem;"><span id="profileQualityValue">--</span></div>
                            </div>
                            <div class="performance-card" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                                <div class="card-label">Shape Defect</div>
                                <div class="card-value" style="font-size: 0.9rem;"><span id="profileDefectValue">--</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION 4: Bending Forces -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid var(--warning); 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: var(--warning); font-size: 1.1rem;">
                                üîß Work Roll Bending Forces (All Stands)
                            </h3>
                        </div>
                        
                        <!-- Bending Forces -->
                        <div class="info-box">
                            <div id="bendingForcesDisplay" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; font-size: 0.85rem;">
                                <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: var(--stand-1); font-size: 0.7rem;">S1</div>
                                    <div id="bending1" style="font-weight: 700;">--</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: var(--stand-2); font-size: 0.7rem;">S2</div>
                                    <div id="bending2" style="font-weight: 700;">--</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: var(--stand-3); font-size: 0.7rem;">S3</div>
                                    <div id="bending3" style="font-weight: 700;">--</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: var(--stand-4); font-size: 0.7rem;">S4</div>
                                    <div id="bending4" style="font-weight: 700;">--</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: var(--stand-5); font-size: 0.7rem;">S5</div>
                                    <div id="bending5" style="font-weight: 700;">--</div>
                                </div>
                                <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: var(--stand-6); font-size: 0.7rem;">S6</div>
                                    <div id="bending6" style="font-weight: 700;">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION 5: Roll Shifting Control -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid #f59e0b; 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: #f59e0b; font-size: 1.1rem;">
                                ‚ÜîÔ∏è Work Roll Shifting Control (All Stands)
                            </h3>
                        </div>
                        
                        <!-- Roll Shifting Overview -->
                        <div class="info-box" style="margin-bottom: 15px; font-size: 0.8rem;">
                            <strong>Work Roll Shifting:</strong> Axial shifting of work rolls distributes wear evenly across roll barrel 
                            and provides fine crown trim. Positive shift typically increases crown (thicker center). 
                            <strong>Effectiveness:</strong> 0.25 Œºm crown per mm shift. <strong>Range:</strong> ¬±100 mm.
                            <br><strong>Control Strategy:</strong> Feedforward anticipates disturbances. Mid-ranging prevents saturation: Bending primary (95%), Shift assists when bending saturates (50/50 split).
                        </div>
                        
                        <!-- Roll Shift Control Mode -->
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
                                    border: 2px solid #fbbf24; 
                                    border-radius: 10px; 
                                    padding: 15px; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                                    margin-bottom: 15px;">
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label style="font-size: 0.9rem; font-weight: 600; color: var(--dark);">
                                    Control Mode:
                                </label>
                                <select id="rollShiftMode" onchange="updateRollShiftMode()" 
                                        style="padding: 8px 12px; border: 1px solid var(--border); 
                                               border-radius: 6px; font-size: 0.85rem; background: white;">
                                    <option value="auto">Automatic (Coordinated)</option>
                                    <option value="manual">Manual Control</option>
                                </select>
                            </div>
                            
                            <!-- Current Positions Display -->
                            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--gray); margin-bottom: 8px;">
                                    Current Shift Positions:
                                </div>
                                <div id="rollShiftPositionsDisplay" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; font-size: 0.85rem;">
                                    <div style="text-align: center; padding: 6px; background: var(--light); border-radius: 4px;">
                                        <div style="font-weight: 600; color: var(--stand-1); font-size: 0.7rem;">S1</div>
                                        <div id="shift1" style="font-weight: 700;">0.0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray);">mm</div>
                                    </div>
                                    <div style="text-align: center; padding: 6px; background: var(--light); border-radius: 4px;">
                                        <div style="font-weight: 600; color: var(--stand-2); font-size: 0.7rem;">S2</div>
                                        <div id="shift2" style="font-weight: 700;">0.0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray);">mm</div>
                                    </div>
                                    <div style="text-align: center; padding: 6px; background: var(--light); border-radius: 4px;">
                                        <div style="font-weight: 600; color: var(--stand-3); font-size: 0.7rem;">S3</div>
                                        <div id="shift3" style="font-weight: 700;">0.0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray);">mm</div>
                                    </div>
                                    <div style="text-align: center; padding: 6px; background: var(--light); border-radius: 4px;">
                                        <div style="font-weight: 600; color: var(--stand-4); font-size: 0.7rem;">S4</div>
                                        <div id="shift4" style="font-weight: 700;">0.0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray);">mm</div>
                                    </div>
                                    <div style="text-align: center; padding: 6px; background: var(--light); border-radius: 4px;">
                                        <div style="font-weight: 600; color: var(--stand-5); font-size: 0.7rem;">S5</div>
                                        <div id="shift5" style="font-weight: 700;">0.0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray);">mm</div>
                                    </div>
                                    <div style="text-align: center; padding: 6px; background: var(--light); border-radius: 4px;">
                                        <div style="font-weight: 600; color: var(--stand-6); font-size: 0.7rem;">S6</div>
                                        <div id="shift6" style="font-weight: 700;">0.0</div>
                                        <div style="font-size: 0.6rem; color: var(--gray);">mm</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Roll Shift Controls (shown only in manual mode) -->
                        <div id="manualRollShiftControls" style="display: none;">
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
                                        border: 2px solid #bae6fd; 
                                        border-radius: 10px; 
                                        padding: 15px; 
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                
                                <div style="font-weight: 600; margin-bottom: 12px; color: var(--dark);">
                                    Manual Shift Position Controls:
                                </div>
                                
                                <!-- Stand 1 -->
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--stand-1);">Stand 1:</label>
                                        <span style="font-size: 0.85rem; font-weight: 700; color: var(--stand-1);">
                                            <span id="manualShift1Value">0</span> mm
                                        </span>
                                    </div>
                                    <input type="range" id="manualShift1" 
                                           min="-100" max="100" value="0" step="5"
                                           oninput="updateManualShift(1, this.value)"
                                           style="width: 100%;">
                                </div>
                                
                                <!-- Stand 2 -->
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--stand-2);">Stand 2:</label>
                                        <span style="font-size: 0.85rem; font-weight: 700; color: var(--stand-2);">
                                            <span id="manualShift2Value">0</span> mm
                                        </span>
                                    </div>
                                    <input type="range" id="manualShift2" 
                                           min="-100" max="100" value="0" step="5"
                                           oninput="updateManualShift(2, this.value)"
                                           style="width: 100%;">
                                </div>
                                
                                <!-- Stand 3 -->
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--stand-3);">Stand 3:</label>
                                        <span style="font-size: 0.85rem; font-weight: 700; color: var(--stand-3);">
                                            <span id="manualShift3Value">0</span> mm
                                        </span>
                                    </div>
                                    <input type="range" id="manualShift3" 
                                           min="-100" max="100" value="0" step="5"
                                           oninput="updateManualShift(3, this.value)"
                                           style="width: 100%;">
                                </div>
                                
                                <!-- Stand 4 -->
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--stand-4);">Stand 4:</label>
                                        <span style="font-size: 0.85rem; font-weight: 700; color: var(--stand-4);">
                                            <span id="manualShift4Value">0</span> mm
                                        </span>
                                    </div>
                                    <input type="range" id="manualShift4" 
                                           min="-100" max="100" value="0" step="5"
                                           oninput="updateManualShift(4, this.value)"
                                           style="width: 100%;">
                                </div>
                                
                                <!-- Stand 5 -->
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--stand-5);">Stand 5:</label>
                                        <span style="font-size: 0.85rem; font-weight: 700; color: var(--stand-5);">
                                            <span id="manualShift5Value">0</span> mm
                                        </span>
                                    </div>
                                    <input type="range" id="manualShift5" 
                                           min="-100" max="100" value="0" step="5"
                                           oninput="updateManualShift(5, this.value)"
                                           style="width: 100%;">
                                </div>
                                
                                <!-- Stand 6 -->
                                <div style="margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <label style="font-size: 0.85rem; font-weight: 600; color: var(--stand-6);">Stand 6:</label>
                                        <span style="font-size: 0.85rem; font-weight: 700; color: var(--stand-6);">
                                            <span id="manualShift6Value">0</span> mm
                                        </span>
                                    </div>
                                    <input type="range" id="manualShift6" 
                                           min="-100" max="100" value="0" step="5"
                                           oninput="updateManualShift(6, this.value)"
                                           style="width: 100%;">
                                </div>
                                
                                <!-- Quick Actions -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px;">
                                    <button onclick="resetAllShifts()" 
                                            style="padding: 10px; background: var(--danger); color: white; 
                                                   border: none; border-radius: 6px; font-weight: 600; 
                                                   cursor: pointer; font-size: 0.85rem;">
                                        Reset All to 0
                                    </button>
                                    <button onclick="applySymmetricShift()" 
                                            style="padding: 10px; background: var(--primary); color: white; 
                                                   border: none; border-radius: 6px; font-weight: 600; 
                                                   cursor: pointer; font-size: 0.85rem;">
                                        Apply Symmetric
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SECTION 6: Profile Charts -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid #8b5cf6; 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: #8b5cf6; font-size: 1.1rem;">
                                üìä Profile Visualization
                            </h3>
                        </div>
                        
                        <!-- Profile Charts -->
                        <div class="chart-container">
                            <canvas id="profileChart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="stressChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- SECTION 7: Control Details -->
                    <div style="margin-top: 20px;">
                        <div style="background: #f3f4f6; 
                                    padding: 8px 15px; 
                                    border-left: 4px solid #06b6d4; 
                                    margin-bottom: 15px;
                                    border-radius: 4px;">
                            <h3 style="margin: 0; color: #06b6d4; font-size: 1.1rem;">
                                üìã Control Details
                            </h3>
                        </div>
                        
                        <!-- Profile Details -->
                        <div class="stand-cards-grid">
                            <div class="stand-card">
                                <div class="stand-card-header">Crown Control</div>
                                <div style="font-size: 0.8rem;">
                                    <div class="metric-row"><span>Target:</span><span id="crownTargetDisp">15 Œºm</span></div>
                                    <div class="metric-row"><span>Actual:</span><span id="crownActualDisp">-- Œºm</span></div>
                                    <div class="metric-row"><span>Error:</span><span id="crownErrorDisp">-- Œºm</span></div>
                                    <div class="metric-row"><span>Effectiveness:</span><span id="crownEffDisp">--%</span></div>
                                </div>
                            </div>
                            <div class="stand-card">
                                <div class="stand-card-header">Flatness Control</div>
                                <div style="font-size: 0.8rem;">
                                    <div class="metric-row"><span>Target:</span><span id="flatnessTargetDisp">5 I-units</span></div>
                                    <div class="metric-row"><span>Actual:</span><span id="flatnessActualDisp">-- I-units</span></div>
                                    <div class="metric-row"><span>Quality:</span><span id="flatnessQualityDisp">--</span></div>
                                    <div class="metric-row"><span>Defect Severity:</span><span id="flatnessSevDisp">--</span></div>
                                </div>
                            </div>
                            <div class="stand-card">
                                <div class="stand-card-header">Roll Shift Status</div>
                                <div style="font-size: 0.8rem;">
                                    <div class="metric-row"><span>Mode:</span><span id="rollShiftModeDisp">Auto</span></div>
                                    <div class="metric-row"><span>Avg Position:</span><span id="rollShiftAvgDisp">-- mm</span></div>
                                    <div class="metric-row"><span>Max Position:</span><span id="rollShiftMaxDisp">-- mm</span></div>
                                    <div class="metric-row"><span>Range:</span><span id="rollShiftRangeDisp">¬±100 mm</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="warning-box" style="margin-top: 20px;">
                        <strong>Note:</strong> Profile and shape control data updates in real-time during simulation. 
                        Use the Control Settings panel above to adjust crown/flatness targets, roll shift positions, and switch between automatic and manual control modes.
                        Roll shifting provides additional crown control (0.5 Œºm per mm shift) and distributes wear evenly across the roll barrel.
                    </div>
                </div>

        </div>
    </div>
    
    <script>
        // ============================================================================
        // CONSTANTS AND CONFIGURATION
        // ============================================================================
        
        const MILL_CONFIG = {
            NUM_STANDS: 6,
            NUM_TENSION_ZONES: 5,
            
            // Physical constants
            WORK_ROLL_DIAMETER: 600,        // mm
            BACKUP_ROLL_DIAMETER: 1200,     // mm
            STRIP_WIDTH: 1000,              // mm
            
            // Control limits
            MAX_ROLL_FORCE: 15000,          // kN
            MAX_MOTOR_POWER: 4000,          // kW per stand
            MAX_SPEED: 1200,                // m/min
            MIN_SPEED: 300,                 // m/min
            
            // Tension limits
            MIN_TENSION: 20,                // kN
            MAX_TENSION: 100,               // kN
            NOMINAL_TENSION: 50,            // kN - Inter-stand tension
            ENTRY_TENSION: 30,              // kN - Uncoiler/payoff reel tension (Stand 1 back tension)
            EXIT_TENSION: 40,               // kN - Coiler/tension reel tension (Stand 6 forward tension)
            
            // Temperature
            AMBIENT_TEMP: 25,               // ¬∞C
            MAX_TEMP: 250,                  // ¬∞C
            TARGET_EXIT_TEMP: 36,           // ¬∞C - Target exit temperature (realistic for cold rolling)
            
            // Cooling system
            COOLANT_TEMP: 20,               // ¬∞C - Coolant temperature
            MAX_COOLING_RATE: 40,           // ¬∞C/s - Maximum cooling rate per zone (increased!)
            COOLING_EFFICIENCY: 0.90,       // Cooling heat transfer efficiency (increased!)
            NUM_COOLING_ZONES: 7,           // Entry + 6 inter-stand zones
            
            // Time constants
            THICKNESS_TAU: 0.2,             // s
            TENSION_TAU: 0.15,              // s
            SPEED_TAU: 0.1,                 // s
            COOLING_TAU: 0.3,               // s - Cooling response time
            
            // Threading
            THREADING_SPEED: 100,           // m/min
            THREADING_TIME: 30,             // seconds total
            THREADING_STAND_DELAY: 5,       // seconds per stand (sequential threading)
            THREADING_GAP_FACTOR: 1.8,      // gaps opened to 180% during threading
            THREADING_TENSION_FACTOR: 0.4,  // tension reduced to 40% during threading
            
            // Update intervals
            CONTROL_DT: 0.02,               // 20ms control cycle
            CHART_UPDATE: 50,               // ms
        };
        
        // Load distribution schedules (MUST sum to 1.0 for mass balance!)
        const LOAD_SCHEDULES = {
            // Progressive: Higher reductions in early stands (material softer, thicker)
            // Approximates 40-30-20-15-10-5 ratio pattern
            progressive: [0.333, 0.250, 0.167, 0.125, 0.083, 0.042],  // Sums to 1.000
            
            // Uniform: Equal reduction at each stand
            uniform: [0.167, 0.167, 0.167, 0.167, 0.166, 0.166],  // Sums to 1.000
            
            // Parabolic: Smooth parabolic distribution (higher in middle)
            // Formula: y = -a(x-3)¬≤ + b, normalized
            // Provides gentler entry and exit, higher reduction in middle stands
            parabolic: [0.140, 0.185, 0.210, 0.210, 0.175, 0.080],  // Sums to 1.000
            
            // Exponential: Front-loaded exponential decay (aggressive early reduction)
            // Formula: y = e^(-Œªx), normalized
            // Maximizes early reduction when material is softest
            exponential: [0.395, 0.265, 0.178, 0.095, 0.045, 0.022],  // Sums to 1.000
            
            // Logarithmic: Gradual reduction increase (back-loaded)
            // Formula: y = ln(x+1), normalized
            // Gentler on early stands, increases toward exit
            logarithmic: [0.082, 0.115, 0.142, 0.166, 0.210, 0.285],  // Sums to 1.000
            
            // Power Law: Power function distribution (moderate front-loading)
            // Formula: y = x^(-Œ±), Œ±=0.5, normalized
            // Balance between progressive and exponential
            powerlaw: [0.350, 0.255, 0.195, 0.110, 0.055, 0.035],  // Sums to 1.000
            
            // Custom: Front-loaded but balanced (original custom)
            custom: [0.30, 0.25, 0.20, 0.15, 0.07, 0.03]  // Sums to 1.000
        };
        
        // Electrical steel grades (comprehensive database)
        const STEEL_GRADES = {
            ngo: {
                // Low-loss NGO grades (high silicon content)
                'M800-50A': { thickness: 0.50, yield: 350, si: 1.0, hardness: 180, description: 'Standard motor grade' },
                'M470-50A': { thickness: 0.50, yield: 380, si: 2.0, hardness: 200, description: 'Low-loss motor' },
                'M400-50A': { thickness: 0.50, yield: 400, si: 2.4, hardness: 220, description: 'Premium low-loss' },
                'M330-50A': { thickness: 0.50, yield: 420, si: 2.8, hardness: 240, description: 'Ultra low-loss' },
                
                // Medium-loss NGO grades
                'M600-50A': { thickness: 0.50, yield: 365, si: 1.6, hardness: 190, description: 'Medium motor grade' },
                'M530-50A': { thickness: 0.50, yield: 375, si: 1.8, hardness: 195, description: 'Improved motor' },
                
                // Thin gauge NGO (0.35mm)
                'M470-35A': { thickness: 0.35, yield: 390, si: 2.2, hardness: 210, description: 'Thin low-loss' },
                'M400-35A': { thickness: 0.35, yield: 410, si: 2.5, hardness: 225, description: 'Thin premium' },
                'M330-35A': { thickness: 0.35, yield: 430, si: 3.0, hardness: 245, description: 'Thin ultra low-loss' },
                
                // Very thin gauge NGO (0.27mm)
                'M400-27A': { thickness: 0.27, yield: 400, si: 2.6, hardness: 230, description: 'Very thin low-loss' },
                'M330-27A': { thickness: 0.27, yield: 420, si: 3.1, hardness: 250, description: 'Very thin premium' },
                
                // Standard grades (older designation)
                '35W300': { thickness: 0.35, yield: 395, si: 2.3, hardness: 215, description: 'Standard 35W300' },
                '50W470': { thickness: 0.50, yield: 380, si: 2.0, hardness: 200, description: 'Standard 50W470' },
                '65W470': { thickness: 0.65, yield: 360, si: 1.8, hardness: 185, description: 'Thick standard' }
            },
            go: {
                // Conventional Grain Oriented (CGO) - 23mil
                '23G090': { thickness: 0.23, yield: 300, si: 3.0, hardness: 160, description: 'Standard CGO' },
                '23G095': { thickness: 0.23, yield: 310, si: 3.1, hardness: 165, description: 'Improved CGO' },
                '23G100': { thickness: 0.23, yield: 320, si: 3.2, hardness: 170, description: 'Premium CGO' },
                
                // CGO - 27mil
                '27G090': { thickness: 0.27, yield: 295, si: 2.9, hardness: 155, description: 'Standard 27mil CGO' },
                '27G095': { thickness: 0.27, yield: 310, si: 3.0, hardness: 170, description: 'Improved 27mil' },
                '27G100': { thickness: 0.27, yield: 315, si: 3.1, hardness: 175, description: 'Premium 27mil' },
                
                // CGO - 30mil
                '30G095': { thickness: 0.30, yield: 305, si: 2.85, hardness: 165, description: 'Standard 30mil' },
                '30G100': { thickness: 0.30, yield: 320, si: 2.9, hardness: 180, description: 'Improved 30mil' },
                
                // High Permeability Grain Oriented (HiB)
                '23P090': { thickness: 0.23, yield: 285, si: 3.15, hardness: 150, description: 'HiB low-loss' },
                '23P095': { thickness: 0.23, yield: 295, si: 3.2, hardness: 155, description: 'HiB standard' },
                '27P095': { thickness: 0.27, yield: 290, si: 3.0, hardness: 152, description: 'HiB 27mil' },
                
                // Domain Refined Grain Oriented (RGO)
                '23R080': { thickness: 0.23, yield: 275, si: 3.25, hardness: 145, description: 'RGO ultra low-loss' },
                '23R085': { thickness: 0.23, yield: 285, si: 3.2, hardness: 148, description: 'RGO premium' },
                '27R085': { thickness: 0.27, yield: 280, si: 3.15, hardness: 150, description: 'RGO 27mil' }
            }
        };
        
        // ============================================================================
        // UTILITY CLASSES
        // ============================================================================
        
        class CircularBuffer {
            constructor(maxSize = 500) {
                this.maxSize = maxSize;
                this.buffer = [];
            }
            
            push(value) {
                this.buffer.push(value);
                if (this.buffer.length > this.maxSize) {
                    this.buffer.shift();
                }
            }
            
            getLast() {
                return this.buffer[this.buffer.length - 1];
            }
            
            getArray() {
                return this.buffer;
            }
            
            get length() {
                return this.buffer.length;
            }
            
            clear() {
                this.buffer = [];
            }
        }
        
        // ============================================================================
        // IMC CONTROLLER CLASS
        // ============================================================================
        
        class IMCController {
            constructor(lambda = 0.5) {
                this.lambda = lambda;
                this.kp = 3.0;
                this.ki = 1.0;
                this.kd = 0.2;
                this.integral = 0;
                this.lastError = 0;
                this.lastOutput = 0;
                this.filterState = 0;
                this.outputLimit = 5;
                this.integralLimit = 10;
            }
            
            update(setpoint, measurement, dt) {
                if (dt <= 0) return this.lastOutput;
                
                // Error (measurement - setpoint for rolling mill convention)
                const error = measurement - setpoint;
                
                // Feedforward through IMC filter
                const alpha = dt / (this.lambda + dt);
                this.filterState = alpha * error + (1 - alpha) * this.filterState;
                const feedforward = this.filterState * 2.0;
                
                // Feedback PID
                this.integral += error * dt;
                this.integral = Math.max(-this.integralLimit, Math.min(this.integralLimit, this.integral));
                
                const derivative = (error - this.lastError) / dt;
                const feedback = this.kp * error + this.ki * this.integral + this.kd * derivative;
                
                // Combined output
                let output = feedforward + feedback;
                output = Math.max(-this.outputLimit, Math.min(this.outputLimit, output));
                
                this.lastError = error;
                this.lastOutput = output;
                
                return output;
            }
            
            reset() {
                this.integral = 0;
                this.lastError = 0;
                this.lastOutput = 0;
                this.filterState = 0;
            }
        }
        
        // ============================================================================
        // ROLLING STAND CLASS
        // ============================================================================
        

        // ============================================================================
        // PROFILE & SHAPE CONTROL SYSTEM
        // ============================================================================
        
        const PROFILE_SHAPE_CONFIG = {
            TARGET_CROWN: 0.015,              // mm (15 Œºm)
            MAX_CROWN: 0.050,
            MIN_CROWN: -0.010,
            TARGET_FLATNESS: 5,               // I-units
            MAX_FLATNESS_ERROR: 20,
            MAX_WR_BENDING_FORCE: 400,        // kN
            WR_BENDING_EFFECTIVENESS: 2.2,    // Œºm/kN (very high sensitivity for ultra-fast crown correction)
            CROWN_CONTROL_GAIN: 25.0,         // Moderate gain (feedforward provides fast response)
            FLATNESS_CONTROL_GAIN: 1.8,
            CONTROL_TIME_CONSTANT: 0.5,
            WIDTH_ZONES: 21,                  // Measurement points
            
            // Roll Shifting Control Parameters
            MAX_ROLL_SHIFT: 100,              // mm (maximum axial shift)
            MIN_ROLL_SHIFT: -100,             // mm
            ROLL_SHIFT_EFFECTIVENESS: 0.25,   // Œºm crown per mm shift (reduced from 0.5 to prevent saturation)
            ROLL_SHIFT_SPEED: 35,             // mm/s (faster shift actuator for quick response)
        };
        
        const ShapeDefect = {
            NONE: 'NONE',
            CENTER_BUCKLE: 'CENTER_BUCKLE',
            EDGE_WAVE: 'EDGE_WAVE',
            QUARTER_BUCKLE: 'QUARTER_BUCKLE',
            HERRINGBONE: 'HERRINGBONE'
        };
        
        class WorkRollBending {
            constructor(standNumber) {
                this.standNumber = standNumber;
                this.topBendingForce = 0;
                this.bottomBendingForce = 0;
                this.enabled = true;
                this.targetForce = 0;
                // PI controller gains - BALANCED for stability (feedforward handles speed)
                this.controller = { kp: 8.0, ki: 6.0, integral: 0 };  // Lower P + Higher I = smoother response
            }
            
            setBendingForce(force) {
                force = Math.max(-PROFILE_SHAPE_CONFIG.MAX_WR_BENDING_FORCE,
                               Math.min(PROFILE_SHAPE_CONFIG.MAX_WR_BENDING_FORCE, force));
                this.topBendingForce = force;
                this.bottomBendingForce = force;
                return force;
            }
            
            getCrownEffect() {
                if (!this.enabled) return 0;
                const avgBending = (this.topBendingForce + this.bottomBendingForce) / 2;
                return -avgBending * PROFILE_SHAPE_CONFIG.WR_BENDING_EFFECTIVENESS / 1000;
            }
            
            updateControl(crownError, dt) {
                if (!this.enabled) return;
                this.controller.integral += crownError * dt;
                this.controller.integral = Math.max(-300, Math.min(300, this.controller.integral));
                const output = this.controller.kp * crownError + this.controller.ki * this.controller.integral;
                this.targetForce = output * PROFILE_SHAPE_CONFIG.CROWN_CONTROL_GAIN;
                this.setBendingForce(this.targetForce);
            }
            
            reset() {
                this.topBendingForce = 0;
                this.bottomBendingForce = 0;
                this.controller.integral = 0;
            }
        }
        
        class RollShifting {
            constructor(standNumber) {
                this.standNumber = standNumber;
                this.shiftPosition = 0;  // mm (positive = operator side shift)
                this.targetPosition = 0;  // mm
                this.enabled = true;
                this.controller = { kp: 0.4, ki: 0.15, integral: 0 };  // Moderate gains for fast fine-tuning (5% contribution)
            }
            
            setShiftPosition(position) {
                // Limit shift position to valid range
                position = Math.max(PROFILE_SHAPE_CONFIG.MIN_ROLL_SHIFT,
                                  Math.min(PROFILE_SHAPE_CONFIG.MAX_ROLL_SHIFT, position));
                this.targetPosition = position;
                return position;
            }
            
            updatePosition(dt) {
                // Simulate actuator dynamics - shift moves at limited speed
                const error = this.targetPosition - this.shiftPosition;
                const maxMove = PROFILE_SHAPE_CONFIG.ROLL_SHIFT_SPEED * dt;
                
                if (Math.abs(error) <= maxMove) {
                    this.shiftPosition = this.targetPosition;
                } else {
                    this.shiftPosition += Math.sign(error) * maxMove;
                }
                
                return this.shiftPosition;
            }
            
            getCrownEffect() {
                if (!this.enabled) return 0;
                // Roll shift creates crown change
                // Positive shift typically increases crown (thicker center)
                // Effectiveness: Œºm per mm shift
                return this.shiftPosition * PROFILE_SHAPE_CONFIG.ROLL_SHIFT_EFFECTIVENESS / 1000;
            }
            
            updateControl(crownError, dt) {
                if (!this.enabled) return;
                
                // PI controller for roll shift
                this.controller.integral += crownError * dt;
                this.controller.integral = Math.max(-200, Math.min(200, this.controller.integral));
                
                const output = this.controller.kp * crownError + this.controller.ki * this.controller.integral;
                
                // Convert crown error (mm) to shift position (mm)
                // output is in mm of crown correction needed
                // divide by effectiveness to get shift needed
                // CRITICAL: Negative sign needed! When crown is too HIGH (positive error),
                // we need NEGATIVE shift to REDUCE crown. Positive shift INCREASES crown.
                const shiftNeeded = -output * 1000 / PROFILE_SHAPE_CONFIG.ROLL_SHIFT_EFFECTIVENESS;
                
                this.setShiftPosition(shiftNeeded);
            }
            
            reset() {
                this.shiftPosition = 0;
                this.targetPosition = 0;
                this.controller.integral = 0;
            }
        }
        
        class ProfileMeasurement {
            constructor(standNumber) {
                this.standNumber = standNumber;
                this.numZones = PROFILE_SHAPE_CONFIG.WIDTH_ZONES;
                this.thicknessProfile = new Array(this.numZones).fill(0);
                this.stripWidth = MILL_CONFIG.STRIP_WIDTH;
                this.positions = [];
                for (let i = 0; i < this.numZones; i++) {
                    this.positions.push((i / (this.numZones - 1) - 0.5) * this.stripWidth);
                }
            }
            
            computeProfile(centerThickness, rollForce, temperature, rollWear, crownCorrection = 0) {
                const baseThickness = centerThickness;
                
                // Roll deflection creates unwanted crown (positive)
                const deflectionCrown = this.computeRollDeflection(rollForce);
                
                // Thermal expansion creates crown (positive)
                const thermalCrown = this.computeThermalCrown(temperature);
                
                // Roll wear creates crown (positive)
                // Wear is greater at center due to higher contact pressure
                // Typical: 8-15 Œºm crown from wear at mid-campaign
                const wearCrown = rollWear * 0.010;  // Balanced calibration V4 for realistic crown control
                
                // Work roll bending correction (negative to reduce crown)
                // crownCorrection is already in mm from getCrownEffect()
                
                // Total crown = unwanted crowns + bending correction
                const totalCrown = deflectionCrown + thermalCrown + wearCrown + crownCorrection;
                
                // Create parabolic profile across width
                for (let i = 0; i < this.numZones; i++) {
                    const position = this.positions[i];
                    const normalizedPos = Math.abs(position) / (this.stripWidth / 2);
                    // Parabolic distribution: full crown at center, zero at edges
                    const localCrown = totalCrown * (1 - Math.pow(normalizedPos, 2));
                    this.thicknessProfile[i] = baseThickness + localCrown;
                }
                return this.thicknessProfile;
            }
            
            computeRollDeflection(rollForce) {
                // Roll deflection coefficient (mm/kN)
                // Based on Hitchcock's formula and industrial measurements
                // UPDATED: Increased further to match observed crown levels
                // For 600mm work rolls, 1000mm strip width:
                // Typical crown: 60-100 Œºm at 4000-5000 kN
                
                // Base deflection coefficient (balanced V4: 15.0e-6 for optimal control)
                const K = 15.0e-6;  // mm/kN (balanced for realistic behavior with safety margins)
                
                // Roll deflection is non-linear with force
                const baseCrown = rollForce * K;
                
                // Edge effect: Crown distribution is not uniform
                // Center region has higher crown than simple linear model predicts
                // This accounts for Hertzian contact pressure distribution
                const edgeEffect = 1.38;  // 38% additional crown contribution (balanced V4)
                
                const deflectionCrown = baseCrown * edgeEffect;
                
                // Results with balanced V4 coefficients:
                // For 2200 kN (Stand 6): 2200 √ó 15e-6 √ó 1.38 = 0.0456 mm = 45.6 Œºm ‚úì
                // For 4000 kN (Stand 3): 4000 √ó 15e-6 √ó 1.38 = 0.0828 mm = 82.8 Œºm ‚úì
                // For 5000 kN (Stand 1): 5000 √ó 15e-6 √ó 1.38 = 0.1035 mm = 103.5 Œºm ‚úì
                
                return deflectionCrown;
            }
            
            computeThermalCrown(temperature) {
                // Thermal expansion coefficient for steel
                const alpha = 12e-6;  // 1/¬∞C
                const rollDiameter = 600;  // mm
                
                // In cold rolling, temperature gradient across roll width is created by:
                // 1. Non-uniform heat generation (center hotter due to contact pressure)
                // 2. Differential cooling (edges cool better than center)
                // 3. Accumulated thermal effects from continuous operation
                // UPDATED: Increased gradient factors to match observed crown levels
                
                const ambientTemp = 25;  // ¬∞C
                const stripTempRise = temperature - ambientTemp;
                
                // Temperature gradient across roll barrel
                // Base gradient + component from strip heating
                const baseGradient = 10;  // ¬∞C minimum thermal gradient (balanced V4)
                const gradientFactor = 0.32;  // ¬∞C gradient per ¬∞C strip temperature rise (balanced V4)
                
                const tempGradient = baseGradient + stripTempRise * gradientFactor;
                const effectiveGradient = Math.min(26, Math.max(10, tempGradient));  // 10-26¬∞C range (balanced V4)
                
                // Geometric factor accounts for:
                // - Roll barrel thermal expansion distribution
                // - Contact deformation zone geometry
                // - Only ~22% of roll thermal expansion appears as strip crown (balanced V4)
                // - Both work rolls contribute to crown
                const geometricFactor = 0.22;
                
                const thermalCrown = alpha * rollDiameter * effectiveGradient * geometricFactor;
                
                // Balanced V4 typical results:
                // At 40¬∞C strip (15¬∞C rise): gradient = 10 + 15√ó0.32 = 14.8¬∞C
                //   ‚Üí crown = 12e-6 √ó 600 √ó 14.8 √ó 0.22 = 0.0235 mm = 23.5 Œºm ‚úì
                // At 60¬∞C strip (35¬∞C rise): gradient = 10 + 35√ó0.32 = 21.2¬∞C
                //   ‚Üí crown = 12e-6 √ó 600 √ó 21.2 √ó 0.22 = 0.0336 mm = 33.6 Œºm ‚úì
                // At 80¬∞C strip (55¬∞C rise): gradient = 26¬∞C (capped)
                //   ‚Üí crown = 12e-6 √ó 600 √ó 26 √ó 0.22 = 0.0412 mm = 41.2 Œºm ‚úì
                
                return thermalCrown;
            }
            
            getCrown() {
                const centerIdx = Math.floor(this.numZones / 2);
                const edgeIdx = 0;
                return this.thicknessProfile[centerIdx] - this.thicknessProfile[edgeIdx];
            }
        }
        
        class FlatnessMeasurement {
            constructor(standNumber) {
                this.standNumber = standNumber;
                this.numZones = PROFILE_SHAPE_CONFIG.WIDTH_ZONES;
                this.stressProfile = new Array(this.numZones).fill(0);
                this.flatness = 0;
                this.shapeDefect = ShapeDefect.NONE;
                this.defectSeverity = 0;
            }
            
            computeFlatness(thicknessProfile, tension, stripSpeed) {
                // Young's modulus for steel (MPa)
                const E = 200000;
                
                // Calculate average thickness (mm)
                const avgThickness = thicknessProfile.reduce((a, b) => a + b) / thicknessProfile.length;
                
                // Calculate strain profile with realistic accommodation
                const strains = thicknessProfile.map(h => {
                    // Thickness variation creates differential extension
                    // In cold rolling, the strip can accommodate thickness variation through:
                    // 1. Elastic bending (main mechanism)
                    // 2. Small plastic deformation differences
                    // 3. Friction effects at roll interface
                    
                    // Geometric thickness variation
                    const thicknessVariation = (h - avgThickness) / avgThickness;
                    
                    // Accommodation factor: Only ~0.1% of thickness variation 
                    // appears as residual strain/stress (rest is accommodated by bending)
                    // This represents the residual stress after elastic-plastic accommodation
                    const ACCOMMODATION_FACTOR = 0.001;  // 0.1% appears as flatness strain
                    
                    // Effective thickness strain (much smaller than geometric variation)
                    const thicknessStrain = -thicknessVariation * ACCOMMODATION_FACTOR;
                    
                    // Tensile strain from inter-stand tension (unchanged)
                    // This is direct stress: œÉ = F/A, Œµ = œÉ/E
                    const area_mm2 = h * MILL_CONFIG.STRIP_WIDTH;  // mm¬≤
                    const tensionStress_MPa = (tension * 1000) / area_mm2;  // Convert kN to N, then to MPa
                    const tensionStrain = tensionStress_MPa / E;
                    
                    return thicknessStrain + tensionStrain;
                });
                
                // Calculate stress profile (MPa)
                for (let i = 0; i < this.numZones; i++) {
                    this.stressProfile[i] = strains[i] * E;
                }
                
                // Calculate flatness as strain difference √ó 10^5 (I-units)
                const maxStrain = Math.max(...strains);
                const minStrain = Math.min(...strains);
                const strainDiff = maxStrain - minStrain;
                
                // Flatness in I-units (1 I-unit = 10^-5 strain difference)
                this.flatness = Math.abs(strainDiff * 1e5);
                
                // Detect shape defects
                this.detectShapeDefect(strains);
                
                return this.flatness;
            }
            
            detectShapeDefect(strains) {
                const centerIdx = Math.floor(this.numZones / 2);
                const centerStrain = strains[centerIdx];
                const edgeStrain = (strains[0] + strains[this.numZones - 1]) / 2;
                const centerEdgeDiff = centerStrain - edgeStrain;
                
                // Threshold for defect detection (10 I-units = 10^-4 strain)
                const threshold = 10e-5;
                
                if (Math.abs(centerEdgeDiff) < threshold) {
                    this.shapeDefect = ShapeDefect.NONE;
                    this.defectSeverity = 0;
                } else if (centerEdgeDiff > threshold) {
                    this.shapeDefect = ShapeDefect.CENTER_BUCKLE;
                    this.defectSeverity = Math.min(10, centerEdgeDiff / threshold);
                } else {
                    this.shapeDefect = ShapeDefect.EDGE_WAVE;
                    this.defectSeverity = Math.min(10, -centerEdgeDiff / threshold);
                }
            }
            
            getShapeQuality() {
                if (this.flatness < 5) return 'EXCELLENT';
                if (this.flatness < 10) return 'GOOD';
                if (this.flatness < 15) return 'ACCEPTABLE';
                if (this.flatness < 20) return 'POOR';
                return 'UNACCEPTABLE';
            }
        }
        
        class ProfileShapeController {
            constructor(standNumber) {
                this.standNumber = standNumber;
                this.workRollBending = new WorkRollBending(standNumber);
                this.rollShifting = new RollShifting(standNumber);
                this.profileMeasurement = new ProfileMeasurement(standNumber);
                this.flatnessMeasurement = new FlatnessMeasurement(standNumber);
                this.enabled = true;
                this.autoMode = true;
                this.coordinatedControl = true;  // Use both bending and shifting
                this.targetCrown = PROFILE_SHAPE_CONFIG.TARGET_CROWN;
                this.targetFlatness = PROFILE_SHAPE_CONFIG.TARGET_FLATNESS;
                this.crownError = 0;
                this.flatnessError = 0;
                this.controlEffectiveness = 0;
                this.lastDetailedLog = 0;  // For periodic crown breakdown logging
                
                // Feedforward control state
                this.prevRollForce = 0;
                this.prevTemperature = 25;
                this.prevSpeed = 0;
                this.feedforwardBending = 0;
            }
            
            update(stand, dt, tension) {
                if (!this.enabled) return;
                
                // Update roll shift position (actuator dynamics)
                this.rollShifting.updatePosition(dt);
                
                // Use crown correction from previous time step (or 0 if first iteration)
                const crownCorrection = stand.crownCorrection || 0;
                
                // Compute profile including both bending and shifting corrections
                const thicknessProfile = this.profileMeasurement.computeProfile(
                    stand.exitThickness, stand.rollForce, stand.temperature, stand.rollWear || 0, crownCorrection
                );
                
                // Measure actual crown from profile
                const currentCrown = this.profileMeasurement.getCrown();
                this.crownError = currentCrown - this.targetCrown;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // FEEDFORWARD CONTROL: Anticipate crown changes from disturbances
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const rollForceChange = stand.rollForce - this.prevRollForce;
                const tempChange = stand.temperature - this.prevTemperature;
                
                // Roll force feedforward: Each 1000 kN change causes ~70 Œºm crown change
                // Compute how much bending force needed to compensate
                const deflectionCrownChange = this.profileMeasurement.computeRollDeflection(stand.rollForce) 
                    - this.profileMeasurement.computeRollDeflection(this.prevRollForce);
                
                // Thermal feedforward: Temperature changes cause crown changes
                const thermalCrownChange = this.profileMeasurement.computeThermalCrown(stand.temperature)
                    - this.profileMeasurement.computeThermalCrown(this.prevTemperature);
                
                // Total anticipated crown change (positive = crown increases)
                const anticipatedCrownChange = deflectionCrownChange + thermalCrownChange;
                
                // Feedforward bending force to cancel anticipated crown change
                // Need NEGATIVE bending to compensate for POSITIVE crown increase
                const bendingEffectiveness = PROFILE_SHAPE_CONFIG.WR_BENDING_EFFECTIVENESS / 1000; // mm/kN
                this.feedforwardBending = -anticipatedCrownChange / bendingEffectiveness;
                
                // Update previous values for next iteration
                this.prevRollForce = stand.rollForce;
                this.prevTemperature = stand.temperature;
                this.prevSpeed = stand.speed;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                // Periodic detailed logging (every 10 seconds of simulation time)
                if (this.standNumber === 1 || this.standNumber === 6) {
                    const now = Date.now();
                    if (!this.lastDetailedLog || (now - this.lastDetailedLog) > 10000) {
                        const deflectionCrown = this.profileMeasurement.computeRollDeflection(stand.rollForce);
                        const thermalCrown = this.profileMeasurement.computeThermalCrown(stand.temperature);
                        const wearCrown = (stand.rollWear || 0) * 0.010;  // Balanced V4 wear factor
                        const totalNatural = deflectionCrown + thermalCrown + wearCrown;
                        
                        console.log(`‚ïê‚ïê‚ïê Stand ${this.standNumber} Crown Breakdown ‚ïê‚ïê‚ïê`);
                        console.log(`  Roll Force: ${stand.rollForce.toFixed(0)} kN`);
                        console.log(`  Strip Temp: ${stand.temperature.toFixed(1)} ¬∞C`);
                        console.log(`  Crown Sources:`);
                        console.log(`    ‚Ä¢ Roll Deflection: ${(deflectionCrown * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Thermal Expansion: ${(thermalCrown * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Roll Wear: ${(wearCrown * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Natural Total: ${(totalNatural * 1000).toFixed(1)} Œºm`);
                        console.log(`  Actuators:`);
                        console.log(`    ‚Ä¢ Bending Force: ${this.workRollBending.topBendingForce.toFixed(1)} kN`);
                        console.log(`    ‚Ä¢ Feedforward: ${this.feedforwardBending.toFixed(1)} kN`);
                        console.log(`    ‚Ä¢ Bending Correction: ${(this.workRollBending.getCrownEffect() * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Roll Shift Position: ${this.rollShifting.shiftPosition.toFixed(1)} mm`);
                        console.log(`    ‚Ä¢ Shift Correction: ${(this.rollShifting.getCrownEffect() * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Total Correction: ${(crownCorrection * 1000).toFixed(1)} Œºm`);
                        console.log(`  Result:`);
                        console.log(`    ‚Ä¢ Actual Crown: ${(currentCrown * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Target Crown: ${(this.targetCrown * 1000).toFixed(1)} Œºm`);
                        console.log(`    ‚Ä¢ Crown Error: ${(this.crownError * 1000).toFixed(1)} Œºm`);
                        
                        this.lastDetailedLog = now;
                    }
                }
                
                // Compute flatness from profile
                this.flatnessMeasurement.computeFlatness(thicknessProfile, tension, stand.speed);
                this.flatnessError = this.flatnessMeasurement.flatness - this.targetFlatness;
                
                // Update control (calculate new actuator positions for next iteration)
                if (this.autoMode) {
                    if (this.coordinatedControl) {
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // ADVANCED COORDINATED CONTROL: Feedforward + Mid-Ranging
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        
                        // 1. Check bending actuator utilization (mid-ranging logic)
                        const currentBending = Math.abs(this.workRollBending.topBendingForce);
                        const bendingUtilization = currentBending / PROFILE_SHAPE_CONFIG.MAX_WR_BENDING_FORCE;
                        
                        // 2. Check shift actuator utilization
                        const currentShift = Math.abs(this.rollShifting.shiftPosition);
                        const shiftUtilization = currentShift / PROFILE_SHAPE_CONFIG.MAX_ROLL_SHIFT;
                        
                        // 3. MID-RANGING: Dynamically adjust split based on actuator saturation
                        let bendingPortion, shiftingPortion;
                        
                        if (bendingUtilization > 0.85) {
                            // BENDING NEAR SATURATION (>85%): Shift takes over primary role
                            bendingPortion = 0.50;  // Reduce bending authority
                            shiftingPortion = 0.50; // Shift becomes co-primary
                            if (this.standNumber === 1 || this.standNumber === 6) {
                                console.log(`Stand ${this.standNumber}: ‚ö†Ô∏è BENDING SATURATING (${(bendingUtilization*100).toFixed(0)}%) - Shift taking over (50/50 split)`);
                            }
                        } else if (bendingUtilization > 0.70) {
                            // BENDING APPROACHING LIMIT (70-85%): Gradual shift takeover
                            const saturationFactor = (bendingUtilization - 0.70) / 0.15; // 0 to 1
                            bendingPortion = 0.95 - 0.45 * saturationFactor; // 95% ‚Üí 50%
                            shiftingPortion = 0.05 + 0.45 * saturationFactor; // 5% ‚Üí 50%
                            if (this.standNumber === 1 || this.standNumber === 6) {
                                console.log(`Stand ${this.standNumber}: Mid-ranging active: ${(bendingPortion*100).toFixed(0)}% bend / ${(shiftingPortion*100).toFixed(0)}% shift`);
                            }
                        } else {
                            // BENDING COMFORTABLE (<70%): Normal operation
                            bendingPortion = 0.95;  // Bending is primary
                            shiftingPortion = 0.05; // Shift for fine trim
                        }
                        
                        // 4. SHIFT ANTI-SATURATION: Prevent shift from saturating
                        if (shiftUtilization > 0.70) {
                            // Shift approaching limit - reduce its authority
                            const shiftReduction = 1.0 - (shiftUtilization - 0.70) / 0.30; // 1.0 ‚Üí 0.0
                            shiftingPortion *= shiftReduction;
                            bendingPortion = 1.0 - shiftingPortion;
                            if (this.standNumber === 1 || this.standNumber === 6) {
                                console.log(`Stand ${this.standNumber}: Shift protection active (${(shiftUtilization*100).toFixed(0)}% used)`);
                            }
                        }
                        
                        // 5. FEEDBACK CONTROL: PI control of crown error
                        this.workRollBending.updateControl(this.crownError * bendingPortion, dt);
                        this.rollShifting.updateControl(this.crownError * shiftingPortion, dt);
                        
                        // 6. FEEDFORWARD CONTROL: Add anticipatory bending (feedforward only affects bending)
                        const totalBendingForce = this.workRollBending.targetForce + this.feedforwardBending;
                        this.workRollBending.setBendingForce(totalBendingForce);
                        
                    } else {
                        // Use only bending (shifting disabled)
                        this.workRollBending.updateControl(this.crownError, dt);
                        // Add feedforward even in non-coordinated mode
                        const totalBendingForce = this.workRollBending.targetForce + this.feedforwardBending;
                        this.workRollBending.setBendingForce(totalBendingForce);
                    }
                }
                
                // Apply actuator effects (for next iteration)
                this.applyActuatorEffects(stand);
                
                // Calculate control performance
                this.calculateEffectiveness();
            }
            
            applyActuatorEffects(stand) {
                const bendingEffect = this.workRollBending.getCrownEffect();
                const shiftingEffect = this.rollShifting.getCrownEffect();
                stand.crownCorrection = bendingEffect + shiftingEffect;
            }
            
            calculateEffectiveness() {
                const crownPerf = 1 - Math.min(1, Math.abs(this.crownError) / PROFILE_SHAPE_CONFIG.MAX_CROWN);
                const flatnessPerf = 1 - Math.min(1, Math.abs(this.flatnessError) / PROFILE_SHAPE_CONFIG.MAX_FLATNESS_ERROR);
                this.controlEffectiveness = (crownPerf + flatnessPerf) / 2 * 100;
            }
            
            setManualBending(force) {
                this.autoMode = false;
                this.workRollBending.setBendingForce(force);
            }
            
            setManualShift(position) {
                this.autoMode = false;
                this.rollShifting.setShiftPosition(position);
            }
            
            enableAutoControl() {
                this.autoMode = true;
            }
            
            getStatus() {
                return {
                    enabled: this.enabled,
                    autoMode: this.autoMode,
                    coordinatedControl: this.coordinatedControl,
                    crown: this.profileMeasurement.getCrown(),
                    flatness: this.flatnessMeasurement.flatness,
                    shapeDefect: this.flatnessMeasurement.shapeDefect,
                    shapeQuality: this.flatnessMeasurement.getShapeQuality(),
                    crownError: this.crownError,
                    flatnessError: this.flatnessError,
                    bendingForce: this.workRollBending.topBendingForce,
                    shiftPosition: this.rollShifting.shiftPosition,
                    shiftTarget: this.rollShifting.targetPosition,
                    effectiveness: this.controlEffectiveness,
                    thicknessProfile: this.profileMeasurement.thicknessProfile,
                    stressProfile: this.flatnessMeasurement.stressProfile
                };
            }
            
            reset() {
                this.workRollBending.reset();
                this.rollShifting.reset();
                this.crownError = 0;
                this.flatnessError = 0;
                this.controlEffectiveness = 0;
            }
        }
        
                this.shapeDefect = ShapeDefect.NONE;
        class RollingStand {
            constructor(standNumber) {
                this.standNumber = standNumber;
                this.controller = new IMCController(0.5);
                
                // State variables
                this.entryThickness = 0;
                this.exitThickness = 0;
                this.speed = 0;
                this.rollForce = 0;
                this.motorPower = 0;
                this.gapPosition = 0;
                this.temperature = MILL_CONFIG.AMBIENT_TEMP;
                this.reduction = 0;
                
                // Targets
                this.thicknessTarget = 0;
                this.speedTarget = 0;
                this.threadingTarget = 0;  // Modified target during threading (equals thicknessTarget in normal operation)
                
                // Process model parameters
                this.millModulus = 10000;  // kN/mm (spring constant)
                this.frictionCoeff = 0.05;
                
                // Roll wear model
                this.rollDiameter = MILL_CONFIG.WORK_ROLL_DIAMETER;  // Current diameter (mm)
                this.rollDiameterNew = MILL_CONFIG.WORK_ROLL_DIAMETER;  // New roll diameter (mm)
                this.rollWear = 0;  // Total wear (mm)
                this.cumulativeTonnage = 0;  // Total tonnage rolled (tons)
                this.wearRate = 0.008;  // mm wear per 1000 tons (typical for cold rolling)
                this.rollChangeTonnage = 5000;  // Tons before roll change
                
                // Profile & Shape Control - CRITICAL: Initialize for all stands
                this.profileShapeController = new ProfileShapeController(standNumber);
            }
            
            setTargets(thicknessTarget, speedTarget) {
                this.thicknessTarget = thicknessTarget;
                this.speedTarget = speedTarget;
            }
            
            computeRollForce(entryThickness, exitThickness, yieldStrength, temperature) {
                // Validate inputs
                if (!entryThickness || !exitThickness || entryThickness <= exitThickness) {
                    return 0;
                }
                
                // Simplified von Karman equation
                const reduction = entryThickness - exitThickness;
                const reductionRatio = reduction / entryThickness;
                
                // Temperature effect on yield strength
                const tempFactor = Math.max(0.5, 1.0 - (temperature - MILL_CONFIG.AMBIENT_TEMP) / 500);
                const effectiveYield = yieldStrength * tempFactor;
                
                // Roll force calculation
                const contactLength = Math.sqrt(MILL_CONFIG.WORK_ROLL_DIAMETER * reduction);
                const avgThickness = (entryThickness + exitThickness) / 2;
                
                if (contactLength <= 0 || avgThickness <= 0) {
                    return 0;
                }
                
                const rollForce = 1.15 * effectiveYield * MILL_CONFIG.STRIP_WIDTH * contactLength * 
                                 (1 + this.frictionCoeff * contactLength / avgThickness);
                
                const forceInKN = rollForce / 1000; // Convert to kN
                
                // Validate result
                if (isNaN(forceInKN) || forceInKN < 0) {
                    console.warn('Invalid roll force calculated:', forceInKN);
                    return 0;
                }
                
                return Math.min(forceInKN, MILL_CONFIG.MAX_ROLL_FORCE);
            }
            
            computeMotorPower(rollForce, speed, reduction) {
                // Validate inputs
                if (!rollForce || !speed || rollForce <= 0 || speed <= 0 || !reduction) {
                    return 0;
                }
                
                // Calculate contact length (arc of contact between roll and strip)
                const contactLength = Math.sqrt(MILL_CONFIG.WORK_ROLL_DIAMETER * reduction); // mm
                
                // Moment arm for rolling torque (approximately 0.3 * contact length)
                // This represents the effective lever arm where friction forces act
                // Based on neutral point position in rolling (typically 0.3-0.4 of contact arc)
                const momentArm = 0.3 * contactLength / 1000; // Convert to meters
                
                // Rolling torque = Force √ó moment arm
                const torque = rollForce * momentArm; // kN‚ãÖm
                
                // Angular velocity: œâ = v / r
                const radiusInMeters = (MILL_CONFIG.WORK_ROLL_DIAMETER / 1000) / 2; // m
                const speedInMPS = speed / 60; // Convert m/min to m/s
                const angularVel = speedInMPS / radiusInMeters; // rad/s
                
                // Nominal power: P = T √ó œâ
                const nominalPower = torque * angularVel; // kW
                
                // Add realistic motor/drive variations (¬±0.5-1% typical)
                // Sources: motor efficiency, drive losses, cooling variations, electrical fluctuations
                const motorVariation = 1.0 + (Math.random() - 0.5) * 0.015; // ¬±0.75% variation
                const power = nominalPower * motorVariation;
                
                // Validate result
                if (isNaN(power) || power < 0) {
                    console.warn('Invalid motor power calculated:', power);
                    return 0;
                }
                
                // Apply reasonable limit (should rarely hit this now with correct calculation)
                return Math.min(power, MILL_CONFIG.MAX_MOTOR_POWER);
            }
            
            computeTemperatureRise(reduction, speed) {
                // Temperature rise from plastic deformation work
                // For COLD rolling, temperature rise is modest: 15-35¬∞C total across mill
                
                // Simplified model: ŒîT ‚àù specific work √ó efficiency factor
                // Typical cold rolling: 20-30¬∞C rise across full mill
                
                // Energy dissipated as heat per unit volume
                const specificWork = reduction / this.entryThickness;  // Strain
                const speedFactor = speed / 800;  // Normalized speed effect
                
                // For cold rolling: ~4-7¬∞C per stand maximum
                const tempRise = 5.0 * specificWork * Math.sqrt(speedFactor);
                
                return Math.min(tempRise, 7);  // Cap at 7¬∞C per stand for cold rolling
            }
            
            update(entryThickness, dt, disturbances, yieldStrength, entryTemperature = null) {
                this.entryThickness = entryThickness;
                
                // Set entry temperature (from previous stand or ambient)
                if (entryTemperature !== null) {
                    this.temperature = entryTemperature;
                }
                
                // Add MINIMAL measurement noise (¬±1 Œºm realistic for excellent gauge)
                const measurementNoise = (Math.random() - 0.5) * 0.002; // ¬±1 Œºm
                const measuredThickness = this.exitThickness + measurementNoise;
                
                // Determine control target (threading target if set, otherwise normal target)
                // During threading: threadingTarget uses REDUCED reduction (50% ‚Üí 100%)
                // Normal operation: threadingTarget equals thicknessTarget
                const controlTarget = this.threadingTarget || this.thicknessTarget;
                
                // AGC control action (ALWAYS active, tracking current target)
                const controlAction = this.controller.update(controlTarget, measuredThickness, dt);
                
                // Gap position control
                const rollForceEstimate = this.rollForce || 0;
                const millStretch = rollForceEstimate / this.millModulus;
                
                // AGC controls gap position (ALWAYS, no special threading mode)
                // Gap = target + mill_stretch + control_correction
                this.gapPosition = controlTarget + millStretch + controlAction * 0.001;
                
                // Exit thickness (considering mill spring)
                // h_exit = S - (F / C_m)
                const nominalExit = this.gapPosition - millStretch;
                
                // Add SMALL disturbances
                const hardnessEffect = disturbances.hardness * 0.0001; // ¬±1 Œºm for ¬±10% hardness
                const tempEffect = disturbances.temperature * 0.00005; // ¬±1 Œºm for ¬±20¬∞C
                
                // Add MINIMAL process noise (¬±1 Œºm for mechanical variations)
                const processNoise = (Math.random() - 0.5) * 0.002; // ¬±1 Œºm
                
                // Total disturbance (small!)
                const totalDisturbance = hardnessEffect + tempEffect + processNoise;
                
                this.exitThickness = nominalExit + totalDisturbance;
                
                // Ensure thickness stays positive and reasonable
                this.exitThickness = Math.max(0.001, Math.min(this.exitThickness, this.entryThickness));
                
                // Compute roll force and power
                this.reduction = this.entryThickness - this.exitThickness;
                this.rollForce = this.computeRollForce(this.entryThickness, this.exitThickness, 
                                                       yieldStrength, this.temperature);
                this.motorPower = this.computeMotorPower(this.rollForce, this.speed, this.reduction);
                
                // Temperature evolution from rolling
                const tempRise = this.computeTemperatureRise(this.reduction, this.speed);
                
                // Apply temperature rise from rolling
                // Active cooling system will handle cooling between stands
                this.temperature = this.temperature + tempRise;
                this.temperature = Math.min(this.temperature, MILL_CONFIG.MAX_TEMP);  // Safety limit
                
                // Update roll wear model
                this.updateRollWear(dt);
                
                return this.exitThickness;
            }
            
            updateRollWear(dt) {
                // Roll wear model based on Archard's wear equation
                // Wear ‚àù Load √ó Distance / Hardness
                
                // Simplified model: wear per ton of material rolled
                // Typical: 0.005-0.01 mm per 1000 tons for work rolls
                
                // Calculate tonnage rolled in this time step
                const massFlow = this.speed * MILL_CONFIG.STRIP_WIDTH * this.exitThickness * 
                                7850 / 1e9;  // tons/min (steel density ‚âà 7850 kg/m¬≥)
                const tonnageThisStep = massFlow * (dt / 60);  // tons
                
                this.cumulativeTonnage += tonnageThisStep;
                
                // Wear calculation: higher force ‚Üí more wear
                const forceEffect = Math.sqrt(this.rollForce / 4000);  // Normalized to typical 4000 kN
                const actualWearRate = this.wearRate * forceEffect;
                
                // Update wear (mm)
                this.rollWear = (this.cumulativeTonnage / 1000) * actualWearRate;
                
                // Update current roll diameter
                this.rollDiameter = this.rollDiameterNew - this.rollWear;
                
                // Check if roll change needed
                if (this.cumulativeTonnage >= this.rollChangeTonnage) {
                    // In real mill, this would trigger roll change
                    // For simulation, we'll just note it
                }
            }
            
            getWearPercentage() {
                // Typical max wear before roll change: 0.5-1.0 mm
                const maxWear = 1.0;  // mm
                return Math.min(100, (this.rollWear / maxWear) * 100);
            }
            
            changeRolls() {
                // Simulate roll change
                this.rollWear = 0;
                this.cumulativeTonnage = 0;
                this.rollDiameter = this.rollDiameterNew;
                console.log(`Stand ${this.standNumber}: Rolls changed`);
            }
            
            reset() {
                this.controller.reset();
                this.exitThickness = this.thicknessTarget;
                this.threadingTarget = this.thicknessTarget;  // Initialize threading target
                this.rollForce = 0;
                this.motorPower = 0;
                this.profileShapeController.reset();
                this.crownCorrection = 0;
                this.currentCrown = 0;
                this.currentFlatness = 0;
                this.shapeDefect = ShapeDefect.NONE;
                this.temperature = MILL_CONFIG.AMBIENT_TEMP;
            }
        }
        
        // ============================================================================
        // TENSION ZONE CLASS
        // ============================================================================
        
        class TensionZone {
            constructor(zoneNumber) {
                this.zoneNumber = zoneNumber;
                this.controller = new IMCController(0.3);
                this.controller.kp = 2.0;
                this.controller.ki = 0.8;
                this.controller.kd = 0.15;
                
                this.tension = MILL_CONFIG.NOMINAL_TENSION;
                this.tensionTarget = MILL_CONFIG.NOMINAL_TENSION;
                this.speedRatio = 1.0;
            }
            
            update(upstreamSpeed, downstreamSpeed, upstreamThickness, downstreamThickness, dt) {
                // CRITICAL: Mass flow balance MUST be maintained
                // h‚ÇÅ √ó v‚ÇÅ = h‚ÇÇ √ó v‚ÇÇ
                // Therefore: v‚ÇÇ/v‚ÇÅ = h‚ÇÅ/h‚ÇÇ
                
                // Ideal speed ratio from mass flow balance (using ACTUAL thicknesses)
                const idealSpeedRatio = upstreamThickness / downstreamThickness;
                
                // Add MINIMAL speed variations (¬±0.2% realistic)
                const speedNoise = (Math.random() - 0.5) * 0.004; // ¬±0.2%
                const actualSpeedRatio = (downstreamSpeed / upstreamSpeed) * (1 + speedNoise);
                
                // Speed ratio error (how far we are from ideal mass flow)
                const speedRatioError = actualSpeedRatio - idealSpeedRatio;
                
                // Tension deviation based on speed mismatch
                const tensionError = speedRatioError * 500;  // Moderate sensitivity
                
                // Add SMALL coil eccentricity effect (¬±1 kN)
                const time = Date.now() / 1000;
                const eccentricityEffect = Math.sin(time * 2.0 + this.zoneNumber) * 1.0; // ¬±1 kN
                
                // Total tension with small variations
                this.tension = this.tensionTarget + tensionError + eccentricityEffect;
                this.tension = Math.max(MILL_CONFIG.MIN_TENSION, 
                               Math.min(MILL_CONFIG.MAX_TENSION, this.tension));
                
                // Control action from tension controller (small correction)
                const tensionControlAction = this.controller.update(this.tensionTarget, this.tension, dt);
                
                // THE FIX: Speed ratio is PRIMARILY based on mass flow balance,
                // with only SMALL adjustments from tension controller
                // This ensures h√óv stays constant across stands
                const tensionCorrection = tensionControlAction * 0.0005;  // Very small correction
                this.speedRatio = idealSpeedRatio + tensionCorrection;
                
                // Ensure speed ratio stays reasonable
                this.speedRatio = Math.max(0.5, Math.min(3.0, this.speedRatio));
                
                return this.speedRatio;
            }
            
            reset() {
                this.controller.reset();
                this.tension = this.tensionTarget;
                this.speedRatio = 1.0;
            }
        }
        
        // ============================================================================
        // COOLING ZONE CLASS
        // ============================================================================
        
        class CoolingZone {
            constructor(zoneNumber) {
                this.zoneNumber = zoneNumber;
                this.controller = new IMCController(0.3);  // Faster response
                this.controller.kp = 2.0;  // Reduced from 5.0 - less aggressive
                this.controller.ki = 0.8;  // Reduced from 2.0 - slower integral
                this.controller.kd = 0.2;  // Reduced from 0.4 - gentler damping
                
                // Cooling state
                this.flowRate = 0.50;  // Start at 50% flow for balanced control
                this.enabled = true;
                this.targetTemp = MILL_CONFIG.TARGET_EXIT_TEMP;
                
                // Measured values
                this.actualCoolingRate = 0;  // ¬∞C/s
                this.coolantTemp = MILL_CONFIG.COOLANT_TEMP;
                
                // Zone characteristics
                this.maxFlow = 1.0;
                this.minFlow = 0.20;  // 20% minimum to maintain baseline cooling
            }
            
            computeCooling(stripTemp, stripSpeed, dt) {
                if (!this.enabled || this.flowRate < 0.01) {
                    this.actualCoolingRate = 0;
                    return 0;
                }
                
                // Cooling effectiveness depends on:
                // 1. Flow rate
                // 2. Temperature difference
                // 3. Strip speed (exposure time)
                // 4. Heat transfer coefficient
                
                const tempDiff = stripTemp - this.coolantTemp;
                if (tempDiff <= 0) {
                    this.actualCoolingRate = 0;
                    return 0;
                }
                
                // Speed factor: slower speed = better cooling (more exposure time)
                const speedFactor = Math.sqrt(800 / Math.max(stripSpeed, 100));
                
                // Flow effect: proportional to square root of flow rate
                const flowEffect = Math.sqrt(this.flowRate);
                
                // Base cooling rate
                const baseCoolingRate = MILL_CONFIG.MAX_COOLING_RATE * 
                                       MILL_CONFIG.COOLING_EFFICIENCY *
                                       flowEffect * 
                                       speedFactor;
                
                // Temperature difference effect (direct proportional for stronger response)
                // Remove the /50 normalization to make cooling more aggressive
                const coolingRate = baseCoolingRate * Math.min(tempDiff / 30, 1.5);  // Scale up to 1.5√ó for high temps
                
                // Apply time step
                const tempDrop = coolingRate * dt;
                
                this.actualCoolingRate = coolingRate;
                
                // Return temperature drop (always positive for cooling)
                return Math.min(tempDrop, tempDiff);  // Can't cool below coolant temp
            }
            
            updateControl(stripTemp, targetTemp, dt) {
                // Temperature control logic
                if (!this.enabled) {
                    this.flowRate = 0;
                    return;
                }
                
                // Add feedforward bias based on zone position
                // Later zones naturally need more cooling
                const zoneBasedBias = 0.3 + (this.zoneNumber * 0.08); // 30-78% baseline
                
                // Control action from temperature controller
                const controlAction = this.controller.update(targetTemp, stripTemp, dt);
                
                // Convert control action to flow rate adjustment
                // Positive error (too hot) ‚Üí increase flow
                // Negative error (too cold) ‚Üí decrease flow
                const flowAdjustment = controlAction * 0.04;  // Reduced from 0.08
                
                // Apply adjustment to biased baseline
                this.flowRate = zoneBasedBias + flowAdjustment;
                
                // Constrain flow rate
                this.flowRate = Math.max(this.minFlow, Math.min(this.maxFlow, this.flowRate));
            }
            
            reset() {
                this.controller.reset();
                this.flowRate = 0.50;  // Start at 50% for balanced control
                this.actualCoolingRate = 0;
            }
        }
        
        // ============================================================================
        // MULTI-STAND MILL CLASS
        // ============================================================================
        
        class MultiStandMill {
            constructor() {
                this.stands = [];
                this.tensionZones = [];
                this.coolingZones = [];
                
                // Create 6 stands
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    this.stands.push(new RollingStand(i + 1));
                }
                
                // Create 5 tension zones (between stands)
                for (let i = 0; i < MILL_CONFIG.NUM_TENSION_ZONES; i++) {
                    this.tensionZones.push(new TensionZone(i + 1));
                }
                
                // Create 7 cooling zones (entry + inter-stand + exit)
                // Zone 0: Entry cooling (before Stand 1)
                // Zones 1-5: Inter-stand cooling (between stands)
                // Zone 6: Exit cooling (after Stand 6)
                for (let i = 0; i < MILL_CONFIG.NUM_COOLING_ZONES; i++) {
                    this.coolingZones.push(new CoolingZone(i));
                }
                
                // Mill schedule
                this.entryThickness = 3.0;
                this.exitThickness = 0.23;
                this.masterSpeed = 800;
                this.loadSchedule = LOAD_SCHEDULES.progressive;
                
                // Cooling control
                this.coolingEnabled = true;
                this.coolingMode = 'auto';  // 'auto' or 'manual'
                this.targetExitTemp = MILL_CONFIG.TARGET_EXIT_TEMP;
                
                // Boundary tensions (uncoiler and coiler)
                this.entryTension = MILL_CONFIG.ENTRY_TENSION;  // kN - from uncoiler
                this.exitTension = MILL_CONFIG.EXIT_TENSION;    // kN - to coiler
                
                console.log('üè≠ MILL INITIALIZATION:');
                console.log(`  TARGET_EXIT_TEMP from MILL_CONFIG: ${MILL_CONFIG.TARGET_EXIT_TEMP}¬∞C`);
                console.log(`  Mill targetExitTemp: ${this.targetExitTemp}¬∞C`);
                console.log(`  Cooling enabled: ${this.coolingEnabled}`);
                console.log(`  Cooling mode: ${this.coolingMode}`);
                console.log(`  Entry tension (uncoiler): ${this.entryTension} kN`);
                console.log(`  Exit tension (coiler): ${this.exitTension} kN`);
                
                // State
                this.isThreading = false;
                this.threadingProgress = 0;
                this.currentGrade = null;
                
                // Disturbances
                this.disturbances = {
                    hardness: 0,
                    temperature: 0
                };
                
                this.computeSchedule();
            }
            
            computeSchedule() {
                // Validate inputs
                if (!this.entryThickness || !this.exitThickness || this.entryThickness <= this.exitThickness) {
                    console.error('Invalid thickness values:', this.entryThickness, this.exitThickness);
                    return;
                }
                
                // Validate and normalize load schedule
                const scheduleSum = this.loadSchedule.reduce((a, b) => a + b, 0);
                console.log('Load schedule sum:', scheduleSum);
                
                if (Math.abs(scheduleSum - 1.0) > 0.001) {
                    console.warn('Load schedule does not sum to 1.0, normalizing:', this.loadSchedule);
                    // Normalize to ensure it sums to 1.0
                    this.loadSchedule = this.loadSchedule.map(x => x / scheduleSum);
                    console.log('Normalized schedule:', this.loadSchedule);
                }
                
                // Compute thickness schedule based on load distribution
                const totalReduction = this.entryThickness - this.exitThickness;
                let currentThickness = this.entryThickness;
                
                console.log('Computing thickness schedule:');
                console.log('  Entry:', this.entryThickness.toFixed(3), 'mm');
                console.log('  Exit:', this.exitThickness.toFixed(3), 'mm');
                console.log('  Total reduction:', totalReduction.toFixed(3), 'mm');
                
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const standReduction = totalReduction * this.loadSchedule[i];
                    const exitThickness = currentThickness - standReduction;
                    
                    // Validate thickness is positive
                    if (exitThickness <= 0) {
                        console.error(`Stand ${i+1} exit thickness is non-positive:`, exitThickness);
                        console.error('  Entry:', currentThickness, 'Reduction:', standReduction);
                        return;
                    }
                    
                    this.stands[i].entryThickness = currentThickness;
                    this.stands[i].thicknessTarget = exitThickness;
                    this.stands[i].exitThickness = exitThickness;
                    this.stands[i].reduction = standReduction;
                    
                    // Initialize temperature
                    this.stands[i].temperature = MILL_CONFIG.AMBIENT_TEMP;
                    
                    console.log(`  Stand ${i+1}: ${currentThickness.toFixed(3)} ‚Üí ${exitThickness.toFixed(3)} mm (Œî=${standReduction.toFixed(3)}, ${(this.loadSchedule[i]*100).toFixed(1)}%)`);
                    
                    currentThickness = exitThickness;
                }
                
                // Compute speed schedule (mass flow balance)
                console.log('Computing speed schedule (mass flow balance):');
                this.stands[0].speedTarget = this.masterSpeed;
                this.stands[0].speed = this.masterSpeed;
                console.log(`  Stand 1: ${this.stands[0].speed.toFixed(0)} m/min (master)`);
                
                for (let i = 1; i < MILL_CONFIG.NUM_STANDS; i++) {
                    // v2/v1 = h1/h2 (mass flow balance)
                    const speedRatio = this.stands[i-1].thicknessTarget / this.stands[i].thicknessTarget;
                    this.stands[i].speedTarget = this.stands[i-1].speedTarget * speedRatio;
                    this.stands[i].speed = this.stands[i].speedTarget;
                    
                    console.log(`  Stand ${i+1}: ${this.stands[i].speed.toFixed(0)} m/min (ratio=${speedRatio.toFixed(3)})`);
                }
                
                // Compute initial roll forces and powers
                const yieldStrength = this.currentGrade ? this.currentGrade.yield : 350;
                console.log('Computing roll forces and powers (œÉ_y=' + yieldStrength + ' MPa):');
                
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const stand = this.stands[i];
                    stand.rollForce = stand.computeRollForce(
                        stand.entryThickness, 
                        stand.exitThickness, 
                        yieldStrength, 
                        stand.temperature
                    );
                    stand.motorPower = stand.computeMotorPower(
                        stand.rollForce, 
                        stand.speed, 
                        stand.reduction
                    );
                    
                    // Calculate temperature rise using the motorPower we just computed
                    // Get entry temperature first (needed for all cases)
                    let T_entry = 25;
                    try {
                        if (i > 0 && this.mill && this.mill.stands && this.mill.stands[i-1] && typeof this.mill.stands[i-1].temperature !== 'undefined') {
                            T_entry = this.mill.stands[i-1].temperature;
                        }
                    } catch (error) {
                        // Thermal calculation error - fail gracefully
                        if (i > 0) {
                            // Try to use previous stand's temperature
                            try {
                                T_entry = this.mill.stands[i-1].temperature || 25;
                            } catch (e) {
                                T_entry = 25;
                            }
                        } else {
                            T_entry = 25;
                        }
                        // Log error only once
                        if (!this.thermalErrorLogged) {
                            console.warn('Thermal calculation error (recovered):', error.message);
                            this.thermalErrorLogged = true;
                        }
                    }
                    
                    if (stand.motorPower && stand.motorPower > 1) {
                        // Heat generated (95% of work becomes heat)
                        const P_heat = stand.motorPower * 0.95;  // kW
                        
                        // Mass flow rate
                        const h_m = stand.exitThickness / 1000;   // m
                        const w_m = stand.width / 1000;           // m
                        const v_ms = stand.speed / 60;            // m/s
                        const rho = 7850;                         // kg/m¬≥
                        const massFlow = rho * h_m * w_m * v_ms; // kg/s
                        
                        if (massFlow > 0.001) {
                            const cp = 0.46;  // kJ/(kg¬∑K)
                            const deltaT = P_heat / (massFlow * cp);  // ¬∞C
                            
                            // Calculate exit temperature
                            stand.temperature = T_entry + deltaT;
                            
                            // Apply cooling if zone exists
                            if (i > 0 && i <= 5 && this.mill && this.mill.coolingZones && this.mill.coolingZones[i-1]) {
                                const flowRate = this.mill.coolingZones[i-1].flowRate || 0;
                                if (flowRate > 0.1) {
                                    const cooling = 0.5 * flowRate;
                                    stand.temperature = Math.max(25, stand.temperature - cooling);
                                }
                            }
                            
                            // Log for debugging (first stand only, periodically)
                            if (i === 0 && Math.random() < 0.01) {
                                console.log(`üå°Ô∏è Stand 1: P=${P_heat.toFixed(0)}kW, ·πÅ=${massFlow.toFixed(1)}kg/s, ŒîT=${deltaT.toFixed(1)}¬∞C, T=${stand.temperature.toFixed(1)}¬∞C`);
                            }
                        } else {
                            // Mass flow too low
                            stand.temperature = T_entry;
                        }
                    } else {
                        // No power: keep entry temperature
                        stand.temperature = T_entry;
                    }
                    stand.gapPosition = stand.exitThickness + stand.rollForce / stand.millModulus;
                    
                    console.log(`  Stand ${i+1}: F=${stand.rollForce.toFixed(0)} kN, P=${stand.motorPower.toFixed(0)} kW`);
                }
                
                // Verify mass flow balance
                console.log('Mass flow verification:');
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const flow = this.stands[i].exitThickness * this.stands[i].speed;
                    console.log(`  Stand ${i+1}: h√óv = ${this.stands[i].exitThickness.toFixed(3)} √ó ${this.stands[i].speed.toFixed(0)} = ${flow.toFixed(1)}`);
                }
            }
            
            update(dt) {
                const yieldStrength = this.currentGrade ? this.currentGrade.yield : 350;
                
                // Track simulation time in mill
                if (!this.simTime) this.simTime = 0;
                if (!this.debugCounter) this.debugCounter = 0;
                this.simTime += dt;
                this.debugCounter++;
                
                // Log cooling control every 100 updates (~2 seconds)
                const shouldLog = (this.debugCounter % 100 === 0);
                
                // ========================================================================
                // THREADING TENSION MANAGEMENT
                // Reduce inter-stand tensions during threading to prevent strip breaks
                // ========================================================================
                if (this.isThreading) {
                    // Gradually increase tension from 40% to 100% as threading progresses
                    const minTensionFactor = MILL_CONFIG.THREADING_TENSION_FACTOR;  // 0.4 (40%)
                    const maxTensionFactor = 1.0;  // 100%
                    
                    // S-curve tension ramp
                    const smoothProgress = 3 * Math.pow(this.threadingProgress, 2) - 
                                          2 * Math.pow(this.threadingProgress, 3);
                    
                    const tensionFactor = minTensionFactor + 
                                         (maxTensionFactor - minTensionFactor) * smoothProgress;
                    
                    const threadingTension = MILL_CONFIG.NOMINAL_TENSION * tensionFactor;
                    
                    this.tensionZones.forEach(zone => {
                        zone.tensionTarget = threadingTension;
                    });
                } else {
                    // Normal operation: use UI-specified tension
                    const normalTension = parseFloat(document.getElementById('interStandTension')?.value) || 
                                         MILL_CONFIG.NOMINAL_TENSION;
                    this.tensionZones.forEach(zone => {
                        zone.tensionTarget = normalTension;
                    });
                    
                    // Update boundary tensions from UI
                    this.entryTension = parseFloat(document.getElementById('entryTension')?.value) || 
                                       MILL_CONFIG.ENTRY_TENSION;
                    this.exitTension = parseFloat(document.getElementById('exitTension')?.value) || 
                                      MILL_CONFIG.EXIT_TENSION;
                }
                
                // ========================================================================
                // THREADING GAP MANAGEMENT - REDUCTION-BASED APPROACH
                // Reduce reduction percentage during threading (NOT thickness scaling!)
                // This DECREASES forces during threading as in real mills
                // ========================================================================
                if (this.isThreading) {
                    // S-curve reduction factor profile: 0.5 ‚Üí 1.0
                    // This means: 50% reduction at start, 100% reduction at end
                    const smoothProgress = 3 * Math.pow(this.threadingProgress, 2) - 
                                          2 * Math.pow(this.threadingProgress, 3);
                    
                    const minReductionFactor = 0.5;  // 50% of normal reduction (gentler)
                    const maxReductionFactor = 1.0;  // 100% of normal reduction
                    
                    const reductionFactor = minReductionFactor + 
                                           (maxReductionFactor - minReductionFactor) * smoothProgress;
                    
                    // Apply reduction-based threading to all stands
                    // Key: entry thickness stays correct, only exit thickness (gap) changes
                    this.stands.forEach((stand, i) => {
                        if (i === 0) {
                            // Stand 1: Entry is fixed coil thickness
                            const normalReduction = this.entryThickness - stand.thicknessTarget;
                            const threadingReduction = normalReduction * reductionFactor;
                            stand.threadingTarget = this.entryThickness - threadingReduction;
                        } else {
                            // Stands 2-6: Entry is previous stand's CURRENT exit
                            // Use CURRENT exitThickness, not target, for real-time response
                            const entryThickness = this.stands[i-1].exitThickness;
                            const normalReduction = entryThickness - stand.thicknessTarget;
                            const threadingReduction = normalReduction * reductionFactor;
                            stand.threadingTarget = entryThickness - threadingReduction;
                        }
                    });
                } else {
                    // Normal operation: no modified targets
                    this.stands.forEach((stand, i) => {
                        stand.threadingTarget = stand.thicknessTarget;  // Use normal target
                    });
                }
                // AGC remains active in both modes, just tracking different targets
                // Result: Forces DECREASE during threading (50% reduction ‚Üí 30% lower force)
                
                // Entry speed control for Stand 1 (only during normal operation, not threading)
                // In real mills, Stand 1 speed varies due to:
                // 1. Entry thickness variations (mass flow balance with uncoiler)
                // 2. Entry tension control
                // 3. Process disturbances
                
                if (!this.isThreading) {
                    // Base speed from master speed reference
                    let stand1Speed = this.masterSpeed;
                    
                    // Add speed variation due to entry thickness changes (¬±1-2% typical)
                    // If entry thickness increases, speed should decrease slightly to maintain flow
                    const entryThicknessVariation = (this.entryThickness - 3.0) / 3.0; // Normalized deviation from nominal
                    const thicknessSpeedCorrection = -entryThicknessVariation * 0.015; // ¬±1.5% max correction
                    
                    // Add small random speed variations (¬±0.3% realistic for speed control loops)
                    const speedNoise = (Math.random() - 0.5) * 0.006; // ¬±0.3%
                    
                    // Add entry tension effect (small cyclic variation from uncoiler)
                    const time = Date.now() / 1000;
                    const entryTensionEffect = Math.sin(time * 0.5) * 0.003; // ¬±0.3% cyclic
                    
                    // Apply speed corrections to Stand 1
                    stand1Speed = this.masterSpeed * (1 + thicknessSpeedCorrection + speedNoise + entryTensionEffect);
                    
                    // Ensure speed stays within reasonable bounds
                    stand1Speed = Math.max(MILL_CONFIG.MIN_SPEED, Math.min(MILL_CONFIG.MAX_SPEED, stand1Speed));
                    
                    // Update Stand 1 speed
                    this.stands[0].speed = stand1Speed;
                }
                
                // Update first stand with current speed and ambient entry temperature
                this.stands[0].update(this.entryThickness, dt, this.disturbances, yieldStrength, MILL_CONFIG.AMBIENT_TEMP);
                    
                    // Update Profile & Shape Control for Stand 1
                    this.stands[0].profileShapeController.update(this.stands[0], dt, 0);
                    const status0 = this.stands[0].profileShapeController.getStatus();
                    this.stands[0].currentCrown = status0.crown;
                    this.stands[0].currentFlatness = status0.flatness;
                    this.stands[0].shapeDefect = status0.shapeDefect;
                
                // Update roll temperature for Stand 1 if thermal enhancement is enabled
                if (window.thermalEnhancement && window.thermalEnhancement.enableRollTemp) {
                    const heatFromStrip = (this.stands[0].motorPower || 0) * 1000 * 0.15; // W, ~15% goes to rolls
                    window.thermalEnhancement.updateRollTemperature(
                        0, 
                        this.stands[0].temperature, 
                        heatFromStrip, 
                        dt
                    );
                }
                
                // Apply cooling immediately after Stand 1 (inter-stand zone 1)
                if (this.coolingEnabled) {
                    const coolingZone = this.coolingZones[1];
                    if (this.coolingMode === 'auto') {
                        // Zone 1 after Stand 1: Allow temperature to rise initially
                        // Target: 1/6 of the way from ambient to exit temp
                        const targetTemp = MILL_CONFIG.AMBIENT_TEMP + 
                                         (this.targetExitTemp - MILL_CONFIG.AMBIENT_TEMP) * (1.0 / MILL_CONFIG.NUM_STANDS);
                        
                        // DEBUG: Log cooling targets periodically
                        if (shouldLog) {
                            console.log(`üå°Ô∏è COOLING CONTROL DEBUG (t=${this.simTime.toFixed(1)}s):`);
                            console.log(`  Mill targetExitTemp: ${this.targetExitTemp}¬∞C`);
                            console.log(`  AMBIENT_TEMP: ${MILL_CONFIG.AMBIENT_TEMP}¬∞C`);
                            const error = this.stands[0].temperature - targetTemp;
                            console.log(`  Zone 1: target=${targetTemp.toFixed(1)}¬∞C, actual=${this.stands[0].temperature.toFixed(1)}¬∞C, error=${error.toFixed(1)}¬∞C, flow=${coolingZone.flowRate.toFixed(3)}`);
                        }
                        
                        coolingZone.updateControl(this.stands[0].temperature, targetTemp, dt);
                    }
                    const coolingEffect = coolingZone.computeCooling(
                        this.stands[0].temperature,
                        this.stands[0].speed,
                        dt
                    );
                    this.stands[0].temperature -= coolingEffect;
                    this.stands[0].temperature = Math.max(MILL_CONFIG.COOLANT_TEMP, this.stands[0].temperature);
                    
                    // Apply radiation heat loss if enabled
                    if (window.thermalEnhancement && window.thermalEnhancement.enableRadiation) {
                        const stripArea = (MILL_CONFIG.STRIP_WIDTH / 1000) * 0.1; // m¬≤ (width in m √ó 100mm length)
                        const radPower = window.thermalEnhancement.calculateRadiation(
                            this.stands[0].temperature,
                            MILL_CONFIG.AMBIENT_TEMP,
                            stripArea
                        ); // W
                        
                        // Calculate temperature drop from radiation
                        const h_m = this.stands[0].exitThickness / 1000; // m
                        const w_m = this.stands[0].width / 1000; // m
                        const v_ms = this.stands[0].speed / 60; // m/s
                        const rho = 7850; // kg/m¬≥
                        const massFlow = rho * h_m * w_m * v_ms; // kg/s
                        
                        if (massFlow > 0.001) {
                            const cp = 460; // J/(kg¬∑K)
                            const radTempDrop = (radPower / 1000) / (massFlow * cp) * dt; // ¬∞C
                            this.stands[0].temperature -= radTempDrop;
                        }
                    }
                }
                
                // Update remaining stands with mass flow balance enforcement
                // CRITICAL: Pass previous stand's COOLED temperature as entry temperature
                for (let i = 1; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const entryThickness = this.stands[i-1].exitThickness;
                    
                    // Use ACTUAL exit thicknesses for mass flow balance
                    const h_upstream = this.stands[i-1].exitThickness;
                    const h_downstream = this.stands[i].exitThickness;
                    
                    // Update tension zone with ACTUAL thicknesses
                    const speedRatio = this.tensionZones[i-1].update(
                        this.stands[i-1].speed,
                        this.stands[i].speed,
                        h_upstream,
                        h_downstream,
                        dt
                    );
                    
                    // Adjust stand speed to maintain mass flow balance
                    this.stands[i].speed = this.stands[i-1].speed * speedRatio;
                    
                    // Update stand i with previous stand's COOLED temperature
                    this.stands[i].update(entryThickness, dt, this.disturbances, yieldStrength, this.stands[i-1].temperature);
                    
                    // Update Profile & Shape Control
                    const tension_i = this.tensionZones[i-1].tension;
                    this.stands[i].profileShapeController.update(this.stands[i], dt, tension_i);
                    const statusI = this.stands[i].profileShapeController.getStatus();
                    this.stands[i].currentCrown = statusI.crown;
                    this.stands[i].currentFlatness = statusI.flatness;
                    this.stands[i].shapeDefect = statusI.shapeDefect;
                    
                    // Update roll temperature for this stand if thermal enhancement is enabled
                    if (window.thermalEnhancement && window.thermalEnhancement.enableRollTemp) {
                        const heatFromStrip = (this.stands[i].motorPower || 0) * 1000 * 0.15; // W, ~15% goes to rolls
                        window.thermalEnhancement.updateRollTemperature(
                            i, 
                            this.stands[i].temperature, 
                            heatFromStrip, 
                            dt
                        );
                    }
                    
                    // Apply cooling IMMEDIATELY after this stand updates
                    if (this.coolingEnabled && i < MILL_CONFIG.NUM_STANDS - 1) {
                        // Inter-stand cooling (zones 2-5 for stands 2-5)
                        const coolingZone = this.coolingZones[i + 1];
                        
                        if (this.coolingMode === 'auto') {
                            // Gradual temperature target progression
                            // Zone 2 (after Stand 2): 2/6 of temp rise
                            // Zone 5 (after Stand 5): 5/6 of temp rise
                            const targetTemp = MILL_CONFIG.AMBIENT_TEMP + 
                                             (this.targetExitTemp - MILL_CONFIG.AMBIENT_TEMP) * 
                                             ((i + 1) / MILL_CONFIG.NUM_STANDS);
                            
                            // DEBUG: Log zone targets
                            if (shouldLog) {
                                const error = this.stands[i].temperature - targetTemp;
                                console.log(`  Zone ${i+1}: target=${targetTemp.toFixed(1)}¬∞C, actual=${this.stands[i].temperature.toFixed(1)}¬∞C, error=${error.toFixed(1)}¬∞C, flow=${coolingZone.flowRate.toFixed(3)}`);
                            }
                            
                            coolingZone.updateControl(this.stands[i].temperature, targetTemp, dt);
                        }
                        
                        const coolingEffect = coolingZone.computeCooling(
                            this.stands[i].temperature,
                            this.stands[i].speed,
                            dt
                        );
                        
                        this.stands[i].temperature -= coolingEffect;
                        this.stands[i].temperature = Math.max(MILL_CONFIG.COOLANT_TEMP, this.stands[i].temperature);
                        
                        // Apply radiation heat loss if enabled
                        if (window.thermalEnhancement && window.thermalEnhancement.enableRadiation) {
                            const stripArea = (MILL_CONFIG.STRIP_WIDTH / 1000) * 0.1; // m¬≤ (width in m √ó 100mm length)
                            const radPower = window.thermalEnhancement.calculateRadiation(
                                this.stands[i].temperature,
                                MILL_CONFIG.AMBIENT_TEMP,
                                stripArea
                            ); // W
                            
                            // Calculate temperature drop from radiation
                            const h_m = this.stands[i].exitThickness / 1000; // m
                            const w_m = this.stands[i].width / 1000; // m
                            const v_ms = this.stands[i].speed / 60; // m/s
                            const rho = 7850; // kg/m¬≥
                            const massFlow = rho * h_m * w_m * v_ms; // kg/s
                            
                            if (massFlow > 0.001) {
                                const cp = 460; // J/(kg¬∑K)
                                const radTempDrop = (radPower / 1000) / (massFlow * cp) * dt; // ¬∞C
                                this.stands[i].temperature -= radTempDrop;
                            }
                        }
                    }
                }
                
                // Exit cooling for Stand 6 (zone 6)
                if (this.coolingEnabled) {
                    const exitCoolingZone = this.coolingZones[6];
                    
                    if (this.coolingMode === 'auto') {
                        exitCoolingZone.updateControl(this.stands[5].temperature, this.targetExitTemp, dt);
                        
                        // DEBUG: Log zone 6
                        if (shouldLog) {
                            const error = this.stands[5].temperature - this.targetExitTemp;
                            console.log(`  Zone 6: target=${this.targetExitTemp.toFixed(1)}¬∞C, actual=${this.stands[5].temperature.toFixed(1)}¬∞C, error=${error.toFixed(1)}¬∞C, flow=${exitCoolingZone.flowRate.toFixed(3)}`);
                            console.log(`  ---`);
                        }
                    }
                    
                    const exitCooling = exitCoolingZone.computeCooling(
                        this.stands[5].temperature,
                        this.stands[5].speed,
                        dt
                    );
                    this.stands[5].temperature -= exitCooling;
                    this.stands[5].temperature = Math.max(MILL_CONFIG.COOLANT_TEMP, this.stands[5].temperature);
                    
                    // Apply radiation heat loss if enabled
                    if (window.thermalEnhancement && window.thermalEnhancement.enableRadiation) {
                        const stripArea = (MILL_CONFIG.STRIP_WIDTH / 1000) * 0.2; // m¬≤ (width in m √ó 200mm exit length)
                        const radPower = window.thermalEnhancement.calculateRadiation(
                            this.stands[5].temperature,
                            MILL_CONFIG.AMBIENT_TEMP,
                            stripArea
                        ); // W
                        
                        // Calculate temperature drop from radiation
                        const h_m = this.stands[5].exitThickness / 1000; // m
                        const w_m = this.stands[5].width / 1000; // m
                        const v_ms = this.stands[5].speed / 60; // m/s
                        const rho = 7850; // kg/m¬≥
                        const massFlow = rho * h_m * w_m * v_ms; // kg/s
                        
                        if (massFlow > 0.001) {
                            const cp = 460; // J/(kg¬∑K)
                            const radTempDrop = (radPower / 1000) / (massFlow * cp) * dt; // ¬∞C
                            this.stands[5].temperature -= radTempDrop;
                        }
                    }
                }
            }
            
            getTotalForce() {
                const total = this.stands.reduce((sum, stand) => {
                    const force = stand.rollForce || 0;
                    return sum + (isNaN(force) ? 0 : force);
                }, 0);
                return isNaN(total) ? 0 : total;
            }
            
            getTotalPower() {
                const total = this.stands.reduce((sum, stand) => {
                    const power = stand.motorPower || 0;
                    return sum + (isNaN(power) ? 0 : power);
                }, 0) / 1000; // MW
                return isNaN(total) ? 0 : total;
            }
            
            updateThreading(dt) {
                if (!this.isThreading) return;
                
                // Update overall progress
                this.threadingProgress += dt / MILL_CONFIG.THREADING_TIME;
                
                // Check completion
                if (this.threadingProgress >= 1.0) {
                    this.threadingProgress = 1.0;
                    this.isThreading = false;
                    
                    // Reset all AGC controllers when threading completes
                    // This gives AGC a fresh start with no accumulated integral errors
                    this.stands.forEach(stand => {
                        stand.controller.reset();
                    });
                    
                    console.log('Threading complete - AGC controllers reset for clean handoff');
                    return;
                }
                
                // Calculate number of engaged stands (1-6)
                // Stand 1 engages immediately, then one stand every 5 seconds
                const standsEngaged = Math.min(
                    MILL_CONFIG.NUM_STANDS, 
                    Math.floor(this.threadingProgress * MILL_CONFIG.NUM_STANDS) + 1
                );
                
                // Calculate engagement progress for each stand
                const standProgressArray = [];
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const standStartTime = i / MILL_CONFIG.NUM_STANDS;
                    const standEndTime = 1.0;
                    
                    if (this.threadingProgress < standStartTime) {
                        standProgressArray[i] = 0;  // Not engaged yet
                    } else {
                        // Normalize progress for this stand
                        const standProgress = (this.threadingProgress - standStartTime) / (standEndTime - standStartTime);
                        standProgressArray[i] = Math.min(1.0, standProgress);
                    }
                }
                
                // S-curve speed profile for engaged stands
                for (let i = 0; i < standsEngaged; i++) {
                    const progress = standProgressArray[i];
                    
                    // S-curve smoothing (3rd-order polynomial)
                    // f(x) = 3x¬≤ - 2x¬≥ gives smooth 0‚Üí1 transition
                    const smoothProgress = 3 * Math.pow(progress, 2) - 2 * Math.pow(progress, 3);
                    
                    if (i === 0) {
                        // Stand 1: Direct speed ramp with S-curve
                        const threadSpeed = MILL_CONFIG.THREADING_SPEED + 
                            (this.masterSpeed - MILL_CONFIG.THREADING_SPEED) * smoothProgress;
                        this.stands[i].speed = threadSpeed;
                    } else {
                        // Downstream stands: Mass flow balance
                        const speedRatio = this.stands[i-1].thicknessTarget / this.stands[i].thicknessTarget;
                        const targetSpeed = this.stands[i-1].speed * speedRatio;
                        
                        // Blend from threading speed to target speed based on engagement
                        this.stands[i].speed = MILL_CONFIG.THREADING_SPEED + 
                            (targetSpeed - MILL_CONFIG.THREADING_SPEED) * smoothProgress;
                    }
                }
                
                // Non-engaged stands remain at idle/threading speed
                for (let i = standsEngaged; i < MILL_CONFIG.NUM_STANDS; i++) {
                    this.stands[i].speed = MILL_CONFIG.THREADING_SPEED;
                }
            }
            
            reset() {
                this.stands.forEach(stand => stand.reset());
                this.tensionZones.forEach(zone => zone.reset());
                this.coolingZones.forEach(zone => zone.reset());
                this.computeSchedule();
                this.threadingProgress = 0;
                this.isThreading = false;
            }
        }
        
        // ============================================================================
        // SIMULATION ENGINE
        // ============================================================================
        
        class SimulationEngine {
            constructor() {
                this.mill = new MultiStandMill();
                this.isRunning = false;
                this.time = 0;
                this.speed = 5;
                this.emergencyStop = false;
                
                // Data buffers
                this.data = {
                    time: new CircularBuffer(500),
                    thicknessProfile: Array(6).fill(null).map(() => new CircularBuffer(500)),
                    speedProfile: Array(6).fill(null).map(() => new CircularBuffer(500)),
                    forceProfile: Array(6).fill(null).map(() => new CircularBuffer(500)),
                    powerProfile: Array(6).fill(null).map(() => new CircularBuffer(500)),
                    tensionProfile: Array(5).fill(null).map(() => new CircularBuffer(500)),
                    temperatureProfile: Array(6).fill(null).map(() => new CircularBuffer(500)),
                    totalForce: new CircularBuffer(500),
                    totalPower: new CircularBuffer(500)
                };
                
                this.lastChartUpdate = 0;
            }
            
            run() {
                if (!this.isRunning || this.emergencyStop) return;
                
                try {
                    const dt = Math.min(MILL_CONFIG.CONTROL_DT, MILL_CONFIG.CONTROL_DT * this.speed);
                    this.time += dt;
                    
                    // Update threading if active
                    this.mill.updateThreading(dt);
                    
                    // Update mill
                    this.mill.update(dt);
                    
                    // Store data
                    this.data.time.push(this.time);
                    for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                        this.data.thicknessProfile[i].push(this.mill.stands[i].exitThickness);
                        this.data.speedProfile[i].push(this.mill.stands[i].speed);
                        this.data.forceProfile[i].push(this.mill.stands[i].rollForce);
                        this.data.powerProfile[i].push(this.mill.stands[i].motorPower);
                        this.data.temperatureProfile[i].push(this.mill.stands[i].temperature);
                    }
                    for (let i = 0; i < MILL_CONFIG.NUM_TENSION_ZONES; i++) {
                        this.data.tensionProfile[i].push(this.mill.tensionZones[i].tension);
                    }
                    this.data.totalForce.push(this.mill.getTotalForce());
                    this.data.totalPower.push(this.mill.getTotalPower());
                    
                    // Periodic mass flow verification (every 5 seconds of simulation time)
                    if (Math.floor(this.time * 0.2) % 5 === 0 && Math.floor((this.time - dt) * 0.2) % 5 !== 0) {
                        console.log('‚ïê‚ïê‚ïê Mass Flow Check at t=' + this.time.toFixed(1) + 's ‚ïê‚ïê‚ïê');
                        const flows = this.mill.stands.map(s => s.exitThickness * s.speed);
                        flows.forEach((flow, i) => {
                            console.log(`  Stand ${i+1}: h=${this.mill.stands[i].exitThickness.toFixed(3)}mm √ó v=${this.mill.stands[i].speed.toFixed(0)}m/min = ${flow.toFixed(1)}`);
                        });
                        const avgFlow = flows.reduce((a, b) => a + b, 0) / flows.length;
                        const minFlow = Math.min(...flows);
                        const maxFlow = Math.max(...flows);
                        const balance = (minFlow / maxFlow) * 100;
                        console.log(`  Average: ${avgFlow.toFixed(1)}, Balance: ${balance.toFixed(2)}%`);
                    }
                    
                    // Update displays
                    this.updateDisplays();
                    
                    // Update charts (throttled)
                    const now = Date.now();
                    if (now - this.lastChartUpdate > MILL_CONFIG.CHART_UPDATE) {
                        updateAllCharts();
                        this.lastChartUpdate = now;
                    }
                    
                    // Continue simulation
                    setTimeout(() => this.run(), 10);
                    
                } catch (error) {
                    console.error('Simulation error:', error);
                    this.isRunning = false;
                }
            }
            
            updateDisplays() {
                // Helper function to safely format numbers
                const safeFormat = (value, decimals = 0, defaultVal = 0) => {
                    if (value === null || value === undefined || isNaN(value)) {
                        return defaultVal.toFixed(decimals);
                    }
                    return value.toFixed(decimals);
                };
                
                // Entry/Exit thickness
                document.getElementById('entryThicknessDisplay').textContent = 
                    safeFormat(this.mill.entryThickness, 3);
                document.getElementById('exitThicknessDisplay').textContent = 
                    safeFormat(this.mill.stands[5].exitThickness, 3, 0.23);
                
                const exitThick = this.mill.stands[5].exitThickness || this.mill.exitThickness;
                const totalReduction = exitThick > 0 ? 
                    (1 - exitThick / this.mill.entryThickness) * 100 : 0;
                document.getElementById('totalReductionDisplay').textContent = 
                    safeFormat(totalReduction, 1);
                
                // Master speed
                document.getElementById('masterSpeedDisplay').textContent = 
                    safeFormat(this.mill.masterSpeed, 0);
                
                // Total force and power
                const totalForce = this.mill.getTotalForce();
                const totalPower = this.mill.getTotalPower();
                document.getElementById('totalForce').textContent = 
                    safeFormat(totalForce, 0);
                document.getElementById('totalPower').textContent = 
                    safeFormat(totalPower, 2); // Changed to 2 decimals to show variations
                
                // Tension zones
                for (let i = 0; i < MILL_CONFIG.NUM_TENSION_ZONES; i++) {
                    const tension = this.mill.tensionZones[i].tension || MILL_CONFIG.NOMINAL_TENSION;
                    document.getElementById(`tension${i+1}`).textContent = 
                        safeFormat(tension, 1);
                }
                
                // Temperature
                const entryTemp = this.mill.stands[0].temperature || MILL_CONFIG.AMBIENT_TEMP;
                const exitTemp = this.mill.stands[5].temperature || MILL_CONFIG.AMBIENT_TEMP;
                document.getElementById('entryTemp').textContent = 
                    safeFormat(entryTemp, 0);
                document.getElementById('exitTemp').textContent = 
                    safeFormat(exitTemp, 0);
                const tempRise = (exitTemp - entryTemp) / 6;
                document.getElementById('tempRiseRate').textContent = 
                    safeFormat(tempRise, 1);
                
                // Mass flow balance calculation
                const flows = this.mill.stands.map(s => s.exitThickness * s.speed);
                const validFlows = flows.filter(f => f > 0);
                if (validFlows.length > 0) {
                    const minFlow = Math.min(...validFlows);
                    const maxFlow = Math.max(...validFlows);
                    const avgFlow = validFlows.reduce((a, b) => a + b, 0) / validFlows.length;
                    
                    const balance = (minFlow / maxFlow) * 100;
                    const maxDev = Math.max(
                        Math.abs(maxFlow - avgFlow) / avgFlow * 100,
                        Math.abs(minFlow - avgFlow) / avgFlow * 100
                    );
                    
                    document.getElementById('massFlowBalance').textContent = safeFormat(balance, 1);
                    document.getElementById('maxFlowDev').textContent = safeFormat(maxDev, 2);
                } else {
                    document.getElementById('massFlowBalance').textContent = '0.0';
                    document.getElementById('maxFlowDev').textContent = '0.0';
                }
                
                // Load schedule sum display
                const scheduleSum = this.mill.loadSchedule.reduce((a, b) => a + b, 0);
                document.getElementById('loadScheduleSum').textContent = safeFormat(scheduleSum, 3, 1.0);
                
                // Threading progress
                if (this.mill.isThreading) {
                    document.getElementById('threadingProgress').style.display = 'block';
                    const progressPct = (this.mill.threadingProgress * 100);
                    document.getElementById('progressFill').style.width = progressPct.toFixed(0) + '%';
                    document.getElementById('progressFill').textContent = progressPct.toFixed(0) + '%';
                    document.getElementById('threadingStatus').textContent = 
                        `Threading in progress: Stand ${Math.floor(this.mill.threadingProgress * 6) + 1}/6`;
                } else {
                    document.getElementById('threadingProgress').style.display = 'none';
                    // Clear status when not threading
                    if (this.mill.threadingProgress >= 1.0) {
                        document.getElementById('threadingStatus').textContent = 'Threading complete - Production mode';
                    } else if (this.mill.threadingProgress === 0) {
                        document.getElementById('threadingStatus').textContent = 'Ready to thread';
                    }
                }
                
                // Update mill visualization
                this.updateMillVisualization();
                
                // Update stand cards
                this.updateStandCards();
                
                // Update load distribution bars
                this.updateLoadDistribution();
                
                // Update threading progress indicators
                updateThreadingProgressDisplay();
                
                // Update roll wear monitoring
                updateWearMonitoring();
                
                // Update profile & shape displays
                this.updateProfileDisplays();
                
                // Update enhanced displays (thermal, mass flow, tension details)
                updateEnhancedDisplays();
            }
            
            updateProfileDisplays() {
                if (!this.mill || !this.mill.stands) return;
                
                const stand6 = this.mill.stands[5];
                if (!stand6 || !stand6.profileShapeController) return;
                
                const status = stand6.profileShapeController.getStatus();
                const crownMicrons = status.crown * 1000;
                
                // Sidebar displays
                const setTextIfExists = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = text;
                };
                
                setTextIfExists('displayCrown', crownMicrons.toFixed(1) + ' Œºm');
                setTextIfExists('displayFlatness', status.flatness.toFixed(1) + ' I-units');
                setTextIfExists('displayQuality', status.shapeQuality);
                setTextIfExists('displayDefect', status.shapeDefect);
                setTextIfExists('displayBending', status.bendingForce.toFixed(0) + ' kN');
                
                // Profile tab displays
                setTextIfExists('profileCrownValue', crownMicrons.toFixed(1));
                setTextIfExists('profileFlatnessValue', status.flatness.toFixed(1));
                setTextIfExists('profileQualityValue', status.shapeQuality);
                setTextIfExists('profileDefectValue', status.shapeDefect);
                
                // Bending forces for all stands
                this.mill.stands.forEach((stand, i) => {
                    if (stand && stand.profileShapeController) {
                        const s = stand.profileShapeController.getStatus();
                        setTextIfExists(`bending${i+1}`, s.bendingForce.toFixed(0) + ' kN');
                    }
                });
                
                // Detail displays
                setTextIfExists('crownTargetDisp', (stand6.profileShapeController.targetCrown * 1000).toFixed(1) + ' Œºm');
                setTextIfExists('crownActualDisp', crownMicrons.toFixed(1) + ' Œºm');
                setTextIfExists('crownErrorDisp', (status.crownError * 1000).toFixed(1) + ' Œºm');
                setTextIfExists('crownEffDisp', status.effectiveness.toFixed(0) + '%');
                
                setTextIfExists('flatnessTargetDisp', stand6.profileShapeController.targetFlatness.toFixed(1) + ' I-units');
                setTextIfExists('flatnessActualDisp', status.flatness.toFixed(1) + ' I-units');
                setTextIfExists('flatnessQualityDisp', status.shapeQuality);
                
                const severity = stand6.profileShapeController.flatnessMeasurement.defectSeverity;
                setTextIfExists('flatnessSevDisp', severity > 0 ? severity.toFixed(1) : '0 (None)');
            }
            
            updateMillVisualization() {
                const schematic = document.getElementById('millSchematic');
                if (!schematic || schematic.children.length > 0) return; // Already initialized
                
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    // Stand - 6-High Configuration
                    const standDiv = document.createElement('div');
                    standDiv.className = `stand stand-${i+1}`;
                    standDiv.innerHTML = `
                        <div class="stand-number">Stand ${i+1}</div>
                        <div class="stand-icon">
                            <div class="backup-roll" title="Top Backup Roll"></div>
                            <div class="intermediate-roll" title="Top Intermediate Roll"></div>
                            <div class="work-roll" title="Top Work Roll"></div>
                            <div class="strip" title="Strip passes between work rolls"></div>
                            <div class="work-roll" title="Bottom Work Roll"></div>
                            <div class="intermediate-roll" title="Bottom Intermediate Roll"></div>
                            <div class="backup-roll" title="Bottom Backup Roll"></div>
                        </div>
                        <div class="stand-metrics" id="standMetrics${i+1}">
                            <div class="metric-row">
                                <span class="metric-label">h:</span>
                                <span class="metric-value" id="h${i+1}">0.000</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">F:</span>
                                <span class="metric-value" id="f${i+1}">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">v:</span>
                                <span class="metric-value" id="v${i+1}">0</span>
                            </div>
                        </div>
                    `;
                    schematic.appendChild(standDiv);
                    
                    // Tension zone (except after last stand)
                    if (i < MILL_CONFIG.NUM_STANDS - 1) {
                        const tensionDiv = document.createElement('div');
                        tensionDiv.className = 'tension-zone';
                        tensionDiv.innerHTML = `
                            <div class="tension-indicator" id="tensionZone${i+1}">50kN</div>
                            <div class="strip-path"></div>
                        `;
                        schematic.appendChild(tensionDiv);
                    }
                }
            }
            
            updateStandCards() {
                const safeFormat = (value, decimals = 0, defaultVal = 0) => {
                    if (value === null || value === undefined || isNaN(value)) {
                        return defaultVal.toFixed(decimals);
                    }
                    return value.toFixed(decimals);
                };
                
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const stand = this.mill.stands[i];
                    
                    // Update visualization metrics
                    const hElem = document.getElementById(`h${i+1}`);
                    const fElem = document.getElementById(`f${i+1}`);
                    const vElem = document.getElementById(`v${i+1}`);
                    
                    // Display actual values
                    if (hElem) hElem.textContent = safeFormat(stand.exitThickness, 3);
                    if (fElem) fElem.textContent = safeFormat(stand.rollForce, 0) + 'kN';
                    if (vElem) vElem.textContent = safeFormat(stand.speed, 0) + 'm/min';
                    
                    // Update stand cards grid
                    const entryH = (i === 0) ? this.mill.entryThickness : this.mill.stands[i-1].exitThickness;
                    const exitH = stand.exitThickness;
                    const reduction = entryH > 0 ? ((entryH - exitH) / entryH * 100) : 0;
                    const thicknessError = Math.abs(exitH - stand.thicknessTarget) * 1000; // Œºm
                    
                    const updateElem = (id, value) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = value;
                    };
                    
                    updateElem(`card-entry-h${i+1}`, safeFormat(entryH, 3) + ' mm');
                    updateElem(`card-exit-h${i+1}`, safeFormat(exitH, 3) + ' mm');
                    updateElem(`card-reduction${i+1}`, safeFormat(reduction, 1) + '%');
                    updateElem(`card-force${i+1}`, safeFormat(stand.rollForce, 0) + ' kN');
                    updateElem(`card-speed${i+1}`, safeFormat(stand.speed, 0) + ' m/min');
                    updateElem(`card-power${i+1}`, safeFormat(stand.motorPower, 1) + ' kW');
                    updateElem(`card-gap${i+1}`, safeFormat(stand.gapPosition, 3) + ' mm');
                    
                    // Mill spring calculation
                    const millSpring = stand.rollForce / stand.millModulus;
                    updateElem(`card-spring${i+1}`, safeFormat(millSpring, 2) + ' mm');
                    
                    updateElem(`card-temp${i+1}`, safeFormat(stand.temperature, 0) + '¬∞C');
                    updateElem(`card-error${i+1}`, safeFormat(thicknessError, 1) + ' Œºm');
                    
                    // Roll shift position
                    if (stand.profileShapeController) {
                        const shiftPos = stand.profileShapeController.rollShifting.shiftPosition;
                        updateElem(`card-shift${i+1}`, safeFormat(shiftPos, 1) + ' mm');
                    }
                    
                    // Update roll wear displays
                    updateElem(`card-roll-tonnage${i+1}`, safeFormat(stand.cumulativeTonnage, 0) + ' t');
                    updateElem(`card-roll-wear${i+1}`, safeFormat(stand.rollWear, 2) + ' mm');
                    updateElem(`card-roll-diameter${i+1}`, safeFormat(stand.rollDiameter, 1) + ' mm');
                    
                    const wearPercent = stand.getWearPercentage();
                    updateElem(`card-wear-percent${i+1}`, safeFormat(wearPercent, 0) + '%');
                    
                    // Update wear progress bar
                    const wearBar = document.getElementById(`card-wear-bar${i+1}`);
                    if (wearBar) {
                        wearBar.style.width = safeFormat(wearPercent, 0) + '%';
                    }
                }
                
                // Update tension zones
                for (let i = 0; i < MILL_CONFIG.NUM_TENSION_ZONES; i++) {
                    const elem = document.getElementById(`tensionZone${i+1}`);
                    if (elem) {
                        const tension = this.mill.tensionZones[i].tension || MILL_CONFIG.NOMINAL_TENSION;
                        elem.textContent = safeFormat(tension, 1) + 'kN';  // Tension in kN
                    }
                }
            }
            
            updateLoadDistribution() {
                const container = document.getElementById('loadDistribution');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Get valid forces
                const forces = this.mill.stands.map(s => s.rollForce || 0);
                const maxForce = Math.max(...forces, 1); // Minimum 1 to avoid division by zero
                
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    const stand = this.mill.stands[i];
                    const force = stand.rollForce || 0;
                    const height = maxForce > 0 ? (force / maxForce) * 100 : 10;
                    
                    const bar = document.createElement('div');
                    bar.className = 'load-bar';
                    bar.style.height = Math.max(height, 10) + '%'; // Minimum 10% for visibility
                    bar.innerHTML = `
                        <div class="load-bar-value">${force.toFixed(0)}kN</div>
                        <div class="load-bar-label">Stand ${i+1}</div>
                    `;
                    container.appendChild(bar);
                }
            }
            
            reset() {
                this.mill.reset();
                this.time = 0;
                this.emergencyStop = false;
                
                for (let key in this.data) {
                    if (Array.isArray(this.data[key])) {
                        this.data[key].forEach(buf => buf.clear());
                    } else {
                        this.data[key].clear();
                    }
                }
                
                this.updateDisplays();
                updateAllCharts();
            }
        }
        
        // ============================================================================
        // GLOBAL VARIABLES
        // ============================================================================
        
        let simulationEngine = null;
        let charts = {};
        
        // Stand Cards Grid Initialization
        function initializeStandCardsGrid() {
            const container = document.getElementById('standCardsGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                const card = document.createElement('div');
                card.className = `stand-card stand-${i+1}`;
                card.innerHTML = `
                    <div class="stand-card-header">
                        Stand ${i+1}
                        <span style="font-size: 0.7rem; opacity: 0.7; margin-left: 8px;">
                            ‚öô AGC Active
                        </span>
                    </div>
                    
                    <!-- Primary Metrics -->
                    <div class="stand-card-metrics">
                        <div class="stand-card-metric">
                            <span style="color: var(--gray);">Entry h‚ÇÄ:</span>
                            <span id="card-entry-h${i+1}" style="font-weight: 700;">0.000 mm</span>
                        </div>
                        <div class="stand-card-metric">
                            <span style="color: var(--gray);">Exit h‚ÇÅ:</span>
                            <span id="card-exit-h${i+1}" style="font-weight: 700;">0.000 mm</span>
                        </div>
                        <div class="stand-card-metric">
                            <span style="color: var(--gray);">Reduction Œîh:</span>
                            <span id="card-reduction${i+1}" style="font-weight: 700;">0.0%</span>
                        </div>
                        <div class="stand-card-metric">
                            <span style="color: var(--gray);">Roll Force F:</span>
                            <span id="card-force${i+1}" style="font-weight: 700; color: var(--danger);">0 kN</span>
                        </div>
                        <div class="stand-card-metric">
                            <span style="color: var(--gray);">Speed v:</span>
                            <span id="card-speed${i+1}" style="font-weight: 700;">0 m/min</span>
                        </div>
                        <div class="stand-card-metric">
                            <span style="color: var(--gray);">Motor Power P:</span>
                            <span id="card-power${i+1}" style="font-weight: 700;">0.0 kW</span>
                        </div>
                    </div>
                    
                    <!-- Secondary Metrics -->
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                        <div class="stand-card-metric" style="margin-bottom: 4px;">
                            <span style="color: var(--gray); font-size: 0.8rem;">Gap S:</span>
                            <span id="card-gap${i+1}" style="font-weight: 600; font-size: 0.85rem;">0.000 mm</span>
                        </div>
                        <div class="stand-card-metric" style="margin-bottom: 4px;">
                            <span style="color: var(--gray); font-size: 0.8rem;">Mill Spring Œ¥:</span>
                            <span id="card-spring${i+1}" style="font-weight: 600; font-size: 0.85rem;">0.00 mm</span>
                        </div>
                        <div class="stand-card-metric" style="margin-bottom: 4px;">
                            <span style="color: var(--gray); font-size: 0.8rem;">Temperature T:</span>
                            <span id="card-temp${i+1}" style="font-weight: 600; font-size: 0.85rem;">25¬∞C</span>
                        </div>
                        <div class="stand-card-metric" style="margin-bottom: 4px;">
                            <span style="color: var(--gray); font-size: 0.8rem;">Thickness Error Œµ:</span>
                            <span id="card-error${i+1}" style="font-weight: 600; font-size: 0.85rem; color: var(--warning);">0 Œºm</span>
                        </div>
                        <div class="stand-card-metric" style="margin-bottom: 4px;">
                            <span style="color: var(--gray); font-size: 0.8rem;">Roll Shift ‚Üî:</span>
                            <span id="card-shift${i+1}" style="font-weight: 600; font-size: 0.85rem; color: var(--primary);">0.0 mm</span>
                        </div>
                    </div>
                    
                    <!-- Roll Wear Section -->
                    <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);">
                        <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 6px; display: flex; align-items: center;">
                            <span style="margin-right: 8px;">üîß Work Roll Status</span>
                            <span id="card-roll-tonnage${i+1}" style="font-weight: 600; color: var(--dark);">0 t</span>
                        </div>
                        <div style="margin-bottom: 6px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 2px;">
                                <span style="color: var(--gray);">Wear: <span id="card-roll-wear${i+1}" style="font-weight: 600;">0.00 mm</span></span>
                                <span style="color: var(--gray);">Diameter: <span id="card-roll-diameter${i+1}" style="font-weight: 600;">600 mm</span></span>
                            </div>
                            <div style="background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden;">
                                <div id="card-wear-bar${i+1}" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%); transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.65rem; color: var(--gray); margin-top: 2px; text-align: center;">
                                <span id="card-wear-percent${i+1}">0%</span> wear ‚Üí Roll change at 100%
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
        }
        
        // ============================================================================
        // CHART INITIALIZATION
        // ============================================================================
        
        function initCharts() {
            // Thickness evolution
            const thickCtx = document.getElementById('thicknessEvolutionChart').getContext('2d');
            charts.thicknessEvolution = new Chart(thickCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: Array(6).fill(null).map((_, i) => ({
                        label: `Stand ${i+1}`,
                        data: [],
                        borderColor: getStandColor(i),
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { title: { display: true, text: 'Time (s)' } },
                        y: { title: { display: true, text: 'Thickness (mm)' } }
                    },
                    plugins: { title: { display: true, text: 'Thickness Evolution Through Stands' } }
                }
            });
            
            // Speed profile
            const speedCtx = document.getElementById('speedProfileChart').getContext('2d');
            charts.speedProfile = new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: Array(6).fill(null).map((_, i) => ({
                        label: `Stand ${i+1}`,
                        data: [],
                        borderColor: getStandColor(i),
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { title: { display: true, text: 'Time (s)' } },
                        y: { title: { display: true, text: 'Speed (m/min)' } }
                    },
                    plugins: { title: { display: true, text: 'Speed Profile (Mass Flow Balance)' } }
                }
            });
            
            // Stand force
            initStandChart('standForceChart', 'Roll Force Distribution', 'Force (kN)');
            
            // Stand power
            initStandChart('standPowerChart', 'Motor Power Distribution', 'Power (kW)');
            
            // Stand reduction
            initStandChart('standReductionChart', 'Reduction Distribution', 'Reduction (mm)');
            
            // Stand gap
            initStandChart('standGapChart', 'Roll Gap Positions', 'Gap (mm)');
            
            // Tension time
            const tensionTimeCtx = document.getElementById('tensionTimeChart').getContext('2d');
            charts.tensionTime = new Chart(tensionTimeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: Array(5).fill(null).map((_, i) => ({
                        label: `Zone ${i+1}`,
                        data: [],
                        borderColor: getStandColor(i),
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { title: { display: true, text: 'Time (s)' } },
                        y: { title: { display: true, text: 'Tension (kN)' } }
                    },
                    plugins: { title: { display: true, text: 'Inter-Stand Tension vs Time' } }
                }
            });
            
            // Tension error (placeholder)
            const tensionErrCtx = document.getElementById('tensionErrorChart').getContext('2d');
            charts.tensionError = new Chart(tensionErrCtx, {
                type: 'bar',
                data: {
                    labels: ['Zone 1', 'Zone 2', 'Zone 3', 'Zone 4', 'Zone 5'],
                    datasets: [{
                        label: 'Tension Error',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(239, 68, 68, 0.5)',
                        borderColor: '#ef4444',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Error (kN)' } }
                    },
                    plugins: { title: { display: true, text: 'Tension Control Error' } }
                }
            });
            
            // Temperature
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            charts.temperature = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: ['Entry', 'Stand 1', 'Stand 2', 'Stand 3', 'Stand 4', 'Stand 5', 'Stand 6'],
                    datasets: [{
                        label: 'Temperature Profile',
                        data: [],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        borderWidth: 3,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Temperature (¬∞C)' } }
                    },
                    plugins: { title: { display: true, text: 'Temperature Evolution Through Mill' } }
                }
            });
            
            // Mass flow
            const massFlowCtx = document.getElementById('massFlowChart').getContext('2d');
            charts.massFlow = new Chart(massFlowCtx, {
                type: 'line',
                data: {
                    labels: ['Stand 1', 'Stand 2', 'Stand 3', 'Stand 4', 'Stand 5', 'Stand 6'],
                    datasets: [{
                        label: 'Mass Flow (h√óv)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 3,
                        pointRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Flow (mm¬∑m/min)' } }
                    },
                    plugins: { title: { display: true, text: 'Mass Flow Balance Verification' } }
                }
            });
            
            // Control effort
            const controlCtx = document.getElementById('controlEffortChart').getContext('2d');
            charts.controlEffort = new Chart(controlCtx, {
                type: 'bar',
                data: {
                    labels: ['Stand 1', 'Stand 2', 'Stand 3', 'Stand 4', 'Stand 5', 'Stand 6'],
                    datasets: [{
                        label: 'Control Effort',
                        data: [],
                        backgroundColor: 'rgba(124, 58, 237, 0.5)',
                        borderColor: '#7c3aed',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Effort (%)' } }
                    },
                    plugins: { title: { display: true, text: 'Control Effort Distribution' } }
                }
            });
            
            // Error distribution
            const errorCtx = document.getElementById('errorDistributionChart').getContext('2d');
            charts.errorDist = new Chart(errorCtx, {
                type: 'bar',
                data: {
                    labels: ['Stand 1', 'Stand 2', 'Stand 3', 'Stand 4', 'Stand 5', 'Stand 6'],
                    datasets: [{
                        label: 'Thickness Error (Œºm)',
                        data: [],
                        backgroundColor: 'rgba(239, 68, 68, 0.5)',
                        borderColor: '#ef4444',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Error (Œºm)' } }
                    },
                    plugins: { title: { display: true, text: 'Thickness Error by Stand' } }
                }
            });
            
            // ============================================================
            // PROFILE & SHAPE CONTROL CHARTS
            // ============================================================
            
            // Profile Chart (Thickness across width)
            const profileCtx = document.getElementById('profileChart');
            if (profileCtx) {
                charts.profile = new Chart(profileCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Measured Profile',
                            data: [],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Target (Flat)',
                            data: [],
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        scales: {
                            x: { title: { display: true, text: 'Position Across Width (mm)' } },
                            y: { title: { display: true, text: 'Thickness (mm)' } }
                        },
                        plugins: { 
                            title: { display: true, text: 'Thickness Profile Across Strip Width (Stand 6)' },
                            legend: { display: true, position: 'top' }
                        }
                    }
                });
            }
            
            // Stress Distribution Chart
            const stressCtx = document.getElementById('stressChart');
            if (stressCtx) {
                charts.stress = new Chart(stressCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Stress Distribution',
                            data: [],
                            borderColor: '#7c3aed',
                            backgroundColor: 'rgba(124, 58, 237, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        scales: {
                            x: { title: { display: true, text: 'Position Across Width (mm)' } },
                            y: { title: { display: true, text: 'Stress (MPa)' } }
                        },
                        plugins: { 
                            title: { display: true, text: 'Stress Distribution (Flatness Indicator)' },
                            legend: { display: true, position: 'top' }
                        }
                    }
                });
            }
            
            console.log('Profile & shape control charts initialized');
        }
        
        function initStandChart(canvasId, title, yLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Stand 1', 'Stand 2', 'Stand 3', 'Stand 4', 'Stand 5', 'Stand 6'],
                    datasets: [{
                        label: title,
                        data: [],
                        backgroundColor: Array(6).fill(null).map((_, i) => getStandColor(i, 0.5)),
                        borderColor: Array(6).fill(null).map((_, i) => getStandColor(i)),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: yLabel } }
                    },
                    plugins: { title: { display: true, text: title } }
                }
            });
        }
        
        function getStandColor(index, alpha = 1) {
            const colors = [
                '--stand-1', '--stand-2', '--stand-3', '--stand-4', '--stand-5', '--stand-6'
            ];
            const color = getComputedStyle(document.documentElement).getPropertyValue(colors[index]).trim();
            if (alpha < 1) {
                // Convert hex to rgba (simplified)
                return color + Math.floor(alpha * 255).toString(16);
            }
            return color;
        }
        
        // ============================================================================
        // CHART UPDATE FUNCTIONS
        // ============================================================================
        
        function updateAllCharts() {
            if (!simulationEngine || !simulationEngine.data || simulationEngine.data.time.length === 0) {
                return;
            }
            
            const data = simulationEngine.data;
            const timeArray = data.time.getArray();
            
            // Thickness evolution
            if (charts.thicknessEvolution) {
                charts.thicknessEvolution.data.labels = timeArray;
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    charts.thicknessEvolution.data.datasets[i].data = data.thicknessProfile[i].getArray();
                }
                charts.thicknessEvolution.update('none');
            }
            
            // Speed profile
            if (charts.speedProfile) {
                charts.speedProfile.data.labels = timeArray;
                for (let i = 0; i < MILL_CONFIG.NUM_STANDS; i++) {
                    charts.speedProfile.data.datasets[i].data = data.speedProfile[i].getArray();
                }
                charts.speedProfile.update('none');
            }
            
            // Stand charts (latest values)
            const latestForce = simulationEngine.mill.stands.map(s => s.rollForce);
            const latestPower = simulationEngine.mill.stands.map(s => s.motorPower);
            const latestReduction = simulationEngine.mill.stands.map(s => s.reduction);
            const latestGap = simulationEngine.mill.stands.map(s => s.gapPosition);
            
            if (charts.standForceChart) {
                charts.standForceChart.data.datasets[0].data = latestForce;
                charts.standForceChart.update('none');
            }
            
            if (charts.standPowerChart) {
                charts.standPowerChart.data.datasets[0].data = latestPower;
                charts.standPowerChart.update('none');
            }
            
            if (charts.standReductionChart) {
                charts.standReductionChart.data.datasets[0].data = latestReduction;
                charts.standReductionChart.update('none');
            }
            
            if (charts.standGapChart) {
                charts.standGapChart.data.datasets[0].data = latestGap;
                charts.standGapChart.update('none');
            }
            
            // Tension
            if (charts.tensionTime) {
                charts.tensionTime.data.labels = timeArray;
                for (let i = 0; i < MILL_CONFIG.NUM_TENSION_ZONES; i++) {
                    charts.tensionTime.data.datasets[i].data = data.tensionProfile[i].getArray();
                }
                charts.tensionTime.update('none');
            }
            
            // Tension Error - FIXED: Now updating!
            if (charts.tensionError) {
                const tensionErrorData = simulationEngine.mill.tensionZones.map(zone => {
                    const error = zone.tension - zone.tensionTarget;
                    return isNaN(error) ? 0 : error;
                });
                charts.tensionError.data.datasets[0].data = tensionErrorData;
                charts.tensionError.update('none');
            }
            
            // Temperature profile
            if (charts.temperature) {
                const tempData = [MILL_CONFIG.AMBIENT_TEMP].concat(
                    simulationEngine.mill.stands.map(s => s.temperature)
                );
                charts.temperature.data.datasets[0].data = tempData;
                charts.temperature.update('none');
            }
            
            // Mass flow
            if (charts.massFlow) {
                const massFlowData = simulationEngine.mill.stands.map(s => 
                    s.exitThickness * s.speed
                );
                charts.massFlow.data.datasets[0].data = massFlowData;
                
                // Update chart title with balance percentage
                const avgFlow = massFlowData.reduce((a, b) => a + b, 0) / massFlowData.length;
                const minFlow = Math.min(...massFlowData);
                const maxFlow = Math.max(...massFlowData);
                const balance = (minFlow / maxFlow) * 100;
                
                charts.massFlow.options.plugins.title.text = 
                    `Mass Flow Balance Verification (${balance.toFixed(1)}% balanced)`;
                
                charts.massFlow.update('none');
            }
            
            // Control effort (simplified)
            if (charts.controlEffort) {
                const effortData = simulationEngine.mill.stands.map(() => 
                    20 + Math.random() * 40
                );
                charts.controlEffort.data.datasets[0].data = effortData;
                charts.controlEffort.update('none');
            }
            
            // Error distribution
            if (charts.errorDist) {
                const errorData = simulationEngine.mill.stands.map((s, i) => {
                    // Calculate thickness error in micrometers
                    const error = Math.abs(s.exitThickness - s.thicknessTarget) * 1000;
                    return isNaN(error) ? 0 : error;
                });
                
                // Debug log occasionally
                if (Math.floor(simulationEngine.time) % 10 === 0 && Math.floor(simulationEngine.time - 0.02) % 10 !== 0) {
                    console.log('Thickness errors (Œºm):', errorData.map(e => e.toFixed(1)));
                }
                
                charts.errorDist.data.datasets[0].data = errorData;
                charts.errorDist.update('none');
            
            // ============================================================
            // PROFILE & SHAPE CONTROL CHART UPDATES
            // ============================================================
            
            // Update profile charts
            if (simulationEngine && simulationEngine.mill && simulationEngine.mill.stands[5]) {
                const stand6 = simulationEngine.mill.stands[5];
                
                if (stand6.profileShapeController) {
                    const status = stand6.profileShapeController.getStatus();
                    const measurement = stand6.profileShapeController.profileMeasurement;
                    
                    // Profile chart
                    if (charts.profile) {
                        charts.profile.data.labels = measurement.positions;
                        charts.profile.data.datasets[0].data = status.thicknessProfile;
                        charts.profile.data.datasets[1].data = new Array(measurement.numZones).fill(stand6.exitThickness);
                        charts.profile.update('none');
                    }
                    
                    // Stress chart
                    if (charts.stress) {
                        charts.stress.data.labels = measurement.positions;
                        charts.stress.data.datasets[0].data = status.stressProfile;
                        charts.stress.update('none');
                    }
                }
            }
            }
        }
        
        // ============================================================================
        // UI CONTROL FUNCTIONS
        // ============================================================================
        
        function updateSteelGrade() {
            const type = document.getElementById('steelType').value;
            const gradeSelect = document.getElementById('steelGrade');
            
            // Clear and repopulate grade options based on selected steel type
            gradeSelect.innerHTML = '';
            for (let grade in STEEL_GRADES[type]) {
                const option = document.createElement('option');
                option.value = grade;
                const gradeData = STEEL_GRADES[type][grade];
                // Show grade name with description
                option.textContent = gradeData.description ? 
                    `${grade} - ${gradeData.description}` : grade;
                gradeSelect.appendChild(option);
            }
            
            // Apply the first grade selection after populating
            applyGradeSelection();
        }
        
        function applyGradeSelection() {
            const type = document.getElementById('steelType').value;
            const gradeSelect = document.getElementById('steelGrade');
            const selectedGrade = gradeSelect.value;
            
            if (!selectedGrade) return;
            
            const gradeData = STEEL_GRADES[type][selectedGrade];
            simulationEngine.mill.currentGrade = gradeData;
            
            console.log('Steel grade set:', selectedGrade, gradeData);
            
            // Update the display in the Process Parameters section
            updateMaterialDisplay(type, selectedGrade, gradeData);
            
            // Update exit thickness target
            if (gradeData) {
                document.getElementById('exitThickness').value = gradeData.thickness;
                updateMillSchedule();
            }
        }
        
        function updateMaterialDisplay(type, grade, gradeData) {
            // Update material grade display
            const gradeDisplay = document.getElementById('currentMaterialGrade');
            if (gradeDisplay) {
                gradeDisplay.textContent = grade;
            }
            
            // Update material description
            const descDisplay = document.getElementById('materialDescription');
            if (descDisplay) {
                const typeLabel = type === 'ngo' ? 'Non-grain oriented' : 'Grain oriented';
                const description = gradeData.description || 'Electrical steel';
                descDisplay.textContent = `${description} (${typeLabel})`;
            }
        }
        
        function updateMillSchedule() {
            const entry = parseFloat(document.getElementById('entryThickness').value);
            const exit = parseFloat(document.getElementById('exitThickness').value);
            
            // Validate inputs
            if (!entry || !exit || entry <= exit) {
                console.error('Invalid thickness values:', entry, exit);
                return;
            }
            
            const totalReduction = (1 - exit / entry) * 100;
            const elongation = entry / exit;
            
            document.getElementById('totalReduction').value = totalReduction.toFixed(1) + '%';
            
            // Update the totalElongation display in Process Parameters section
            const elongationDisplay = document.getElementById('totalElongation');
            if (elongationDisplay) {
                elongationDisplay.textContent = elongation.toFixed(1) + 'x';
            }
            
            // Update the thickness range display
            const thicknessRangeDisplay = document.getElementById('thicknessRange');
            if (thicknessRangeDisplay) {
                thicknessRangeDisplay.textContent = `${entry.toFixed(2)} ‚Üí ${exit.toFixed(2)} mm`;
            }
            
            simulationEngine.mill.entryThickness = entry;
            simulationEngine.mill.exitThickness = exit;
            
            console.log('Computing schedule with entry:', entry, 'exit:', exit);
            simulationEngine.mill.computeSchedule();
            
            // Update displays immediately
            simulationEngine.updateDisplays();
            
            console.log('Schedule computed. Stand 1 force:', simulationEngine.mill.stands[0].rollForce);
        }
        
        function updateLoadDistribution() {
            const mode = document.getElementById('loadMode').value;
            simulationEngine.mill.loadSchedule = LOAD_SCHEDULES[mode];
            simulationEngine.mill.computeSchedule();
        }
        
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function startSimulation() {
            if (simulationEngine.emergencyStop) {
                alert('Emergency stop active. Clear it first.');
                return;
            }
            
            simulationEngine.isRunning = true;
            simulationEngine.speed = parseFloat(document.getElementById('simSpeed').value);
            document.getElementById('systemStatus').textContent = '6-Stand Mill Running';
            simulationEngine.run();
        }
        
        function pauseSimulation() {
            simulationEngine.isRunning = false;
            document.getElementById('systemStatus').textContent = 'System Paused';
        }
        
        function resetSimulation() {
            simulationEngine.reset();
            document.getElementById('systemStatus').textContent = 'System Reset - Ready';
        }
        
        function resetEmergencyStop() {
            simulationEngine.emergencyStop = false;
            document.getElementById('emergencyStop').classList.remove('active');
            document.getElementById('systemStatus').textContent = 'E-Stop Cleared - Ready';
        }
        
        function startThreading() {
            simulationEngine.mill.isThreading = true;
            simulationEngine.mill.threadingProgress = 0;
            
            // Reset all AGC controllers when threading starts
            // This prevents accumulated errors from previous runs
            simulationEngine.mill.stands.forEach(stand => {
                stand.controller.reset();
            });
            
            document.getElementById('threadingStatus').textContent = 'Threading initiated...';
            console.log('Threading started - AGC controllers reset');
            
            // Automatically start simulation if not already running
            if (!simulationEngine.isRunning) {
                startSimulation();
            }
        }
        
        function stopThreading() {
            simulationEngine.mill.isThreading = false;
            simulationEngine.mill.threadingProgress = 0;
            document.getElementById('threadingStatus').textContent = 'Threading stopped - Ready to thread';
        }
        
        function emergencyThreadingStop() {
            console.warn('‚ö†Ô∏è EMERGENCY THREADING STOP INITIATED');
            
            // Immediate state change
            simulationEngine.mill.isThreading = false;
            simulationEngine.mill.threadingProgress = 0;
            
            // STEP 1: Reduce speed to emergency creep (immediate)
            const emergencySpeed = MILL_CONFIG.THREADING_SPEED * 0.3;  // 30 m/min
            
            simulationEngine.mill.stands.forEach((stand, i) => {
                // Calculate speed ratio for mass flow balance
                if (i === 0) {
                    stand.speed = emergencySpeed;
                } else {
                    const speedRatio = simulationEngine.mill.stands[i-1].thicknessTarget / 
                                      stand.thicknessTarget;
                    stand.speed = simulationEngine.mill.stands[i-1].speed * speedRatio;
                }
            });
            
            // STEP 2: Open all gaps to maximum safe position
            simulationEngine.mill.stands.forEach(stand => {
                // Open to 2.5√ó nominal thickness (large opening)
                stand.gapPosition = stand.thicknessTarget * 2.5;
            });
            
            // STEP 3: Reduce all tensions to minimum
            simulationEngine.mill.tensionZones.forEach(zone => {
                zone.tensionTarget = MILL_CONFIG.MIN_TENSION;  // 20 kN
            });
            
            // STEP 4: Reduce cooling flow (optional - prevent thermal shock)
            simulationEngine.mill.coolingZones.forEach(zone => {
                zone.flowRate = 0.1;  // Minimal flow
            });
            
            // STEP 5: Update UI
            document.getElementById('threadingStatus').textContent = 
                '‚ö†Ô∏è EMERGENCY STOP - Threading aborted';
            document.getElementById('threadingStatus').style.color = 'var(--danger)';
            document.getElementById('threadingStatus').style.fontWeight = 'bold';
            
            // STEP 6: Log emergency stop event
            const timestamp = new Date().toISOString();
            console.log(`Emergency stop at ${timestamp}:`);
            console.log(`  Speed reduced to: ${emergencySpeed.toFixed(0)} m/min`);
            console.log(`  All gaps opened to 2.5√ó nominal`);
            console.log(`  Tensions reduced to minimum (${MILL_CONFIG.MIN_TENSION} kN)`);
            console.log(`  Threading progress was: ${(simulationEngine.mill.threadingProgress * 100).toFixed(1)}%`);
            
            // STEP 7: Show alert to user
            alert('‚ö†Ô∏è EMERGENCY THREADING STOP EXECUTED\n\n' +
                  '‚Ä¢ Mill speed reduced to creep (30 m/min)\n' +
                  '‚Ä¢ All gaps opened to maximum\n' +
                  '‚Ä¢ Tensions minimized to 20 kN\n' +
                  '‚Ä¢ Cooling reduced\n\n' +
                  'Check mill status before restarting.');
        }
        
        function changeAllRolls() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            // Change rolls on all stands
            simulationEngine.mill.stands.forEach((stand, i) => {
                stand.changeRolls();
            });
            
            // Update displays
            simulationEngine.updateDisplays();
            updateWearMonitoring();
            
            console.log('‚úì All work rolls changed - Roll wear reset to 0');
            alert('‚úì All work rolls changed successfully!\n\nRoll wear counters have been reset.');
        }
        
        function updateWearMonitoring() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            const safeFormat = (value, decimals = 0) => {
                if (value === null || value === undefined || isNaN(value)) return '0.00';
                return value.toFixed(decimals);
            };
            
            // Calculate totals
            let totalTonnage = 0;
            let totalWear = 0;
            let maxWear = 0;
            
            simulationEngine.mill.stands.forEach((stand, i) => {
                totalTonnage += stand.cumulativeTonnage;
                totalWear += stand.rollWear;
                maxWear = Math.max(maxWear, stand.rollWear);
                
                // Update quick view
                const wearPercent = stand.getWearPercentage();
                const quickElem = document.getElementById(`quickWear${i+1}`);
                if (quickElem) {
                    quickElem.textContent = `${safeFormat(stand.rollWear, 2)}mm (${safeFormat(wearPercent, 0)}%)`;
                    
                    // Color code based on wear level
                    if (wearPercent < 50) {
                        quickElem.style.color = 'var(--success)';
                    } else if (wearPercent < 80) {
                        quickElem.style.color = 'var(--warning)';
                    } else {
                        quickElem.style.color = 'var(--danger)';
                    }
                }
            });
            
            // Update summary displays
            const avgWear = totalWear / MILL_CONFIG.NUM_STANDS;
            
            const totalTonnageElem = document.getElementById('totalTonnageDisplay');
            if (totalTonnageElem) totalTonnageElem.textContent = safeFormat(totalTonnage, 0);
            
            const avgWearElem = document.getElementById('avgWearDisplay');
            if (avgWearElem) avgWearElem.textContent = safeFormat(avgWear, 2);
            
            const maxWearElem = document.getElementById('maxWearDisplay');
            if (maxWearElem) maxWearElem.textContent = safeFormat(maxWear, 2);
        }
        
        function updateThreadingProgressDisplay() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            const mill = simulationEngine.mill;
            
            if (mill.isThreading) {
                // Update progress bar
                const progressPercent = mill.threadingProgress * 100;
                const progressBar = document.getElementById('threadingProgressBar');
                const progressText = document.getElementById('threadingProgressText');
                
                if (progressBar) {
                    progressBar.style.width = progressPercent + '%';
                }
                
                if (progressText) {
                    progressText.textContent = `Threading: ${progressPercent.toFixed(0)}%`;
                }
                
                // Calculate engaged stands
                const standsEngaged = Math.min(6, Math.floor(mill.threadingProgress * 6) + 1);
                
                // Update stand indicators
                for (let i = 1; i <= 6; i++) {
                    const indicator = document.getElementById(`threadStand${i}`);
                    if (indicator) {
                        if (i < standsEngaged) {
                            indicator.className = 'thread-indicator engaged';
                        } else if (i === standsEngaged) {
                            indicator.className = 'thread-indicator active';
                        } else {
                            indicator.className = 'thread-indicator';
                        }
                    }
                }
            } else {
                // Reset display
                const progressBar = document.getElementById('threadingProgressBar');
                const progressText = document.getElementById('threadingProgressText');
                
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
                
                if (progressText) {
                    if (mill.threadingProgress === 1.0) {
                        progressText.textContent = 'Threading Complete ‚úì';
                    } else {
                        progressText.textContent = 'Ready to Thread';
                    }
                }
                
                // Reset stand indicators
                for (let i = 1; i <= 6; i++) {
                    const indicator = document.getElementById(`threadStand${i}`);
                    if (indicator) {
                        indicator.className = 'thread-indicator';
                    }
                }
            }
        }
        
        function applyDisturbance() {
            simulationEngine.mill.disturbances.hardness = 
                parseFloat(document.getElementById('hardnessVariation').value);
            simulationEngine.mill.disturbances.temperature = 
                parseFloat(document.getElementById('tempVariation').value);
            
            document.getElementById('hardnessValue').textContent = 
                simulationEngine.mill.disturbances.hardness + '%';
            document.getElementById('tempValue').textContent = 
                simulationEngine.mill.disturbances.temperature + '¬∞C';
        }
        
        function clearDisturbances() {
            document.getElementById('hardnessVariation').value = 0;
            document.getElementById('tempVariation').value = 0;
            applyDisturbance();
        }
        
        function updateCoolingMode() {
            const mode = document.getElementById('coolingMode').value;
            simulationEngine.mill.coolingMode = mode;
            
            const manualFlowControl = document.getElementById('manualCoolingFlow');
            manualFlowControl.disabled = (mode === 'auto');
            
            if (mode === 'manual') {
                document.getElementById('coolingStatus').textContent = '‚öôÔ∏è Manual Mode';
                document.getElementById('coolingStatus').style.color = 'var(--warning)';
                updateManualCoolingFlow();
            } else {
                document.getElementById('coolingStatus').textContent = '‚úì Cooling Active - Auto Mode';
                document.getElementById('coolingStatus').style.color = 'var(--success)';
            }
        }
        
        function updateManualCoolingFlow() {
            const flowPercent = parseFloat(document.getElementById('manualCoolingFlow').value);
            const flowRate = flowPercent / 100;
            
            // Set all cooling zones to manual flow rate
            simulationEngine.mill.coolingZones.forEach(zone => {
                zone.flowRate = flowRate;
            });
            
            document.getElementById('coolingFlowValue').textContent = flowPercent + '%';
        }
        
        function enableCooling() {
            simulationEngine.mill.coolingEnabled = true;
            simulationEngine.mill.coolingZones.forEach(zone => {
                zone.enabled = true;
            });
            
            const mode = simulationEngine.mill.coolingMode;
            if (mode === 'auto') {
                document.getElementById('coolingStatus').textContent = '‚úì Cooling Active - Auto Mode';
                document.getElementById('coolingStatus').style.color = 'var(--success)';
            } else {
                document.getElementById('coolingStatus').textContent = '‚öôÔ∏è Cooling Active - Manual Mode';
                document.getElementById('coolingStatus').style.color = 'var(--warning)';
            }
        }
        
        function disableCooling() {
            simulationEngine.mill.coolingEnabled = false;
            simulationEngine.mill.coolingZones.forEach(zone => {
                zone.enabled = false;
            });
            
            document.getElementById('coolingStatus').textContent = '‚úó Cooling Disabled';
            document.getElementById('coolingStatus').style.color = 'var(--danger)';
        }
        
        function updateTargetExitTemp() {
            const targetTemp = parseFloat(document.getElementById('targetExitTemp').value);
            simulationEngine.mill.targetExitTemp = targetTemp;
        }
        
        function exportData() {
            let csv = 'Time,';
            for (let i = 1; i <= 6; i++) {
                csv += `Stand${i}_Thickness,Stand${i}_Speed,Stand${i}_Force,Stand${i}_Power,Stand${i}_Temp,`;
            }
            for (let i = 1; i <= 5; i++) {
                csv += `Tension${i},`;
            }
            csv += 'TotalForce,TotalPower\n';
            
            const length = simulationEngine.data.time.length;
            for (let j = 0; j < length; j++) {
                csv += simulationEngine.data.time.getArray()[j].toFixed(3) + ',';
                for (let i = 0; i < 6; i++) {
                    csv += simulationEngine.data.thicknessProfile[i].getArray()[j].toFixed(4) + ',';
                    csv += simulationEngine.data.speedProfile[i].getArray()[j].toFixed(2) + ',';
                    csv += simulationEngine.data.forceProfile[i].getArray()[j].toFixed(2) + ',';
                    csv += simulationEngine.data.powerProfile[i].getArray()[j].toFixed(2) + ',';
                    csv += simulationEngine.data.temperatureProfile[i].getArray()[j].toFixed(1) + ',';
                }
                for (let i = 0; i < 5; i++) {
                    csv += simulationEngine.data.tensionProfile[i].getArray()[j].toFixed(2) + ',';
                }
                csv += simulationEngine.data.totalForce.getArray()[j].toFixed(2) + ',';
                csv += simulationEngine.data.totalPower.getArray()[j].toFixed(3) + '\n';
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '6stand_mill_data_' + Date.now() + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        
        // ============================================================================
        // PROFILE & SHAPE CONTROL FUNCTIONS
        // ============================================================================
        
        function applyProfileSettings() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            const mode = document.getElementById('profileMode').value;
            const crown = parseFloat(document.getElementById('crownTarget').value) / 1000; // Œºm to mm
            const flatness = parseFloat(document.getElementById('flatnessTarget').value);
            
            simulationEngine.mill.stands.forEach(stand => {
                stand.profileShapeController.targetCrown = crown;
                stand.profileShapeController.targetFlatness = flatness;
                
                if (mode === 'manual') {
                    stand.profileShapeController.autoMode = false;
                } else {
                    stand.profileShapeController.enableAutoControl();
                }
            });
            
            // Show/hide manual control based on mode
            const manualControl = document.getElementById('manualBendingControl');
            if (manualControl) {
                manualControl.style.display = (mode === 'manual') ? 'block' : 'none';
            }
            
            console.log(`Profile settings applied: Mode=${mode}, Crown=${crown*1000}Œºm, Flatness=${flatness}I-units`);
        }
        
        function enableProfileControl() {
            if (!simulationEngine || !simulationEngine.mill) return;
            simulationEngine.mill.stands.forEach(stand => {
                stand.profileShapeController.enabled = true;
            });
            console.log('Profile & Shape Control ENABLED');
        }
        
        function disableProfileControl() {
            if (!simulationEngine || !simulationEngine.mill) return;
            simulationEngine.mill.stands.forEach(stand => {
                stand.profileShapeController.enabled = false;
            });
            console.log('Profile & Shape Control DISABLED');
        }
        
        function updateProfileShapeDisplays() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            const stand6 = simulationEngine.mill.stands[5];
            if (!stand6 || !stand6.profileShapeController) return;
            
            const status = stand6.profileShapeController.getStatus();
            const crownMicrons = status.crown * 1000;
            
            const setTextIfExists = (id, text) => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = text;
            };
            
            // Update control card displays
            setTextIfExists('profileCrownValueCtrl', crownMicrons.toFixed(1));
            setTextIfExists('profileFlatnessValueCtrl', status.flatness.toFixed(1));
            setTextIfExists('profileQualityValueCtrl', status.shapeQuality);
            setTextIfExists('profileDefectValueCtrl', status.shapeDefect);
            setTextIfExists('profileBendingForceCtrl', status.bendingForce.toFixed(0));
            
            // Update performance card displays (original)
            setTextIfExists('profileCrownValue', crownMicrons.toFixed(1));
            setTextIfExists('profileFlatnessValue', status.flatness.toFixed(1));
            setTextIfExists('profileQualityValue', status.shapeQuality);
            setTextIfExists('profileDefectValue', status.shapeDefect);
            
            // Update all stand bending forces
            simulationEngine.mill.stands.forEach((stand, i) => {
                if (stand && stand.profileShapeController) {
                    const s = stand.profileShapeController.getStatus();
                    setTextIfExists(`bending${i+1}`, s.bendingForce.toFixed(0) + ' kN');
                }
            });
        }
        
        // Add to main display update
        const originalUpdateDisplays = SimulationEngine.prototype.updateDisplays || function() {};
        SimulationEngine.prototype.updateDisplays = function() {
            if (originalUpdateDisplays) originalUpdateDisplays.call(this);
            updateProfileShapeDisplays();
            updateRollShiftDisplays();
        };
        
        // ============================================================================
        // ROLL SHIFT CONTROL FUNCTIONS
        // ============================================================================
        
        function updateRollShiftMode() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            const mode = document.getElementById('rollShiftMode').value;
            const manualControls = document.getElementById('manualRollShiftControls');
            
            if (mode === 'manual') {
                // Enable manual control
                simulationEngine.mill.stands.forEach(stand => {
                    stand.profileShapeController.rollShifting.autoMode = false;
                });
                if (manualControls) {
                    manualControls.style.display = 'block';
                }
                console.log('Roll Shift: Manual mode enabled');
            } else {
                // Enable automatic coordinated control
                simulationEngine.mill.stands.forEach(stand => {
                    stand.profileShapeController.rollShifting.autoMode = true;
                });
                if (manualControls) {
                    manualControls.style.display = 'none';
                }
                console.log('Roll Shift: Automatic mode enabled');
            }
        }
        
        function updateManualShift(standNumber, value) {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            const shiftPosition = parseFloat(value);
            const stand = simulationEngine.mill.stands[standNumber - 1];
            
            if (stand && stand.profileShapeController) {
                stand.profileShapeController.setManualShift(shiftPosition);
                
                // Update display
                const valueElem = document.getElementById(`manualShift${standNumber}Value`);
                if (valueElem) {
                    valueElem.textContent = shiftPosition.toFixed(0);
                }
                
                console.log(`Stand ${standNumber} shift set to ${shiftPosition.toFixed(0)} mm`);
            }
        }
        
        function resetAllShifts() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            simulationEngine.mill.stands.forEach((stand, i) => {
                if (stand && stand.profileShapeController) {
                    stand.profileShapeController.setManualShift(0);
                    
                    // Reset sliders
                    const slider = document.getElementById(`manualShift${i+1}`);
                    const value = document.getElementById(`manualShift${i+1}Value`);
                    if (slider) slider.value = 0;
                    if (value) value.textContent = '0';
                }
            });
            
            console.log('All roll shifts reset to 0 mm');
        }
        
        function applySymmetricShift() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            // Apply a symmetric shifting pattern across the mill
            // Typical pattern: alternating or parabolic distribution
            const shiftPattern = [20, -15, 10, -10, 15, -20]; // mm
            
            simulationEngine.mill.stands.forEach((stand, i) => {
                if (stand && stand.profileShapeController) {
                    stand.profileShapeController.setManualShift(shiftPattern[i]);
                    
                    // Update sliders and displays
                    const slider = document.getElementById(`manualShift${i+1}`);
                    const value = document.getElementById(`manualShift${i+1}Value`);
                    if (slider) slider.value = shiftPattern[i];
                    if (value) value.textContent = shiftPattern[i].toFixed(0);
                }
            });
            
            console.log('Applied symmetric shift pattern:', shiftPattern);
        }
        
        function updateRollShiftDisplays() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            let totalShift = 0;
            let maxShift = 0;
            
            // Update shift position displays
            simulationEngine.mill.stands.forEach((stand, i) => {
                if (stand && stand.profileShapeController) {
                    const status = stand.profileShapeController.getStatus();
                    const shiftElem = document.getElementById(`shift${i+1}`);
                    
                    if (shiftElem) {
                        shiftElem.textContent = status.shiftPosition.toFixed(1);
                        
                        // Color code based on shift magnitude
                        const absShift = Math.abs(status.shiftPosition);
                        if (absShift < 20) {
                            shiftElem.style.color = 'var(--success)';
                        } else if (absShift < 50) {
                            shiftElem.style.color = 'var(--warning)';
                        } else {
                            shiftElem.style.color = 'var(--danger)';
                        }
                    }
                    
                    totalShift += Math.abs(status.shiftPosition);
                    maxShift = Math.max(maxShift, Math.abs(status.shiftPosition));
                }
            });
            
            // Update control details
            const avgShift = totalShift / MILL_CONFIG.NUM_STANDS;
            const mode = document.getElementById('rollShiftMode')?.value || 'auto';
            
            const setTextIfExists = (id, text) => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = text;
            };
            
            setTextIfExists('rollShiftModeDisp', mode === 'auto' ? 'Automatic' : 'Manual');
            setTextIfExists('rollShiftAvgDisp', avgShift.toFixed(1) + ' mm');
            setTextIfExists('rollShiftMaxDisp', maxShift.toFixed(1) + ' mm');
        }
        
        window.onload = function() {
            console.log('Initializing 6-Stand Cold Rolling Mill Simulation...');
            
            try {
                // Create simulation engine
                simulationEngine = new SimulationEngine();
                console.log('Simulation engine created');
                
                // Initialize charts
                if (typeof Chart !== 'undefined') {
                    initCharts();
                    console.log('Charts initialized');
                }
                
                // Initialize stand cards grid
                initializeStandCardsGrid();
                console.log('Stand cards grid initialized');
                
                // Set initial steel grade and compute schedule
                console.log('Setting initial steel grade...');
                updateSteelGrade();
                
                // Update mill schedule with initial values
                console.log('Computing initial mill schedule...');
                updateMillSchedule();
                
                // Force initial display update
                console.log('Updating initial displays...');
                simulationEngine.updateDisplays();
                
                // Update charts with initial data
                if (typeof Chart !== 'undefined') {
                    updateAllCharts();
                }
                
                console.log('6-Stand Mill System Initialized Successfully!');
                console.log('Entry thickness:', simulationEngine.mill.entryThickness);
                console.log('Exit thickness:', simulationEngine.mill.exitThickness);
                console.log('Total force:', simulationEngine.mill.getTotalForce());
                console.log('Total power:', simulationEngine.mill.getTotalPower());
                
                // Initialize Profile & Shape Control UI
                const manualBendingForce = document.getElementById('manualBendingForce');
                const manualBendingValue = document.getElementById('manualBendingValue');
                
                if (manualBendingForce && manualBendingValue) {
                    manualBendingForce.addEventListener('input', function() {
                        const force = parseFloat(this.value);
                        manualBendingValue.textContent = force;
                        
                        if (simulationEngine && simulationEngine.mill) {
                            simulationEngine.mill.stands[5].profileShapeController.setManualBending(force);
                        }
                    });
                }
                
                console.log('Profile & Shape Control UI initialized');
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('System initialization failed. Check console for details.');
            }
            
            // Update displays on input
            document.addEventListener('input', function(event) {
                if (event.target.id === 'simSpeed') {
                    document.getElementById('speedValue').textContent = event.target.value + 'x';
                } else if (event.target.id === 'entryThickness' || event.target.id === 'exitThickness') {
                    updateMillSchedule();
                } else if (event.target.id === 'masterSpeed') {
                    simulationEngine.mill.masterSpeed = parseFloat(event.target.value);
                    simulationEngine.mill.computeSchedule();
                    simulationEngine.updateDisplays();
                } else if (event.target.id === 'interStandTension') {
                    const tension = parseFloat(event.target.value);
                    simulationEngine.mill.tensionZones.forEach(z => z.tensionTarget = tension);
                } else if (event.target.id === 'imcLambda') {
                    const lambda = parseFloat(event.target.value);
                    simulationEngine.mill.stands.forEach(s => s.controller.lambda = lambda);
                    simulationEngine.mill.tensionZones.forEach(z => z.controller.lambda = lambda * 0.6);
                } else if (event.target.id === 'targetExitTemp') {
                    updateTargetExitTemp();
                } else if (event.target.id === 'manualCoolingFlow') {
                    updateManualCoolingFlow();
                }
            });
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ENHANCEMENT MODULES - OPTIONAL ADVANCED FEATURES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // 1. ENHANCED ROLL BITE MODEL (OROWAN-BASED)
        class EnhancedRollBite {
            constructor() {
                this.enabled = true;  // Always enabled - advanced physics
            }
            
            calculateOrowan(h0, h1, width, rollDiameter, yieldStrength, temperature, 
                            backTension = 0, frontTension = 0) {
                const R = rollDiameter / 2;
                const reduction = h0 - h1;
                const strain = Math.log(h0 / h1);
                
                // Work hardening: œÉ = K¬∑Œµ^n¬∑(1 - Œ±¬∑ŒîT)
                const n = 0.24;  
                const K = yieldStrength * 1.3;
                const alpha_temp = 0.004;
                const tempFactor = 1 - alpha_temp * (temperature - 25);
                const flowStress = K * Math.pow(strain + 0.002, n) * tempFactor;
                
                // Roll flattening (Hitchcock): R' = R(1 + C¬∑P/W)
                const C = 2.16e-6;
                const P_est = flowStress * width * Math.sqrt(R * reduction);
                const R_flat = R * (1 + C * P_est / width);
                
                // Contact geometry
                const Ld = Math.sqrt(R_flat * reduction);
                const alpha = Ld / R_flat;
                
                // Friction (temperature dependent)
                const mu = Math.max(0.02, Math.min(0.15, 0.05 + 0.0002 * (temperature - 25)));
                
                // Tension effects on neutral point
                const sigmaBT = backTension / (h0 * width);
                const sigmaFT = frontTension / (h1 * width);
                const H = (sigmaBT - sigmaFT) / flowStress;
                const phi_n = alpha * (0.5 + 0.125 * H);
                
                // Roll pressure at neutral point
                const p_max = flowStress * (1 + mu * (alpha - phi_n));
                
                // Rolling force with tension correction
                const avgPressure = p_max * 0.65;
                const force = avgPressure * Ld * width - 0.3 * (backTension - frontTension);
                
                // Redundant work factor
                const r = reduction / h0;
                const phi_red = 0.8 + 0.5 * r + 0.3 * mu;
                const specificWork = flowStress * strain * (1 + phi_red);
                
                // Forward slip with tension effects
                const forwardSlip = (1 - h1/h0) * (1 + mu * alpha / (2 * (1 - r))) + H * 0.1;
                
                return {
                    force: Math.max(0, force),
                    flowStress: flowStress,
                    contactLength: Ld,
                    forwardSlip: forwardSlip,
                    specificWork: specificWork,
                    friction: mu
                };
            }
        }
        
        // 2. THERMAL ENHANCEMENT MODULE
        class ThermalEnhancement {
            constructor() {
                this.enabled = true;  // Always enabled - advanced physics
                this.enableRadiation = true;  // Always enabled
                this.enableRollTemp = true;  // Always enabled
                this.rollTemps = new Array(6).fill(50);
                this.emissivity = 0.8;
                this.stefanBoltzmann = 5.67e-8;  // W/(m¬≤¬∑K‚Å¥)
            }
            
            calculateRadiation(stripTemp, ambientTemp, area) {
                if (!this.enableRadiation) return 0;
                
                const T_strip_K = stripTemp + 273.15;
                const T_amb_K = ambientTemp + 273.15;
                
                return this.emissivity * this.stefanBoltzmann * area *
                       (Math.pow(T_strip_K, 4) - Math.pow(T_amb_K, 4));
            }
            
            updateRollTemperature(standIndex, stripTemp, heatFromStrip, dt) {
                if (!this.enableRollTemp) return 50;
                
                const m_roll = 2000;  // kg
                const cp_roll = 460;   // J/(kg¬∑K)
                const emulsionCooling = 50000 * (this.rollTemps[standIndex] - 50);  // W
                
                const dT = (heatFromStrip - emulsionCooling) / (m_roll * cp_roll);
                this.rollTemps[standIndex] += dT * dt;
                this.rollTemps[standIndex] = Math.max(40, Math.min(100, this.rollTemps[standIndex]));
                
                return this.rollTemps[standIndex];
            }
            
            calculateThermalCrown(rollTemp, ambientTemp = 50) {
                const deltaT = rollTemp - ambientTemp;
                const alpha_thermal = 11e-6;  // 1/K
                const R = 300;  // mm
                
                // Crown at center (parabolic distribution)
                return alpha_thermal * R * deltaT * 1000;  // Œºm
            }
        }
        
        // 3. ADAPTIVE CONTROL MODULE
        class AdaptiveControl {
            constructor() {
                this.enabled = true;  // Always enabled - advanced physics
                this.errorHistory = [];
                this.maxHistory = 50;
                this.lambda = 0.7;
                this.Kp = 0.3;
                this.Ki = 0.05;
            }
            
            adaptGains() {
                if (this.errorHistory.length < 20) return;
                
                const recent = this.errorHistory.slice(-20);
                const mean = recent.reduce((a,b) => a + Math.abs(b), 0) / recent.length;
                const variance = recent.reduce((a,b) => a + Math.pow(Math.abs(b) - mean, 2), 0) / recent.length;
                const stdDev = Math.sqrt(variance);
                
                // Adapt lambda (feed-forward)
                if (mean > 0.01) {
                    this.lambda = Math.min(0.9, this.lambda + 0.01);
                } else if (stdDev < 0.005) {
                    this.lambda = Math.max(0.5, this.lambda - 0.005);
                }
                
                // Adapt Kp (proportional)
                if (stdDev > 0.01) {
                    this.Kp = Math.max(0.2, this.Kp - 0.01);
                }
                
                // Adapt Ki (integral)
                if (mean > 0.005) {
                    this.Ki = Math.min(0.1, this.Ki + 0.002);
                }
            }
            
            recordError(error) {
                this.errorHistory.push(error);
                if (this.errorHistory.length > this.maxHistory) {
                    this.errorHistory.shift();
                }
                
                if (this.enabled) {
                    this.adaptGains();
                }
            }
            
            getGains() {
                return {
                    lambda: this.lambda,
                    Kp: this.Kp,
                    Ki: this.Ki
                };
            }
        }
        
        // 4. ENHANCED PROFILE CONTROL
        class ProfileEnhancement {
            constructor() {
                this.enabled = true;  // Always enabled - advanced physics
                this.rollWear = new Array(6).fill(0);  // Œºm
                this.wearRate = 0.001;  // Œºm per ton
                this.rolledTonnage = new Array(6).fill(0);
                this.enableEdgeDrop = true;  // Always enabled
                this.edgeDropCoeff = 15;  // Œºm
                this.enableFlatnessDetection = true;  // Always enabled
            }
            
            updateWear(standIndex, width, thickness, speed, dt) {
                if (!this.enabled) return 0;
                
                const density = 7800;  // kg/m¬≥
                const tonnageRate = speed * width * thickness * density * 60 / 1e9;  // ton/hour
                
                this.rolledTonnage[standIndex] += tonnageRate * dt / 3600;
                this.rollWear[standIndex] = this.rolledTonnage[standIndex] * this.wearRate;
                
                return this.rollWear[standIndex];
            }
            
            calculateEdgeDrop(width) {
                if (!this.enableEdgeDrop) return 0;
                return this.edgeDropCoeff * Math.sqrt(width / 1000);
            }
            
            calculateCrown(thermalCrown, elasticDeflection, wear, bendingEffect) {
                const components = {
                    thermal: thermalCrown || 0,
                    elastic: elasticDeflection || 0,
                    wear: wear * 0.7 || 0,  // 70% at center
                    bending: bendingEffect || 0
                };
                
                components.total = components.thermal + components.elastic + 
                                  components.wear + components.bending;
                
                return components;
            }
            
            computeFlatnessProfile(crown, edgeDrop, thickness) {
                const profile = [];
                for (let i = 0; i < 21; i++) {
                    const x = (i - 10) / 10;  // -1 to 1
                    
                    // Crown contribution (parabolic)
                    const crownContrib = crown * (1 - x * x);
                    
                    // Edge drop
                    let edgeDropContrib = 0;
                    if (Math.abs(x) > 0.7) {
                        edgeDropContrib = edgeDrop * Math.pow((Math.abs(x) - 0.7) / 0.3, 2);
                    }
                    
                    const thicknessDeviation = crownContrib - edgeDropContrib;
                    const strain = thicknessDeviation / (thickness * 1000);
                    const iUnit = strain * 1e5;
                    
                    profile.push(iUnit);
                }
                
                return profile;
            }
            
            detectDefects(flatnessProfile, threshold = 10) {
                if (!this.enableFlatnessDetection) return null;
                
                const center = flatnessProfile[10];
                const edges = (flatnessProfile[0] + flatnessProfile[20]) / 2;
                const quarters = (flatnessProfile[5] + flatnessProfile[15]) / 2;
                
                if (center > threshold) {
                    return {
                        type: 'Center Buckle',
                        severity: center.toFixed(1),
                        location: 'Center',
                        action: 'Increase bending force'
                    };
                }
                
                if (edges > threshold && edges > center + 5) {
                    return {
                        type: 'Edge Wave',
                        severity: edges.toFixed(1),
                        location: 'Edges',
                        action: 'Decrease bending force'
                    };
                }
                
                if (quarters > threshold && quarters > center + 3) {
                    return {
                        type: 'Quarter Buckle',
                        severity: quarters.toFixed(1),
                        location: 'Quarter points',
                        action: 'Adjust roll shifting'
                    };
                }
                
                return null;
            }
        }
        
        // Initialize enhancement objects globally
        window.enhancedRollBite = new EnhancedRollBite();
        window.thermalEnhancement = new ThermalEnhancement();
        window.adaptiveControl = new AdaptiveControl();
        window.profileEnhancement = new ProfileEnhancement();
        
        console.log('‚úì Advanced physics modules initialized (all enabled by default)');
        
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ADAPTIVE GAINS DISPLAY UPDATER (Always Enabled)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Update adaptive gains display periodically (always enabled now)
        let adaptiveControlInterval = setInterval(() => {
            if (window.adaptiveControl && window.adaptiveControl.enabled) {
                const gains = window.adaptiveControl.getGains();
                const lambdaElem = document.getElementById('currentLambda');
                const kpElem = document.getElementById('currentKp');
                const kiElem = document.getElementById('currentKi');
                
                if (lambdaElem) lambdaElem.textContent = gains.lambda.toFixed(2);
                if (kpElem) kpElem.textContent = gains.Kp.toFixed(2);
                if (kiElem) kiElem.textContent = gains.Ki.toFixed(3);
            }
        }, 500);
        

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ENHANCED DISPLAY UPDATE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateEnhancedDisplays() {
            if (!simulationEngine || !simulationEngine.mill) return;
            
            updateThermalDisplays();
            updateMassFlowDisplays();
            updateTensionDisplays();
        }
        
        function updateThermalDisplays() {
            const mill = simulationEngine.mill;
            
            // Heat sources
            let totalDeformation = 0, totalFriction = 0;
            mill.stands.forEach(stand => {
                const power = stand.motorPower || 0;
                totalDeformation += power * 0.95;
                totalFriction += power * 0.05;
            });
            
            setTextIfExists('heatDeformation', totalDeformation.toFixed(0));
            setTextIfExists('heatFriction', totalFriction.toFixed(0));
            setTextIfExists('heatTotal', (totalDeformation + totalFriction).toFixed(0));
            
            // Roll temperatures (use enhancement module if enabled)
            for (let i = 0; i < 6; i++) {
                const rollTemp = window.thermalEnhancement.enableRollTemp ? 
                    window.thermalEnhancement.rollTemps[i] : 50;
                setTextIfExists(`rollTemp${i+1}`, rollTemp.toFixed(1));
            }
            
            // Strip temperatures
            for (let i = 0; i < 6; i++) {
                const stripTemp = mill.stands[i].temperature || 25;
                setTextIfExists(`stripTemp${i+1}`, stripTemp.toFixed(1));
            }
            
            // Cooling system - display flow rates in L/min (0-100 scale)
            for (let i = 0; i < 5; i++) {
                const zone = mill.coolingZones[i + 1]; // Inter-stand zones are 1-5
                const flowRate = zone ? zone.flowRate * 100 : 0; // Convert 0-1 to 0-100 L/min
                setTextIfExists(`coolingFlow${i+1}`, flowRate.toFixed(0));
            }
            
            setTextIfExists('coolantTemp', MILL_CONFIG.COOLANT_TEMP);
            
            // Cooling power calculation - sum all inter-stand cooling zones
            let coolingPower = 0;
            for (let i = 1; i <= 5; i++) { // Inter-stand zones 1-5
                const zone = mill.coolingZones[i];
                if (zone && zone.flowRate > 0.01) {
                    // Heat transfer coefficient based on flow rate
                    const h_cool = 2000 * Math.sqrt(zone.flowRate); // W/(m¬≤¬∑K)
                    const A = MILL_CONFIG.STRIP_WIDTH * 0.2; // m¬≤ (200mm spray zone length)
                    
                    // Use temperature at the stand before this cooling zone
                    const standIndex = i - 1; // Zone 1 is after stand 0
                    const stripTemp = standIndex >= 0 && standIndex < 6 ? 
                        mill.stands[standIndex].temperature : MILL_CONFIG.AMBIENT_TEMP;
                    const deltaT = Math.max(0, stripTemp - MILL_CONFIG.COOLANT_TEMP);
                    
                    // Cooling power for this zone
                    const zonePower = h_cool * A * deltaT / 1000; // kW
                    coolingPower += zonePower;
                }
            }
            setTextIfExists('coolingPower', coolingPower.toFixed(0));
            setTextIfExists('heatRemoved', coolingPower.toFixed(0));
            
            // Heat loss mechanisms
            if (window.thermalEnhancement.enableRadiation) {
                let totalRad = 0;
                mill.stands.forEach(stand => {
                    const A = MILL_CONFIG.STRIP_WIDTH * 100 / 1e6;
                    const rad = window.thermalEnhancement.calculateRadiation(
                        stand.temperature, MILL_CONFIG.AMBIENT_TEMP, A
                    ) / 1000;
                    totalRad += rad;
                });
                // Use more precision for small values
                const radDisplay = totalRad < 1 ? totalRad.toFixed(2) : totalRad.toFixed(1);
                setTextIfExists('radiationLoss', radDisplay);
            } else {
                setTextIfExists('radiationLoss', '0.0');
            }
            
            setTextIfExists('rollConduction', (coolingPower * 0.6).toFixed(1));
            setTextIfExists('convectionLoss', (coolingPower * 0.4).toFixed(1));
        }
        
        function updateMassFlowDisplays() {
            const mill = simulationEngine.mill;
            
            // Stand speeds
            for (let i = 0; i < 6; i++) {
                const speed = mill.stands[i].speed || 0;
                setTextIfExists(`standSpeed${i+1}`, speed.toFixed(0));
            }
            
            // Forward slip (use enhancement if enabled)
            for (let i = 0; i < 6; i++) {
                let slip = 2.0; // Default
                if (window.enhancedRollBite.enabled && mill.stands[i].rollBiteResults) {
                    slip = (mill.stands[i].rollBiteResults.forwardSlip || 0) * 100;
                }
                setTextIfExists(`forwardSlip${i+1}`, slip.toFixed(1));
            }
            
            // Speed ratios
            for (let i = 0; i < 5; i++) {
                const ratio = mill.stands[i+1].speed / mill.stands[i].speed;
                setTextIfExists(`speedRatio${i+1}`, ratio.toFixed(3));
            }
            
            // Volume flow rates (h √ó v √ó w)
            for (let i = 0; i < 6; i++) {
                const h = mill.stands[i].exitThickness; // mm
                const v = mill.stands[i].speed * 1000 / 60; // mm/s
                const w = MILL_CONFIG.STRIP_WIDTH; // mm
                const Q = h * v * w; // mm¬≥/s
                setTextIfExists(`volumeFlow${i+1}`, (Q / 1000).toFixed(0));
            }
        }
        
        function updateTensionDisplays() {
            const mill = simulationEngine.mill;
            
            // Back and forward tensions for each stand
            for (let i = 0; i < 6; i++) {
                // Back tension (from previous zone or uncoiler)
                let backT;
                if (i === 0) {
                    // Stand 1: back tension from uncoiler
                    backT = mill.entryTension || MILL_CONFIG.ENTRY_TENSION;
                } else {
                    // Stands 2-6: back tension from previous inter-stand zone
                    backT = mill.tensionZones[i-1].tension || 0;
                }
                setTextIfExists(`backTension${i+1}`, backT.toFixed(1));
                
                // Forward tension (to next zone or coiler)
                let fwdT;
                if (i === 5) {
                    // Stand 6: forward tension to coiler
                    fwdT = mill.exitTension || MILL_CONFIG.EXIT_TENSION;
                } else {
                    // Stands 1-5: forward tension to next inter-stand zone
                    fwdT = mill.tensionZones[i].tension || 0;
                }
                setTextIfExists(`forwardTension${i+1}`, fwdT.toFixed(1));
            }
            
            // Zone tensions and errors
            for (let i = 0; i < 5; i++) {
                const zone = mill.tensionZones[i];
                const tension = zone.tension || 0;
                const target = zone.tensionTarget || 50;
                const error = tension - target;
                
                setTextIfExists(`zoneT${i+1}`, tension.toFixed(1));
                setTextIfExists(`zoneErr${i+1}`, error.toFixed(1));
            }
            
            // Tension stress analysis
            let avgStress = 0;
            let maxTension = 0;
            let maxZone = 1;
            
            for (let i = 0; i < 5; i++) {
                const T = mill.tensionZones[i].tension || 0;
                const h = mill.stands[i].exitThickness;
                const w = MILL_CONFIG.STRIP_WIDTH;
                const stress = T * 1000 / (h * w); // MPa
                avgStress += stress;
                
                if (T > maxTension) {
                    maxTension = T;
                    maxZone = i + 1;
                }
            }
            avgStress /= 5;
            
            setTextIfExists('avgTensionStress', avgStress.toFixed(1));
            
            // % of yield strength
            const yieldStrength = mill.stands[0].steelGrade?.yield || 400;
            const yieldRatio = (avgStress / yieldStrength * 100);
            setTextIfExists('tensionYieldRatio', yieldRatio.toFixed(1));
            
            setTextIfExists('maxTensionValue', maxTension.toFixed(1));
            setTextIfExists('maxTensionZone', maxZone);
        }
        
        function setTextIfExists(id, text) {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = text;
        }
        
    </script>
</body>
</html>
